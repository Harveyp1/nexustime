<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NexusTime - Developer Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #111827; color: #E5E7EB; }
        .card { background-color: #1F2937; border: 1px solid #374151; }
        .cta-button { transition: all 0.3s ease; background-color: #34D399; color: #111827; font-weight: 600; padding: 0.75rem 1.5rem; border-radius: 0.5rem; }
        .cta-button:hover { background-color: #2dd4bf; }
        .cta-button:disabled { background-color: #374151; color: #9CA3AF; cursor: not-allowed; }
        .danger-button { background-color: #EF4444; color: white; transition: all 0.3s ease; font-weight: 600; padding: 0.75rem 1.5rem; border-radius: 0.5rem; }
        .danger-button:hover { background-color: #DC2626; }
        .secondary-button { background-color: transparent; border: 1px solid #4B5563; color: #9CA3AF; transition: all 0.3s ease; font-weight: 600; padding: 0.75rem 1.5rem; border-radius: 0.5rem; }
        .secondary-button:hover { background-color: #374151; color: #E5E7EB; border-color: #6B7280; }
        .dev-page { display: none; }
        .dev-page.active { display: block; }
        .form-input, .form-select { background-color: #1F2937; border: 1px solid #374151; color: #E5E7EB; border-radius: 0.5rem; padding: 0.75rem 1rem; }
        .form-input:focus, .form-select:focus { outline: none; border-color: #34D399; box-shadow: 0 0 0 2px rgba(52, 211, 153, 0.5); }
        .nav-link { display: flex; align-items: center; padding: 0.75rem 1rem; border-radius: 0.5rem; transition: all 0.2s; border-left: 3px solid transparent; cursor: pointer; }
        .nav-link:hover { background-color: #374151; }
        .nav-link.active { background-color: #1F2937; color: #34D399; border-left-color: #34D399; font-weight: 600; }
        .nav-link svg { margin-right: 1rem; }
        .loader { border: 4px solid #374151; border-top: 4px solid #34D399; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 2rem auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .toast { position: fixed; bottom: 20px; right: 20px; background-color: #1F2937; color: white; padding: 1rem 1.5rem; border-radius: 0.5rem; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); z-index: 1000; opacity: 0; transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out; border-left: 4px solid; transform: translateY(20px); }
        .toast.show { opacity: 1; transform: translateY(0); }
        .toast.success { border-color: #34D399; }
        .toast.error { border-color: #F87171; }
        pre { background-color: #0d1117; padding: 1rem; border-radius: 0.5rem; overflow-x: auto; font-family: 'Courier New', Courier, monospace; }
        .list-item { cursor: pointer; transition: background-color 0.2s; }
        .list-item:hover, .list-item.selected { background-color: #374151; }
        .modal-overlay { position: fixed; inset: 0; display: flex; align-items: center; justify-content: center; background-color: rgba(17, 24, 39, 0.8); backdrop-filter: blur(4px); z-index: 500; }
    </style>
</head>
<body class="bg-gray-900 text-white">
    <div id="dev-portal-container" class="hidden">
        <div class="flex h-screen">
            <!-- Sidebar -->
            <aside class="w-64 bg-gray-900 border-r border-gray-800 p-4 flex flex-col">
                <div class="flex items-center mb-8">
                    <img src="https://raw.githubusercontent.com/Harveyp1/nexustime/main/nexustimelogo.png" alt="NexusTime Logo" class="h-10" onerror="this.onerror=null; this.src='https://placehold.co/160x40/111827/34D399?text=NexusTime';">
                    <span class="ml-2 font-bold text-lg text-red-500">DEV</span>
                </div>
                <nav id="dev-nav" class="flex flex-col space-y-2">
                    <a data-page="dashboard" class="nav-link active"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 8v8m-4-5v5m-4-2v2m-2 4h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>Dashboard</a>
                    <a data-page="financials" class="nav-link"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6"></path></svg>Financials</a>
                    <a data-page="customers" class="nav-link"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M15 21a6 6 0 00-9-5.197M15 11a4 4 0 110-8 4 4 0 010 8z"></path></svg>Customer Mgt.</a>
                    <a data-page="users" class="nav-link"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>User Mgt.</a>
                    <a data-page="workspaces" class="nav-link"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path></svg>Workspace Mgt.</a>
                    <a data-page="coupons" class="nav-link"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 110 4v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 110-4V7a2 2 0 00-2-2H5z"></path></svg>Coupons</a>
                    <a data-page="payments" class="nav-link"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path></svg>Payments</a>
                    <a data-page="explorer" class="nav-link"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 21h7a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v11m0 5l4.879-4.879m0 0a3 3 0 104.243-4.242 3 3 0 00-4.243 4.242z"></path></svg>Data Explorer</a>
                </nav>
                <div class="mt-auto">
                    <button id="dev-logout-button" class="w-full secondary-button text-sm">Log Out</button>
                </div>
            </aside>
            <!-- Main Content -->
            <main class="flex-1 p-8 overflow-y-auto">
                <div id="dev-dashboard" class="dev-page active"></div>
                <div id="dev-financials" class="dev-page"></div>
                <div id="dev-users" class="dev-page"></div>
                <div id="dev-customers" class="dev-page"></div>
                <div id="dev-workspaces" class="dev-page"></div>
                <div id="dev-coupons" class="dev-page"></div>
                <div id="dev-payments" class="dev-page"></div>
                <div id="dev-explorer" class="dev-page"></div>
            </main>
        </div>
    </div>
    <div id="auth-container"></div>
    <div id="toast-container"></div>
    <!-- Modals -->
    <div id="edit-modal" class="hidden modal-overlay" role="dialog" aria-modal="true">
        <div id="edit-modal-content" class="card rounded-lg shadow-xl m-8 max-w-2xl w-full max-h-[90vh] flex flex-col"></div>
    </div>
    <div id="confirmation-modal" class="hidden modal-overlay" role="dialog" aria-modal="true">
        <div class="card rounded-lg shadow-xl m-8 max-w-md w-full">
             <div class="p-6 text-center">
                <svg class="w-16 h-16 mx-auto text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                <h3 id="confirmation-modal-title" class="text-xl font-semibold text-white mt-4 mb-2">Are you sure?</h3>
                <p id="confirmation-modal-message" class="text-gray-400 mb-6"></p>
                <div class="flex justify-center gap-4">
                    <button id="confirmation-cancel-btn" class="secondary-button">Cancel</button>
                    <button id="confirmation-confirm-btn" class="danger-button">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, query, getDocs, setDoc, addDoc, updateDoc, deleteDoc, writeBatch, Timestamp, where } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- SECURITY: SUPER ADMIN UID ---
        const SUPER_ADMIN_UID = "JzCSorMPyVUR906kHTlDfhOa1Xg2";

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCKy_SqRUTKkoeuTzrksN2_TQ41v8Zs9Ls",
            authDomain: "nexustime-e8b91.firebaseapp.com",
            projectId: "nexustime-e8b91",
            storageBucket: "nexustime-e8b91.appspot.com",
            messagingSenderId: "516976739338",
            appId: "1:516976739338:web:537ae732707a2a1aab4bf3",
            measurementId: "G-QRSD6TYH86"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Global State
        let allUsers = [];
        let allWorkspaces = [];
        let allCoupons = [];
        let financialData = { mrr: 0, churn: 0, subscriptions: 0, transactions: [] };
        let charts = {}; // Store all chart instances
        let selectedItemId = null; 
        let userFilters = {};
        let customerFilters = {};
        let workspaceFilters = {};
        
        // DOM Elements
        const authContainer = document.getElementById('auth-container');
        const devPortalContainer = document.getElementById('dev-portal-container');
        const devNav = document.getElementById('dev-nav');
        const devPages = document.querySelectorAll('.dev-page');
        const devLogoutButton = document.getElementById('dev-logout-button');
        const toastContainer = document.getElementById('toast-container');
        
        // --- Core Portal Logic ---
        
        onAuthStateChanged(auth, async (user) => {
            if (user && user.uid === SUPER_ADMIN_UID) {
                authContainer.innerHTML = '';
                devPortalContainer.classList.remove('hidden');
                await loadAllData();
                handleDevRouting();
            } else {
                devPortalContainer.classList.add('hidden');
                renderLoginForm();
                if (user) {
                    authContainer.insertAdjacentHTML('afterbegin', `<div class="p-8 text-center text-red-400"><h1 class="text-2xl font-bold">Access Denied</h1><p>You are not authorized to view this page.</p><p class="mt-4"><a href="app.html" class="text-emerald-400 underline">Go to App</a></p></div>`);
                }
            }
        });

        function handleDevRouting() {
            const hash = window.location.hash.substring(1) || 'dashboard';
            showDevPage(hash);
        }
        
        window.addEventListener('hashchange', handleDevRouting);
        devNav.addEventListener('click', (e) => {
            const link = e.target.closest('.nav-link');
            if (link && link.dataset.page) {
                e.preventDefault();
                window.location.hash = link.dataset.page;
            }
        });

        const showDevPage = async (pageId) => {
            selectedItemId = null; // Reset selection when changing pages
            devPages.forEach(page => page.classList.remove('active'));
            const targetPage = document.getElementById(`dev-${pageId}`);
            if (targetPage) {
                targetPage.classList.add('active');
            } else {
                document.getElementById('dev-dashboard').classList.add('active');
                pageId = 'dashboard';
            }

            devNav.querySelectorAll('.nav-link').forEach(link => {
                link.classList.toggle('active', link.dataset.page === pageId);
            });
            
            const renderMap = {
                dashboard: renderDevDashboard,
                financials: renderFinancialsDashboard,
                users: renderUserManagement,
                customers: renderCustomerManagement,
                workspaces: renderWorkspaceManagement,
                coupons: renderCouponManagement,
                payments: renderPaymentsManagement,
                explorer: renderDataExplorer,
            };
            
            const renderFunction = renderMap[pageId] || renderDevDashboard;
            await renderFunction();
        };
        
        async function loadAllData() {
            const loader = document.createElement('div');
            loader.innerHTML = '<div class="loader"></div><p class="text-center text-gray-400">Loading platform data...</p>';
            const activePage = document.querySelector('.dev-page.active') || document.getElementById('dev-dashboard');
            activePage.innerHTML = '';
            activePage.appendChild(loader);
            try {
                const [usersSnapshot, workspacesSnapshot, couponsSnapshot] = await Promise.all([
                    getDocs(collection(db, "users")),
                    getDocs(collection(db, "workspaces")),
                    getDocs(collection(db, "couponCodes"))
                ]);
                allUsers = usersSnapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                allWorkspaces = workspacesSnapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                allCoupons = couponsSnapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                
                simulateFinancialData();
            } catch (error) {
                console.error("Error loading data:", error);
                showToast("Failed to load platform data. Please check console.", "error");
            } finally {
                loader.remove();
            }
        }
        
        const showToast = (message, type = 'success') => {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            toastContainer.appendChild(toast);
            setTimeout(() => { toast.classList.add('show'); }, 100);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => { toast.remove(); }, 300);
            }, 4000);
        };
        
        // --- RENDER FUNCTIONS ---

        function renderDevDashboard() {
            const container = document.getElementById('dev-dashboard');
            const totalUsers = allUsers.length;
            const totalWorkspaces = allWorkspaces.length;
            const planCounts = allUsers.reduce((acc, user) => {
                const plan = user.plan || 'Free';
                acc[plan] = (acc[plan] || 0) + 1;
                return acc;
            }, {});
            container.innerHTML = `
                <h1 class="text-3xl font-bold text-white mb-8">Platform Analytics</h1>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="card p-6"><h3 class="text-lg font-semibold text-gray-400">Total Users</h3><p class="text-4xl font-bold text-white mt-2">${totalUsers}</p></div>
                    <div class="card p-6"><h3 class="text-lg font-semibold text-gray-400">Total Workspaces</h3><p class="text-4xl font-bold text-white mt-2">${totalWorkspaces}</p></div>
                    <div class="card p-6"><h3 class="text-lg font-semibold text-gray-400">Active Coupons</h3><p class="text-4xl font-bold text-white mt-2">${allCoupons.filter(c => c.active).length}</p></div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="card p-6"><h3 class="text-xl font-semibold text-white mb-4">New Users & Workspaces (Last 30 Days)</h3><canvas id="dashboard-chart"></canvas></div>
                    <div class="card p-6"><h3 class="text-xl font-semibold text-white mb-4">User Plan Distribution</h3><canvas id="plan-chart"></canvas></div>
                </div>
            `;
            if(charts.dashboard) charts.dashboard.destroy();
            charts.dashboard = new Chart(document.getElementById('dashboard-chart'), { type: 'line', data: { labels: [...Array(30).keys()].map(i => `Day ${i+1}`), datasets: [{ label: 'New Users', data: [...Array(30).keys()].map(() => Math.floor(Math.random() * 10)), borderColor: '#34D399', tension: 0.1 }, { label: 'New Workspaces', data: [...Array(30).keys()].map(() => Math.floor(Math.random() * 5)), borderColor: '#60A5FA', tension: 0.1 }]}});
            if(charts.plan) charts.plan.destroy();
            charts.plan = new Chart(document.getElementById('plan-chart'), { type: 'doughnut', data: { labels: Object.keys(planCounts), datasets: [{ data: Object.values(planCounts), backgroundColor: ['#4B5563', '#F59E0B', '#34D399', '#8B5CF6'] }]}});
        }

        function renderFinancialsDashboard() {
            const container = document.getElementById('dev-financials');
            container.innerHTML = `
                <h1 class="text-3xl font-bold text-white mb-8">Financial Dashboard</h1>
                <p class="text-gray-400 mb-6 -mt-6">This is a simulated dashboard. No real payment data is processed.</p>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="card p-6"><h3 class="text-lg font-semibold text-gray-400">Monthly Recurring Revenue (MRR)</h3><p class="text-4xl font-bold text-emerald-400 mt-2">$${financialData.mrr.toLocaleString()}</p></div>
                    <div class="card p-6"><h3 class="text-lg font-semibold text-gray-400">Active Subscriptions</h3><p class="text-4xl font-bold text-white mt-2">${financialData.subscriptions}</p></div>
                    <div class="card p-6"><h3 class="text-lg font-semibold text-gray-400">Churn Rate (30d)</h3><p class="text-4xl font-bold text-red-400 mt-2">${financialData.churn}%</p></div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                    <div class="card p-6"><h3 class="text-xl font-semibold text-white mb-4">MRR Growth</h3><canvas id="mrr-chart"></canvas></div>
                    <div class="card p-6"><h3 class="text-xl font-semibold text-white mb-4">Subscriptions Growth</h3><canvas id="subs-chart"></canvas></div>
                </div>
                <div class="card p-0 overflow-hidden">
                    <h3 class="text-xl font-semibold text-white p-6">Recent Transactions (Simulated)</h3>
                    <div class="overflow-x-auto"><table class="w-full text-left text-sm"><thead class="bg-gray-800"><tr>
                        <th class="p-4 font-semibold">Date</th><th class="p-4 font-semibold">User</th>
                        <th class="p-4 font-semibold">Plan</th><th class="p-4 font-semibold">Amount</th>
                        <th class="p-4 font-semibold">Status</th>
                    </tr></thead><tbody>
                        ${financialData.transactions.slice(0, 10).map(t => `
                            <tr class="border-b border-gray-700">
                                <td class="p-4">${t.date}</td><td class="p-4">${t.userEmail}</td>
                                <td class="p-4">${t.plan}</td><td class="p-4">$${t.amount.toFixed(2)}</td>
                                <td class="p-4"><span class="px-2 py-1 text-xs rounded-full bg-green-500/20 text-green-300">${t.status}</span></td>
                            </tr>`).join('')}
                    </tbody></table></div>
                </div>`;
            if(charts.mrr) charts.mrr.destroy();
            charts.mrr = new Chart(document.getElementById('mrr-chart'), { type: 'line', data: { labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'], datasets: [{ label: 'MRR', data: [120, 190, 300, 500, 800, financialData.mrr], borderColor: '#34D399', tension: 0.2 }]}});
            if(charts.subs) charts.subs.destroy();
            charts.subs = new Chart(document.getElementById('subs-chart'), { type: 'bar', data: { labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'], datasets: [{ label: 'Subscriptions', data: [24, 38, 60, 100, 160, financialData.subscriptions], backgroundColor: '#60A5FA' }]}});
        }

        function simulateFinancialData() {
            const PLAN_PRICES = { Free: 0, Starter: 5, Pro: 10, Enterprise: 12 };
            let mrr = 0, subscriptions = 0, transactions = [];
            allWorkspaces.forEach(ws => {
                const plan = ws.plan || 'Free';
                const price = (PLAN_PRICES[plan] || 0) * (ws.maxUsers || 1);
                if (price > 0) {
                    mrr += price;
                    subscriptions++;
                    const owner = allUsers.find(u => u.id === ws.ownerId);
                    if(owner) {
                        transactions.push({ id: `txn_${Math.random().toString(36).substr(2, 9)}`, userEmail: owner.email, plan, amount: price, date: new Date(Date.now() - Math.random() * 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], status: 'succeeded' });
                    }
                }
            });
            financialData = { mrr, subscriptions, churn: (Math.random() * 5).toFixed(2), transactions: transactions.sort((a, b) => new Date(b.date) - new Date(a.date)) };
        }

        // --- USER & CUSTOMER MANAGEMENT ---
        
        function renderUserManagement() {
            const container = document.getElementById('dev-users');
            container.innerHTML = `<h1 class="text-3xl font-bold text-white mb-8">User Management</h1><p class="text-gray-400 mb-6 -mt-6">This tab lists all non-admin users. Admins are managed via the Customer Mgt. tab.</p><div id="user-filter-bar" class="card p-4 mb-6"></div><div class="grid grid-cols-1 lg:grid-cols-3 gap-8"><div id="user-list-container" class="lg:col-span-2 card p-2"></div><div id="user-details-sidebar" class="lg:col-span-1 card p-6 h-fit sticky top-8"></div></div>`;
            renderUserFilters();
            renderUserList();
            renderUserDetailsSidebar();
        }

        function renderUserFilters() {
            document.getElementById('user-filter-bar').innerHTML = `<div class="grid grid-cols-1 md:grid-cols-3 gap-4"><input type="text" id="user-name-filter" class="form-input" placeholder="Filter by name or email..." value="${userFilters.name || ''}"><select id="user-workspace-filter" class="form-select"><option value="">All Workspaces</option>${allWorkspaces.map(ws => `<option value="${ws.id}" ${userFilters.workspace === ws.id ? 'selected' : ''}>${ws.name}</option>`).join('')}</select><select id="user-role-filter" class="form-select"><option value="">All Roles (Non-Admin)</option><option value="Manager" ${userFilters.role === 'Manager' ? 'selected' : ''}>Manager</option><option value="Employee" ${userFilters.role === 'Employee' ? 'selected' : ''}>Employee</option></select></div>`;
            document.getElementById('user-name-filter').addEventListener('input', (e) => { userFilters.name = e.target.value.toLowerCase(); renderUserList(); });
            document.getElementById('user-workspace-filter').addEventListener('change', (e) => { userFilters.workspace = e.target.value; renderUserList(); });
            document.getElementById('user-role-filter').addEventListener('change', (e) => { userFilters.role = e.target.value; renderUserList(); });
        }

        function renderUserList() {
            const ownerIds = new Set(allWorkspaces.map(ws => ws.ownerId));
            let filteredUsers = allUsers.filter(u => !ownerIds.has(u.id));

            if (userFilters.name) filteredUsers = filteredUsers.filter(u => u.name?.toLowerCase().includes(userFilters.name) || u.email.toLowerCase().includes(userFilters.name));
            if (userFilters.workspace) filteredUsers = filteredUsers.filter(u => u.workspaces && u.workspaces[userFilters.workspace]);
            if (userFilters.role) filteredUsers = filteredUsers.filter(u => u.workspaces && Object.values(u.workspaces).includes(userFilters.role));

            const listHtml = filteredUsers.map(u => `<div class="list-item p-4 border-b border-gray-700 flex justify-between items-center rounded-lg ${selectedItemId === u.id ? 'selected' : ''}" data-id="${u.id}"><div><p class="font-semibold text-white">${u.name || 'N/A'}</p><p class="text-sm text-gray-400">${u.email}</p></div><span class="px-2 py-1 text-xs rounded-full bg-gray-500/20 text-gray-300">${Object.keys(u.workspaces || {}).length} ws</span></div>`).join('');
            document.getElementById('user-list-container').innerHTML = listHtml || '<p class="text-center text-gray-500 p-8">No users found matching filters.</p>';
            document.querySelectorAll('#user-list-container .list-item').forEach(item => item.addEventListener('click', () => { selectedItemId = item.dataset.id; renderUserList(); renderUserDetailsSidebar(); }));
        }

        function renderUserDetailsSidebar() {
            const sidebar = document.getElementById('user-details-sidebar');
            if (!selectedItemId) { sidebar.innerHTML = '<p class="text-gray-500 text-center">Select a user to see details.</p>'; return; }
            const user = allUsers.find(u => u.id === selectedItemId);
            const userWorkspaces = user.workspaces ? Object.entries(user.workspaces).map(([id, role]) => ({ id, name: allWorkspaces.find(w => w.id === id)?.name || 'Unknown Workspace', role })) : [];
            sidebar.innerHTML = `<h3 class="text-xl font-bold text-white mb-4">${user.name}</h3><div class="space-y-3 text-sm"><p><strong class="text-gray-400">Email:</strong> ${user.email}</p><p><strong class="text-gray-400">User ID:</strong> <code class="text-xs bg-gray-800 p-1 rounded">${user.id}</code></p><p class="mt-4"><strong class="text-gray-400">Workspace Memberships:</strong></p><ul class="pl-4 text-gray-400 list-disc">${userWorkspaces.map(ws => `<li><strong>${ws.name}</strong> as <em>${ws.role}</em></li>`).join('') || '<li>Not in any workspaces.</li>'}</ul></div><div class="mt-6 space-y-2 border-t border-gray-700 pt-4"><button data-id="${user.id}" class="w-full cta-button edit-user-btn">Edit User Details</button><button data-id="${user.id}" data-email="${user.email}" class="w-full secondary-button send-reset-btn">Send Password Reset</button></div>`;
            sidebar.querySelector('.edit-user-btn').addEventListener('click', openEditUserModal);
            sidebar.querySelector('.send-reset-btn').addEventListener('click', handleSendPasswordReset);
        }

        function renderCustomerManagement() {
            const container = document.getElementById('dev-customers');
            container.innerHTML = `<h1 class="text-3xl font-bold text-white mb-8">Customer Management</h1><p class="text-gray-400 mb-6 -mt-6">This tab lists only primary account owners (users who own at least one workspace).</p><div id="customer-filter-bar" class="card p-4 mb-6"></div><div class="grid grid-cols-1 lg:grid-cols-3 gap-8"><div id="customer-list-container" class="lg:col-span-2 card p-2"></div><div id="customer-details-sidebar" class="lg:col-span-1 card p-6 h-fit sticky top-8"></div></div>`;
            renderCustomerFilters();
            renderCustomerList();
            renderCustomerDetailsSidebar();
        }

        function renderCustomerFilters() {
            document.getElementById('customer-filter-bar').innerHTML = `<div class="grid grid-cols-1 md:grid-cols-3 gap-4"><input type="text" id="customer-name-filter" class="form-input" placeholder="Filter by name or email..." value="${customerFilters.name || ''}"><select id="customer-plan-filter" class="form-select"><option value="">All Plans</option><option value="Free" ${customerFilters.plan === 'Free' ? 'selected' : ''}>Free</option><option value="Starter" ${customerFilters.plan === 'Starter' ? 'selected' : ''}>Starter</option><option value="Pro" ${customerFilters.plan === 'Pro' ? 'selected' : ''}>Pro</option><option value="Enterprise" ${customerFilters.plan === 'Enterprise' ? 'selected' : ''}>Enterprise</option></select></div>`;
            document.getElementById('customer-name-filter').addEventListener('input', (e) => { customerFilters.name = e.target.value.toLowerCase(); renderCustomerList(); });
            document.getElementById('customer-plan-filter').addEventListener('change', (e) => { customerFilters.plan = e.target.value; renderCustomerList(); });
        }

        function renderCustomerList() {
            const ownerIds = new Set(allWorkspaces.map(ws => ws.ownerId));
            let customers = allUsers.filter(u => ownerIds.has(u.id));

            if (customerFilters.name) customers = customers.filter(c => c.name?.toLowerCase().includes(customerFilters.name) || c.email.toLowerCase().includes(customerFilters.name));
            if (customerFilters.plan) customers = customers.filter(c => (c.plan || 'Free') === customerFilters.plan);

            const listHtml = customers.map(c => `<div class="list-item p-4 border-b border-gray-700 flex justify-between items-center rounded-lg ${selectedItemId === c.id ? 'selected' : ''}" data-id="${c.id}"><div><p class="font-semibold text-white">${c.name || 'N/A'}</p><p class="text-sm text-gray-400">${c.email}</p></div><span class="px-2 py-1 text-xs rounded-full bg-emerald-500/20 text-emerald-300">${c.plan || 'Free'}</span></div>`).join('');
            document.getElementById('customer-list-container').innerHTML = listHtml || '<p class="text-center text-gray-500 p-8">No customers found matching filters.</p>';
            document.querySelectorAll('#customer-list-container .list-item').forEach(item => item.addEventListener('click', () => { selectedItemId = item.dataset.id; renderCustomerList(); renderCustomerDetailsSidebar(); }));
        }

        function renderCustomerDetailsSidebar() {
            const sidebar = document.getElementById('customer-details-sidebar');
            if (!selectedItemId) { sidebar.innerHTML = '<p class="text-gray-500 text-center">Select a customer to see details.</p>'; return; }
            const customer = allUsers.find(c => c.id === selectedItemId);
            const customerWorkspaces = allWorkspaces.filter(ws => ws.ownerId === customer.id);
            sidebar.innerHTML = `<h3 class="text-xl font-bold text-white mb-4">${customer.name}</h3><div class="space-y-3 text-sm"><p><strong class="text-gray-400">Email:</strong> ${customer.email}</p><p><strong class="text-gray-400">User ID:</strong> <code class="text-xs bg-gray-800 p-1 rounded">${customer.id}</code></p><p><strong class="text-gray-400">Current Plan:</strong> ${customer.plan || 'Free'}</p><p><strong class="text-gray-400">Owned Workspaces:</strong> ${customerWorkspaces.length}</p><ul class="pl-4 text-gray-400 list-disc">${customerWorkspaces.map(ws => `<li>${ws.name} (${ws.plan || 'Free'})</li>`).join('') || '<li>No workspaces owned.</li>'}</ul></div><div class="mt-6 space-y-2 border-t border-gray-700 pt-4"><button data-id="${customer.id}" class="w-full cta-button edit-user-btn">Edit Customer</button><button data-id="${customer.id}" class="w-full danger-button delete-customer-btn">Delete Customer</button></div>`;
            sidebar.querySelector('.edit-user-btn').addEventListener('click', openEditUserModal);
            sidebar.querySelector('.delete-customer-btn').addEventListener('click', handleDeleteCustomer);
        }

        function renderWorkspaceManagement() {
            const container = document.getElementById('dev-workspaces');
            container.innerHTML = `<div class="flex justify-between items-center mb-8"><h1 class="text-3xl font-bold text-white">Workspace Management</h1><button id="create-workspace-btn" class="cta-button">Create Workspace</button></div><div id="workspace-filter-bar" class="card p-4 mb-6"></div><div class="grid grid-cols-1 lg:grid-cols-3 gap-8"><div id="workspace-list-container" class="lg:col-span-2 card p-2"></div><div id="workspace-details-sidebar" class="lg:col-span-1 card p-6 h-fit sticky top-8"></div></div>`;
            document.getElementById('create-workspace-btn').addEventListener('click', openCreateWorkspaceModal);
            renderWorkspaceFilters();
            renderWorkspaceList();
            renderWorkspaceDetailsSidebar();
        }

        function renderWorkspaceFilters() {
             document.getElementById('workspace-filter-bar').innerHTML = `<div class="grid grid-cols-1 md:grid-cols-3 gap-4"><input type="text" id="workspace-name-filter" class="form-input" placeholder="Filter by name or owner email..." value="${workspaceFilters.name || ''}"><select id="workspace-plan-filter" class="form-select"><option value="">All Plans</option><option value="Free">Free</option><option value="Starter">Starter</option><option value="Pro">Pro</option><option value="Enterprise">Enterprise</option></select></div>`;
            document.getElementById('workspace-name-filter').addEventListener('input', (e) => { workspaceFilters.name = e.target.value.toLowerCase(); renderWorkspaceList(); });
            document.getElementById('workspace-plan-filter').addEventListener('change', (e) => { workspaceFilters.plan = e.target.value; renderWorkspaceList(); });
        }

        async function renderWorkspaceList() {
            let filteredWorkspaces = allWorkspaces;
            if (workspaceFilters.name) filteredWorkspaces = filteredWorkspaces.filter(ws => { const owner = allUsers.find(u => u.id === ws.ownerId); return ws.name.toLowerCase().includes(workspaceFilters.name) || (owner && owner.email.toLowerCase().includes(workspaceFilters.name)); });
            if (workspaceFilters.plan) filteredWorkspaces = filteredWorkspaces.filter(ws => (ws.plan || 'Free') === workspaceFilters.plan);
            
            const memberCounts = {};
            for (const ws of filteredWorkspaces) {
                const membersSnapshot = await getDocs(query(collection(db, `workspaces/${ws.id}/members`)));
                memberCounts[ws.id] = membersSnapshot.size;
            }

            const listHtml = filteredWorkspaces.map(ws => `<div class="list-item p-4 border-b border-gray-700 flex justify-between items-center rounded-lg ${selectedItemId === ws.id ? 'selected' : ''}" data-id="${ws.id}"><div><p class="font-semibold text-white">${ws.name}</p><p class="text-sm text-gray-400">Owner: ${allUsers.find(u => u.id === ws.ownerId)?.email || 'N/A'}</p></div><span class="px-2 py-1 text-xs rounded-full bg-blue-500/20 text-blue-300">${memberCounts[ws.id] || 0} / ${ws.maxUsers || 1} Users</span></div>`).join('');
            document.getElementById('workspace-list-container').innerHTML = listHtml || '<p class="text-center text-gray-500 p-8">No workspaces found matching filters.</p>';
            document.querySelectorAll('#workspace-list-container .list-item').forEach(item => item.addEventListener('click', () => { selectedItemId = item.dataset.id; renderWorkspaceList(); renderWorkspaceDetailsSidebar(); }));
        }

        async function renderWorkspaceDetailsSidebar() {
            const sidebar = document.getElementById('workspace-details-sidebar');
            if (!selectedItemId) { sidebar.innerHTML = '<p class="text-gray-500 text-center">Select a workspace to see details.</p>'; return; }
            const workspace = allWorkspaces.find(ws => ws.id === selectedItemId);
            const owner = allUsers.find(u => u.id === workspace.ownerId);

            sidebar.innerHTML = `<div class="loader"></div>`;
            const membersSnapshot = await getDocs(collection(db, `workspaces/${workspace.id}/members`));

            sidebar.innerHTML = `<h3 class="text-xl font-bold text-white mb-4">${workspace.name}</h3><div class="space-y-3 text-sm"><p><strong class="text-gray-400">Workspace ID:</strong> <code class="text-xs bg-gray-800 p-1 rounded">${workspace.id}</code></p><p><strong class="text-gray-400">Owner:</strong> ${owner?.name || 'N/A'} (${owner?.email || 'N/A'})</p><p><strong class="text-gray-400">Plan:</strong> ${workspace.plan || 'Free'}</p><p><strong class="text-gray-400">Usage:</strong> ${membersSnapshot.size} / ${workspace.maxUsers || 1} Users</p><p><strong class="text-gray-400">Created At:</strong> ${workspace.createdAt?.toDate().toLocaleString() || 'N/A'}</p></div><div class="mt-6 space-y-2 border-t border-gray-700 pt-4"><button data-id="${workspace.id}" class="w-full cta-button edit-workspace-btn">Edit Workspace</button><button data-id="${workspace.id}" class="w-full secondary-button clone-workspace-btn">Clone/Backup Workspace</button><button data-id="${workspace.id}" class="w-full danger-button delete-workspace-btn">Delete Workspace</button></div>`;
            sidebar.querySelector('.edit-workspace-btn').addEventListener('click', openEditWorkspaceModal);
            sidebar.querySelector('.clone-workspace-btn').addEventListener('click', handleCloneWorkspace);
            sidebar.querySelector('.delete-workspace-btn').addEventListener('click', handleDeleteWorkspace);
        }

        function openEditUserModal(e) {
            const userId = e.target.dataset.id;
            const user = allUsers.find(u => u.id === userId);
            const isCustomer = allWorkspaces.some(ws => ws.ownerId === userId);
            const modalContent = document.getElementById('edit-modal-content');
            const userWorkspaces = user.workspaces ? Object.entries(user.workspaces).map(([id, role]) => ({ id, name: allWorkspaces.find(w => w.id === id)?.name || id, role })) : [];
            const availableWorkspaces = allWorkspaces.filter(ws => !(user.workspaces && user.workspaces[ws.id]));
            modalContent.innerHTML = `
                <form id="edit-user-form" data-id="${userId}">
                    <div class="p-6 border-b border-gray-700"><h3 class="text-xl font-semibold">Edit ${isCustomer ? 'Customer' : 'User'}: ${user.name}</h3></div>
                    <div class="p-6 space-y-6 overflow-y-auto">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label class="block mb-1 text-gray-400">Name</label><input type="text" name="name" class="form-input w-full" value="${user.name || ''}"></div>
                            ${isCustomer ? `<div><label class="block mb-1 text-gray-400">Master Plan</label><select name="plan" class="form-select w-full"><option value="Free" ${!user.plan || user.plan === 'Free' ? 'selected' : ''}>Free</option><option value="Starter" ${user.plan === 'Starter' ? 'selected' : ''}>Starter</option><option value="Pro" ${user.plan === 'Pro' ? 'selected' : ''}>Pro</option><option value="Enterprise" ${user.plan === 'Enterprise' ? 'selected' : ''}>Enterprise</option></select></div>` : ''}
                        </div>
                        <div><h4 class="text-lg font-semibold text-white mb-2">Workspace Memberships</h4><div id="user-workspaces-list" class="space-y-2">${userWorkspaces.map(ws => `<div class="flex items-center gap-2 bg-gray-800 p-2 rounded-lg" data-ws-id="${ws.id}"><span class="flex-grow">${ws.name}</span><select class="form-select text-sm py-1 role-selector"><option value="Admin" ${ws.role === 'Admin' ? 'selected': ''}>Admin</option><option value="Manager" ${ws.role === 'Manager' ? 'selected': ''}>Manager</option><option value="Employee" ${ws.role === 'Employee' ? 'selected': ''}>Employee</option></select><button type="button" class="text-red-400 hover:text-red-300 remove-ws-btn">×</button></div>`).join('') || '<p class="text-gray-500">No current memberships.</p>'}</div></div>
                        <div><h4 class="text-lg font-semibold text-white mb-2">Add to New Workspace</h4><input type="search" id="add-ws-search" class="form-input w-full mb-2" placeholder="Search available workspaces..."><div class="flex gap-2"><select id="add-ws-select" class="form-select flex-grow"><option value="">Select a workspace...</option>${availableWorkspaces.map(ws => `<option value="${ws.id}">${ws.name}</option>`).join('')}</select><button type="button" id="add-user-to-ws-btn" class="secondary-button text-sm">Add</button></div></div>
                    </div>
                    <div class="p-4 bg-gray-800 flex justify-end gap-4 mt-auto">
                        <button type="button" class="secondary-button close-modal-btn">Cancel</button>
                        <button type="submit" class="cta-button">Save Changes</button>
                    </div>
                </form>
            `;
            document.getElementById('edit-modal').classList.remove('hidden');
            modalContent.querySelector('.close-modal-btn').addEventListener('click', closeAllModals);
            modalContent.querySelector('form').addEventListener('submit', handleSaveUser);
            modalContent.querySelectorAll('.remove-ws-btn').forEach(btn => btn.addEventListener('click', (e) => e.target.closest('.flex').remove()));
            modalContent.querySelector('#add-user-to-ws-btn').addEventListener('click', handleAddUserToWorkspace);
            modalContent.querySelector('#add-ws-search').addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const select = modalContent.querySelector('#add-ws-select');
                for (const option of select.options) { if (option.value) option.hidden = !option.text.toLowerCase().includes(searchTerm); }
            });
        }

        async function handleSaveUser(e) {
            e.preventDefault();
            const form = e.target;
            const button = form.querySelector('button[type="submit"]');
            button.disabled = true;
            button.textContent = 'Saving...';
            try {
                const userId = form.dataset.id;
                const newWorkspacesMap = {};
                form.querySelectorAll('#user-workspaces-list > div').forEach(div => { newWorkspacesMap[div.dataset.wsId] = div.querySelector('.role-selector').value; });
                const updatedUserData = { name: form.name.value, workspaces: newWorkspacesMap };
                if (form.plan) updatedUserData.plan = form.plan.value;

                const batch = writeBatch(db);
                batch.update(doc(db, 'users', userId), updatedUserData);
                const originalUser = allUsers.find(u => u.id === userId);
                const originalWorkspaces = originalUser.workspaces || {};
                for (const wsId in originalWorkspaces) { if (!newWorkspacesMap[wsId]) batch.delete(doc(db, `workspaces/${wsId}/members/${userId}`)); }
                for (const wsId in newWorkspacesMap) {
                    const ownerData = allUsers.find(u => u.id === userId);
                    batch.set(doc(db, `workspaces/${wsId}/members/${userId}`), { uid: userId, email: ownerData.email, name: ownerData.name, role: newWorkspacesMap[wsId] }, { merge: true });
                }
                await batch.commit();
                showToast('User updated successfully!', 'success');
                await loadAllData();
                if (document.getElementById('dev-users').classList.contains('active')) { renderUserList(); renderUserDetailsSidebar(); } 
                else if (document.getElementById('dev-customers').classList.contains('active')) { renderCustomerList(); renderCustomerDetailsSidebar(); }
                closeAllModals();
            } catch (error) {
                console.error("Error saving user:", error);
                showToast(`Error: ${error.message}`, 'error');
            } finally {
                button.disabled = false;
                button.textContent = 'Save Changes';
            }
        }

        function handleAddUserToWorkspace() {
            const addSelect = document.getElementById('add-ws-select');
            const wsId = addSelect.value;
            if (!wsId) return;
            const wsName = addSelect.options[addSelect.selectedIndex].text;
            const list = document.getElementById('user-workspaces-list');
            if (list.querySelector('p')) list.innerHTML = '';
            const newEntry = document.createElement('div');
            newEntry.className = 'flex items-center gap-2 bg-gray-800 p-2 rounded-lg';
            newEntry.dataset.wsId = wsId;
            newEntry.innerHTML = `<span class="flex-grow">${wsName}</span><select class="form-select text-sm py-1 role-selector"><option value="Employee" selected>Employee</option><option value="Manager">Manager</option><option value="Admin">Admin</option></select><button type="button" class="text-red-400 hover:text-red-300 remove-ws-btn">×</button>`;
            list.appendChild(newEntry);
            newEntry.querySelector('.remove-ws-btn').addEventListener('click', (e) => e.target.closest('.flex').remove());
            addSelect.remove(addSelect.selectedIndex);
        }

        async function handleSendPasswordReset(e) {
            const email = e.target.dataset.email;
            if (!email) { showToast('No email on file for this user.', 'error'); return; }
            try {
                await sendPasswordResetEmail(auth, email);
                showToast(`Password reset email sent to ${email}`, 'success');
            } catch (error) {
                console.error("Password reset error:", error);
                showToast(`Error sending email: ${error.message}`, 'error');
            }
        }

        function handleDeleteCustomer(e) {
            const customerId = e.target.dataset.id;
            const customer = allUsers.find(c => c.id === customerId);
            openConfirmationModal('Delete Customer Account', `This will permanently delete the user '${customer.name}' and ALL workspaces they own. This is highly destructive and cannot be undone.`, async (button) => {
                button.disabled = true;
                button.textContent = 'Deleting...';
                try {
                    const batch = writeBatch(db);
                    batch.delete(doc(db, 'users', customerId));
                    const workspacesToDelete = allWorkspaces.filter(ws => ws.ownerId === customerId);
                    workspacesToDelete.forEach(ws => batch.delete(doc(db, 'workspaces', ws.id)));
                    await batch.commit();
                    showToast('Customer and their workspaces deleted.', 'success');
                    selectedItemId = null;
                    await loadAllData();
                    renderCustomerManagement();
                    closeAllModals();
                } catch (error) {
                     console.error("Error deleting customer:", error);
                     showToast(`Error: ${error.message}`, 'error');
                } finally {
                    button.disabled = false;
                    button.textContent = 'Confirm';
                }
            });
        }
        
        function openCreateWorkspaceModal() {
            const modalContent = document.getElementById('edit-modal-content');
            const userOptions = allUsers.map(u => `<option value="${u.id}">${u.email}</option>`).join('');

            modalContent.innerHTML = `
                <form id="create-workspace-form">
                    <div class="p-6 border-b border-gray-700"><h3 class="text-xl font-semibold">Create New Workspace</h3></div>
                    <div class="p-6 space-y-4">
                        <div><label class="block mb-1">Workspace Name</label><input type="text" name="name" class="form-input w-full" required></div>
                        <div><label class="block mb-1">Owner</label><select name="ownerId" class="form-select w-full" required>${userOptions}</select></div>
                        <div><label class="block mb-1">User Seats (Max Users)</label><input type="number" name="maxUsers" class="form-input w-full" value="1" min="1" required></div>
                    </div>
                    <div class="p-4 bg-gray-800 flex justify-end gap-4">
                        <button type="button" class="secondary-button close-modal-btn">Cancel</button>
                        <button type="submit" class="cta-button">Create Workspace</button>
                    </div>
                </form>
            `;
            document.getElementById('edit-modal').classList.remove('hidden');
            modalContent.querySelector('.close-modal-btn').addEventListener('click', closeAllModals);
            modalContent.querySelector('form').addEventListener('submit', handleCreateWorkspace);
        }

        async function handleCreateWorkspace(e) {
            e.preventDefault();
            const form = e.target;
            const button = form.querySelector('button[type="submit"]');
            button.disabled = true;
            button.textContent = 'Creating...';
            
            try {
                const ownerId = form.ownerId.value;
                const ownerData = allUsers.find(u => u.id === ownerId);
                if (!ownerData) { throw new Error("Selected owner not found."); }
                
                const newMaxUsers = Number(form.maxUsers.value);
                const newPlan = getPlanFromUserCount(newMaxUsers);

                const batch = writeBatch(db);
                const newWorkspaceRef = doc(collection(db, 'workspaces'));
                batch.set(newWorkspaceRef, { name: form.name.value, plan: newPlan, maxUsers: newMaxUsers, ownerId: ownerId, createdAt: Timestamp.now(), departments: ["General"], payTypes: ["Hourly", "Salary"], employeeTypes: ["Full-time", "Part-time"], projectCustomFields: ["Client Name", "Budget"] });
                batch.set(doc(db, 'workspaces', newWorkspaceRef.id, 'members', ownerId), { uid: ownerId, email: ownerData.email, name: ownerData.name, role: 'Admin', status: 'Active' });
                batch.update(doc(db, 'users', ownerId), { [`workspaces.${newWorkspaceRef.id}`]: 'Admin' });

                await batch.commit();
                showToast('Workspace created successfully!', 'success');
                await loadAllData();
                renderWorkspaceManagement();
                closeAllModals();
            } catch (error) {
                console.error("Error creating workspace:", error);
                showToast(`Error: ${error.message}`, 'error');
            } finally {
                button.disabled = false;
                button.textContent = 'Create Workspace';
            }
        }

        function openEditWorkspaceModal(e) {
            const workspaceId = e.target.dataset.id;
            const workspace = allWorkspaces.find(ws => ws.id === workspaceId);
            const modalContent = document.getElementById('edit-modal-content');
            const ownerIds = new Set(allWorkspaces.map(ws => ws.ownerId));
            const ownerOptions = allUsers.filter(u => ownerIds.has(u.id)).map(owner => `<option value="${owner.id}" ${workspace.ownerId === owner.id ? 'selected' : ''}>${owner.email}</option>`).join('');

            modalContent.innerHTML = `
                <form id="edit-workspace-form" data-id="${workspaceId}">
                    <div class="p-6 border-b border-gray-700"><h3 class="text-xl font-semibold">Edit Workspace: ${workspace.name}</h3></div>
                    <div class="p-6 space-y-4">
                        <div><label class="block mb-1 text-gray-400">Workspace Name</label><input type="text" name="name" class="form-input w-full" value="${workspace.name}"></div>
                        <div><label class="block mb-1 text-gray-400">User Seats (Max Users)</label><input type="number" name="maxUsers" class="form-input w-full" min="1" value="${workspace.maxUsers || 1}"></div>
                        <div><label class="block mb-1 text-gray-400">Owner</label><select name="ownerId" class="form-select w-full">${ownerOptions}</select></div>
                    </div>
                    <div class="p-4 bg-gray-800 flex justify-end gap-4">
                        <button type="button" class="secondary-button close-modal-btn">Cancel</button>
                        <button type="submit" class="cta-button">Save Changes</button>
                    </div>
                </form>
            `;
            document.getElementById('edit-modal').classList.remove('hidden');
            modalContent.querySelector('.close-modal-btn').addEventListener('click', closeAllModals);
            modalContent.querySelector('form').addEventListener('submit', handleSaveWorkspace);
        }
        
        function getPlanFromUserCount(count) {
            if (count <= 5) return 'Free';
            if (count <= 15) return 'Starter';
            return 'Pro'; // Or Enterprise based on other factors
        }

        async function handleSaveWorkspace(e) {
            e.preventDefault();
            const form = e.target;
            const button = form.querySelector('button[type="submit"]');
            button.disabled = true;
            button.textContent = 'Saving...';
            
            try {
                const workspaceId = form.dataset.id;
                const newMaxUsers = Number(form.maxUsers.value);
                const newPlan = getPlanFromUserCount(newMaxUsers);
                
                const updatedData = { name: form.name.value, plan: newPlan, maxUsers: newMaxUsers, ownerId: form.ownerId.value };
                
                await updateDoc(doc(db, 'workspaces', workspaceId), updatedData);
                showToast('Workspace updated successfully!', 'success');
                await loadAllData();
                renderWorkspaceManagement();
                closeAllModals();
            } catch(error) {
                console.error("Error saving workspace:", error);
                showToast(`Error: ${error.message}`, 'error');
            } finally {
                button.disabled = false;
                button.textContent = 'Save Changes';
            }
        }

        function handleDeleteWorkspace(e) {
            const workspaceId = e.target.dataset.id;
            const workspace = allWorkspaces.find(ws => ws.id === workspaceId);
            openConfirmationModal('Delete Workspace', `This will permanently delete the workspace '${workspace.name}'. All member and time data will be lost. This cannot be undone.`, async (button) => {
                button.disabled = true;
                button.textContent = 'Deleting...';
                try {
                    await deleteDoc(doc(db, 'workspaces', workspaceId));
                    showToast('Workspace deleted.', 'success');
                    selectedItemId = null;
                    await loadAllData();
                    renderWorkspaceManagement();
                    closeAllModals();
                } catch(error) {
                    console.error("Error deleting workspace:", error);
                    showToast(`Error: ${error.message}`, 'error');
                } finally {
                    button.disabled = false;
                    button.textContent = 'Confirm';
                }
            });
        }

        async function handleCloneWorkspace(e) {
            const button = e.target;
            button.disabled = true;
            button.textContent = 'Cloning...';
            const workspaceId = e.target.dataset.id;
            const workspace = allWorkspaces.find(ws => ws.id === workspaceId);
            const newName = prompt("Enter a name for the new cloned workspace:", `${workspace.name} (Clone)`);
            if (!newName) {
                button.disabled = false;
                button.textContent = 'Clone/Backup Workspace';
                return;
            }

            showToast('Starting workspace clone... This may take a moment.', 'success');

            try {
                const sourceWsDoc = await getDoc(doc(db, "workspaces", workspaceId));
                const subcollectionNames = ["members", "projects", "timeEntries", "schedules", "tasks"];
                
                const subcollectionSnapshots = await Promise.all(
                    subcollectionNames.map(name => getDocs(collection(db, `workspaces/${workspaceId}/${name}`)))
                );

                const batch = writeBatch(db);
                const newWsRef = doc(collection(db, "workspaces"));
                const newWsData = { ...sourceWsDoc.data(), name: newName, createdAt: Timestamp.now() };
                batch.set(newWsRef, newWsData);

                subcollectionSnapshots.forEach((snapshot, index) => {
                    const subcollectionName = subcollectionNames[index];
                    snapshot.forEach(docSnapshot => {
                        const newDocRef = doc(db, `workspaces/${newWsRef.id}/${subcollectionName}`, docSnapshot.id);
                        batch.set(newDocRef, docSnapshot.data());
                    });
                });
                await batch.commit();
                showToast(`Workspace "${newName}" created successfully!`, 'success');
                await loadAllData();
                renderWorkspaceManagement();
            } catch (error) {
                console.error("Error cloning workspace:", error);
                showToast(`Error cloning workspace: ${error.message}`, 'error');
            } finally {
                button.disabled = false;
                button.textContent = 'Clone/Backup Workspace';
            }
        }
        
        function openConfirmationModal(title, message, onConfirm) {
            const modal = document.getElementById('confirmation-modal');
            document.getElementById('confirmation-modal-title').textContent = title;
            document.getElementById('confirmation-modal-message').innerHTML = message;
            
            const confirmBtn = document.getElementById('confirmation-confirm-btn');
            const newConfirmBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
            
            newConfirmBtn.addEventListener('click', () => onConfirm(newConfirmBtn));
            modal.querySelector('#confirmation-cancel-btn').addEventListener('click', closeAllModals);
            modal.classList.remove('hidden');
        }

        function closeAllModals() {
            document.getElementById('edit-modal').classList.add('hidden');
            document.getElementById('confirmation-modal').classList.add('hidden');
        }

        function renderCouponManagement() {
            const container = document.getElementById('dev-coupons');
            let tableRows = allCoupons.map(coupon => `
                 <tr class="border-b border-gray-700 ${!coupon.active ? 'opacity-50' : ''}">
                    <td class="p-3 font-mono">${coupon.code}</td>
                    <td class="p-3">${coupon.discountPercent}%</td>
                    <td class="p-3">${coupon.uses || 0} / ${coupon.maxUses || '∞'}</td>
                    <td class="p-3">${coupon.expires ? coupon.expires.toDate().toLocaleDateString() : 'Never'}</td>
                    <td class="p-3"><span class="px-2 py-1 text-xs rounded-full ${coupon.active ? 'bg-green-500/20 text-green-300' : 'bg-red-500/20 text-red-300'}">${coupon.active ? 'Active' : 'Inactive'}</span></td>
                    <td class="p-3"><button data-cid="${coupon.id}" data-active="${coupon.active}" class="secondary-button text-sm px-3 py-1 rounded-md toggle-coupon-btn">${coupon.active ? 'Deactivate' : 'Activate'}</button></td>
                </tr>
            `).join('');

            container.innerHTML = `<h1 class="text-3xl font-bold text-white mb-8">Coupon Code Management</h1><div class="grid grid-cols-1 lg:grid-cols-3 gap-8"><div class="lg:col-span-1"><form id="add-coupon-form" class="card p-6 space-y-4"><h3 class="text-xl font-semibold">Create New Coupon</h3><div><label class="block mb-1">Coupon Code</label><input type="text" name="code" class="form-input w-full uppercase" required></div><div><label class="block mb-1">Discount (%)</label><input type="number" name="discount" class="form-input w-full" min="1" max="100" required></div><div><label class="block mb-1">Max Uses (optional)</label><input type="number" name="maxUses" class="form-input w-full" min="1"></div><div><label class="block mb-1">Expires On (optional)</label><input type="date" name="expires" class="form-input w-full"></div><button type="submit" class="w-full cta-button">Create Coupon</button></form></div><div class="lg:col-span-2 card p-0 overflow-hidden"><div class="overflow-x-auto"><table class="w-full text-left text-sm"><thead class="bg-gray-800"><tr><th class="p-3 font-semibold">Code</th><th class="p-3 font-semibold">Discount</th><th class="p-3 font-semibold">Uses</th><th class="p-3 font-semibold">Expires</th><th class="p-3 font-semibold">Status</th><th class="p-3 font-semibold">Action</th></tr></thead><tbody>${tableRows}</tbody></table></div></div></div>`;
            document.getElementById('add-coupon-form').addEventListener('submit', handleCreateCoupon);
            container.querySelectorAll('.toggle-coupon-btn').forEach(btn => btn.addEventListener('click', handleToggleCoupon));
        }
        
        function renderDataExplorer() {
            const container = document.getElementById('dev-explorer');
            container.innerHTML = `<h1 class="text-3xl font-bold text-white mb-8">Raw Data Explorer</h1><div class="card p-6"><div class="mb-4"><label class="block mb-1">Select Collection:</label><select id="collection-selector" class="form-select w-full md:w-1/2"><option value="">--Select--</option><option value="users">users</option><option value="workspaces">workspaces</option><option value="couponCodes">couponCodes</option><option value="configuration">configuration</option></select></div><div id="data-output"><pre><code>Select a collection to view data.</code></pre></div></div>`;
            document.getElementById('collection-selector').addEventListener('change', async (e) => {
                const collectionName = e.target.value;
                const output = document.getElementById('data-output');
                if (!collectionName) { output.innerHTML = `<pre><code>Select a collection to view data.</code></pre>`; return; }
                output.innerHTML = '<div class="loader"></div>';
                const snapshot = await getDocs(collection(db, collectionName));
                const data = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                output.innerHTML = `<pre><code>${JSON.stringify(data, (key, value) => (value && value.toDate) ? value.toDate().toISOString() : value, 2)}</code></pre>`;
            });
        }
        
        async function handleCreateCoupon(e) {
            e.preventDefault();
            const form = e.target;
            const button = form.querySelector('button[type="submit"]');
            button.disabled = true;
            button.textContent = "Creating...";
            const newCoupon = { code: form.code.value.toUpperCase(), discountPercent: Number(form.discount.value), maxUses: form.maxUses.value ? Number(form.maxUses.value) : null, expires: form.expires.value ? Timestamp.fromDate(new Date(form.expires.value)) : null, uses: 0, active: true, createdAt: Timestamp.now() };
            try {
                await addDoc(collection(db, 'couponCodes'), newCoupon);
                showToast(`Coupon ${newCoupon.code} created.`, 'success');
                form.reset();
                await loadAllData();
                renderCouponManagement();
            } catch(error) {
                showToast(`Error: ${error.message}`, 'error');
            } finally {
                button.disabled = false;
                button.textContent = "Create Coupon";
            }
        }

        async function handleToggleCoupon(e) {
            const button = e.target;
            button.disabled = true;
            const cid = button.dataset.cid;
            const newActiveState = button.dataset.active === 'false';
            try {
                await updateDoc(doc(db, 'couponCodes', cid), { active: newActiveState });
                showToast(`Coupon status updated.`, 'success');
                await loadAllData();
                renderCouponManagement();
            } catch(error) {
                showToast(`Error: ${error.message}`, 'error');
            }
        }
        
        async function renderPaymentsManagement() {
            const container = document.getElementById('dev-payments');
            container.innerHTML = `<div class="loader"></div>`;
            const configRef = doc(db, 'configuration', 'stripe');
            const configSnap = await getDoc(configRef);
            const config = configSnap.exists() ? configSnap.data() : { priceMap: { Starter:{}, Pro:{}, Enterprise:{} } };
            container.innerHTML = `<h1 class="text-3xl font-bold text-white mb-8">Payment & API Key Management</h1><form id="payments-config-form" class="space-y-8"><div class="card p-6"><h3 class="text-xl font-semibold mb-4">Stripe API Keys</h3><div class="space-y-4"><div><label class="block mb-1">Publishable Key (pk_...)</label><input type="text" data-key="publishableKey" class="form-input w-full" value="${config.publishableKey || ''}"></div><div><label class="block mb-1">Secret Key (sk_...)</label><input type="password" data-key="secretKey" class="form-input w-full" value="${config.secretKey || ''}"></div><div><label class="block mb-1">Webhook Signing Secret (whsec_...)</label><input type="password" data-key="webhookSecret" class="form-input w-full" value="${config.webhookSecret || ''}"></div></div></div><div class="card p-6"><h3 class="text-xl font-semibold mb-4">Stripe Price IDs</h3><div class="mb-6"><h4 class="font-bold text-lg text-emerald-400">Starter Plan</h4><div class="grid md:grid-cols-2 gap-4 mt-2"><div><label class="block mb-1">Monthly Price ID</label><input type="text" data-plan="Starter" data-cycle="monthly" class="form-input w-full" value="${config.priceMap?.Starter?.monthly || 'price_1RimnBCaLDv0y6ZNZMUUmXLh'}"></div><div><label class="block mb-1">Annual Price ID</label><input type="text" data-plan="Starter" data-cycle="annual" class="form-input w-full" value="${config.priceMap?.Starter?.annual || 'price_1Rip7YCaLDv0y6ZNpkocncl9'}"></div></div></div><div class="mb-6"><h4 class="font-bold text-lg text-emerald-400">Pro Plan</h4><div class="grid md:grid-cols-2 gap-4 mt-2"><div><label class="block mb-1">Monthly Price ID</label><input type="text" data-plan="Pro" data-cycle="monthly" class="form-input w-full" value="${config.priceMap?.Pro?.monthly || 'price_1Rip7YCaLDv0y6ZNAE5fFaZX'}"></div><div><label class="block mb-1">Annual Price ID</label><input type="text" data-plan="Pro" data-cycle="annual" class="form-input w-full" value="${config.priceMap?.Pro?.annual || 'price_1Rip7YCaLDv0y6ZNbIUCtzjp'}"></div></div></div><div><h4 class="font-bold text-lg text-emerald-400">Enterprise Plan</h4><div class="grid md:grid-cols-2 gap-4 mt-2"><div><label class="block mb-1">Monthly Price ID</label><input type="text" data-plan="Enterprise" data-cycle="monthly" class="form-input w-full" value="${config.priceMap?.Enterprise?.monthly || 'price_1Rip8SCaLDv0y6ZNYJ1QjrC9'}"></div><div><label class="block mb-1">Annual Price ID</label><input type="text" data-plan="Enterprise" data-cycle="annual" class="form-input w-full" value="${config.priceMap?.Enterprise?.annual || 'price_1Rip8fCaLDv0y6ZNRiirOvUE'}"></div></div></div></div><div class="flex justify-end"><button type="submit" class="cta-button">Save Payment Configuration</button></div></form>`;
            document.getElementById('payments-config-form').addEventListener('submit', handleSavePaymentsConfig);
        }

        async function handleSavePaymentsConfig(e) {
            e.preventDefault();
            const form = e.target;
            const button = form.querySelector('button[type="submit"]');
            button.disabled = true;
            button.textContent = "Saving...";
            
            const configData = {
                publishableKey: form.querySelector('[data-key="publishableKey"]').value,
                secretKey: form.querySelector('[data-key="secretKey"]').value,
                webhookSecret: form.querySelector('[data-key="webhookSecret"]').value,
                priceMap: {
                    Starter: { monthly: form.querySelector('[data-plan="Starter"][data-cycle="monthly"]').value, annual: form.querySelector('[data-plan="Starter"][data-cycle="annual"]').value },
                    Pro: { monthly: form.querySelector('[data-plan="Pro"][data-cycle="monthly"]').value, annual: form.querySelector('[data-plan="Pro"][data-cycle="annual"]').value },
                    Enterprise: { monthly: form.querySelector('[data-plan="Enterprise"][data-cycle="monthly"]').value, annual: form.querySelector('[data-plan="Enterprise"][data-cycle="annual"]').value }
                }
            };
            
            try {
                await setDoc(doc(db, 'configuration', 'stripe'), configData, { merge: true });
                showToast('Payment configuration saved successfully!', 'success');
            } catch (error) {
                console.error("Error saving payment config:", error);
                showToast(`Error: ${error.message}`, 'error');
            } finally {
                button.disabled = false;
                button.textContent = 'Save Payment Configuration';
            }
        }
        
        function renderLoginForm() {
            authContainer.innerHTML = `
                <section class="py-20"><div class="max-w-md mx-auto card p-8 rounded-xl mt-10">
                    <div class="text-center mb-8"><h3 class="text-3xl font-bold text-white">Dev Portal Login</h3></div>
                    <form id="dev-login-form">
                        <div class="mb-4"><label for="dev-email" class="block text-gray-300 mb-2">Admin Email</label><input type="email" id="dev-email" class="w-full p-3 form-input" required></div>
                        <div class="mb-6"><label for="dev-password" class="block text-gray-300 mb-2">Admin Password</label><input type="password" id="dev-password" class="w-full p-3 form-input" required></div>
                        <div class="text-center"><button type="submit" class="w-full cta-button">Authenticate</button></div>
                    </form>
                    <p id="dev-login-error" class="text-red-500 text-center mt-4"></p>
                </div></section>
            `;
            document.getElementById('dev-login-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                document.getElementById('dev-login-error').textContent = '';
                const email = document.getElementById('dev-email').value;
                const password = document.getElementById('dev-password').value;
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (error) {
                    document.getElementById('dev-login-error').textContent = `Login Failed: ${error.message}`;
                }
            });
        }
        
        devLogoutButton.addEventListener('click', () => signOut(auth));

    </script>
</body>
</html>
