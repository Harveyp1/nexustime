<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Settings - NexusTime</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://js.stripe.com/v3/"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
</head>
<body class="bg-gray-950 text-white font-inter">
  <header id="topNav" class="hidden bg-gray-900 px-6 py-4 flex items-center justify-between">
    <div class="flex items-center space-x-4">
      <img src="https://github.com/Harveyp1/nexustime/blob/main/nexustimelogo.png?raw=true" alt="Logo" class="h-10" />
      <span class="text-2xl font-bold text-emerald-400">NexusTime</span>
    </div>
    <nav class="space-x-6 text-gray-300">
      <a href="dashboard.html" class="hover:text-emerald-400">Dashboard</a>
      <a href="timesheet.html" class="hover:text-emerald-400">Timesheets</a>
      <a href="schedule.html" class="hover:text-emerald-400">Schedule</a>
      <a href="settings.html" class="hover:text-emerald-400 font-semibold">Settings</a>
      <a href="switch-workspace.html" class="hover:text-emerald-400">Switch Workspace</a>
    </nav>
  </header>

  <!-- Error Messages -->
  <div id="authError" class="hidden p-6 text-center">
    <p class="text-red-400 mb-4">You are not signed in. Please <a href="app.html" class="text-emerald-400 underline">log in</a> to access settings.</p>
  </div>
  <div id="workspaceError" class="hidden p-6 text-center">
    <p class="text-red-400 mb-4">No workspace selected. Please <a href="switch-workspace.html" class="text-emerald-400 underline">choose a workspace</a>.</p>
  </div>

  <div id="mainContainer" class="hidden flex min-h-screen">
    <!-- Sidebar -->
    <aside class="w-64 bg-gray-900 p-6 space-y-6">
      <h2 class="text-xl font-bold text-gray-200">Settings</h2>
      <div id="planCard" class="bg-gray-800 p-4 rounded flex justify-between items-center">
        <div>Plan: <span id="workspacePlanSidebar" class="font-semibold"></span></div>
        <button id="upgradePlanSidebar" class="bg-yellow-500 text-gray-900 px-3 py-1 rounded hidden">Upgrade</button>
      </div>
      <nav class="space-y-2 text-gray-400">
        <button data-section="userprofile" id="tab-userprofile" class="w-full text-left px-3 py-2 rounded hover:bg-gray-800">User Profile</button>
        <button data-section="workspacebilling" id="tab-workspacebilling" class="w-full text-left px-3 py-2 rounded hover:bg-gray-800">Workspace & Billing</button>
        <button data-section="logoupload" id="tab-logoupload" class="w-full text-left px-3 py-2 rounded hover:bg-gray-800">Workspace Logo</button>
        <button data-section="generalsettings" id="tab-generalsettings" class="w-full text-left px-3 py-2 rounded hover:bg-gray-800">Workspace Settings</button>
        <button data-section="roles" id="tab-roles" class="w-full text-left px-3 py-2 rounded hover:bg-gray-800">Roles & Permissions</button>
      </nav>
    </aside>

    <!-- Content -->
    <section class="flex-1 p-8">
      <div id="section-userprofile" class="hidden space-y-6">
        <h3 class="text-xl font-semibold">User Profile</h3>
      </div>
      <div id="section-workspacebilling" class="hidden space-y-6">
        <h3 class="text-xl font-semibold">Workspace & Billing</h3>
      </div>
      <div id="section-logoupload" class="hidden space-y-6">
        <h3 class="text-xl font-semibold">Workspace Logo</h3>
      </div>
      <div id="section-generalsettings" class="hidden space-y-6">
        <h3 class="text-xl font-semibold">Workspace Settings</h3>
      </div>
      <div id="section-roles" class="hidden space-y-6">
        <h3 class="text-xl font-semibold">Roles & Permissions</h3>
      </div>
    </section>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js';
    import { getFirestore, doc, getDoc } from 'https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js';

    const firebaseConfig = {
      apiKey: "AIzaSyCKy_SqRUTKkoeuTzrksN2_TQ41v8s9Ls",
      authDomain: "nexustime-e8b91.firebaseapp.com",
      projectId: "nexustime-e8b91",
      storageBucket: "nexustime-e8b91.appspot.com",
      messagingSenderId: "516976739338",
      appId: "1:516976739338:web:537ae732707a2a1aab4bf3",
      measurementId: "G-QRSD6TYH86"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    onAuthStateChanged(auth, async user => {
      console.log('Debug: onAuthStateChanged fired, user=', user);
      if (!user) {
        document.getElementById('authError').classList.remove('hidden');
        return;
      }
      const workspaceId = localStorage.getItem('activeWorkspace');
      console.log('Debug: Retrieved workspaceId=', workspaceId);
      if (!workspaceId) {
        document.getElementById('workspaceError').classList.remove('hidden');
        return;
      }

      // show main content
      document.getElementById('topNav').classList.remove('hidden');
      document.getElementById('mainContainer').classList.remove('hidden');

      // setup tabs
      document.querySelectorAll('aside button').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('section [id^="section-"]').forEach(sec => sec.classList.add('hidden'));
          document.getElementById('section-' + btn.dataset.section).classList.remove('hidden');
        });
      });
      document.getElementById('tab-userprofile').click();

      // load workspace plan
      const wsRef = doc(db, 'workspaces', workspaceId);
      const wsSnap = await getDoc(wsRef);
      if (wsSnap.exists()) {
        const data = wsSnap.data();
        document.getElementById('workspacePlanSidebar').textContent = data.plan;
        if (data.plan !== 'Enterprise') document.getElementById('upgradePlanSidebar').classList.remove('hidden');
      }
    });
  </script>
</body>
</html>
