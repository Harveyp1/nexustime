<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Workspace - NexusTime</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #111827; color: #E5E7EB; }
        .card { background-color: #1F2937; border: 1px solid #374151; }
        .header { background-color: rgba(17, 24, 39, 0.8); backdrop-filter: blur(10px); }
        .nav-link.active { color: #34D399; font-weight: 600; }
        .cta-button { transition: all 0.3s ease; background-color: #34D399; color: #111827; }
        .secondary-button { background-color: transparent; border: 1px solid #34D399; color: #34D399; transition: all 0.3s ease; }
        .danger-button { background-color: transparent; border: 1px solid #F87171; color: #F87171; transition: all 0.3s ease; }
        .form-input, .form-select { background-color: #1F2937; border: 1px solid #374151; color: #E5E7EB; border-radius: 0.5rem; }
        .form-input:focus, .form-select:focus { outline: none; border-color: #34D399; box-shadow: 0 0 0 2px rgba(52, 211, 153, 0.5); }
        .form-select { -webkit-appearance: none; -moz-appearance: none; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke-width='2' stroke='%2334D399'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M19.5 8.25l-7.5 7.5-7.5-7.5' /%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 0.75rem center; background-size: 1.5em 1.5em; padding-right: 2.5rem; }
        .modal-overlay { background-color: rgba(17, 24, 39, 0.8); backdrop-filter: blur(4px); }
        .tab-button { border-bottom: 2px solid transparent; }
        .tab-button.active { color: #34D399; border-bottom-color: #34D399; }
        .status-badge { padding: 0.125rem 0.5rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 500; }
        .status-active { background-color: #10B981; color: white; }
        .status-inactive { background-color: #6B7280; color: white; }
    </style>
</head>
<body class="bg-gray-900 text-white">
    <header class="bg-gray-900 shadow p-4 sticky top-0 z-30">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <a href="dashboard.html"><img src="https://raw.githubusercontent.com/Harveyp1/nexustime/main/nexustimelogo.png" alt="NexusTime Logo" class="h-10"></a>
            <nav>
                <ul class="flex gap-6 text-gray-300 text-sm font-medium">
                    <li><a href="dashboard.html" class="nav-link hover:text-white">Dashboard</a></li>
                    <li><a href="timesheet.html" class="nav-link hover:text-white">Timesheets</a></li>
                    <li><a href="manage.html" class="nav-link active">Manage</a></li>
                    <li><a href="settings.html" class="nav-link hover:text-white">Settings</a></li>
                    <li><a href="workspaces.html" class="nav-link hover:text-white">Switch Workspace</a></li>
                </ul>
            </nav>
            <button id="logout-button" class="border border-emerald-400 text-emerald-400 px-4 py-1 rounded hover:bg-emerald-500 hover:text-white">Log Out</button>
        </div>
    </header>

    <main>
        <section id="manage" class="max-w-7xl mx-auto mt-10 p-4">
            <div class="flex justify-between items-center mb-8"><h2 class="text-3xl font-bold text-white">Manage Workspace</h2><button id="add-new-button" class="cta-button px-4 py-2 rounded-lg text-sm"></button></div><div class="border-b border-gray-700 mb-8"><nav class="flex space-x-8" id="manage-tabs"><button data-tab="employees" class="tab-button py-4 px-1 font-medium text-lg active">Employees</button><button data-tab="projects" class="tab-button py-4 px-1 font-medium text-lg">Projects</button></nav></div><div id="manage-content"></div>
        </section>
    </main>

    <div id="add-employee-modal" class="fixed inset-0 z-50 modal-overlay items-center justify-center hidden"><div class="card rounded-lg shadow-xl m-8 max-w-3xl w-full"><div class="p-6 border-b border-gray-700 flex justify-between items-center"><h3 class="text-xl font-semibold text-white">Add New Employee</h3><button class="text-gray-400 hover:text-white text-3xl close-add-modal-btn">&times;</button></div><form id="add-employee-form" class="p-6 space-y-4"></form></div></div>
    <div id="edit-employee-modal" class="fixed inset-0 z-50 modal-overlay items-center justify-center hidden"><div class="card rounded-lg shadow-xl m-8 max-w-3xl w-full"><div class="p-6 border-b border-gray-700 flex justify-between items-center"><h3 class="text-xl font-semibold text-white">Edit Employee</h3><button class="text-gray-400 hover:text-white text-3xl close-add-modal-btn">&times;</button></div><form id="edit-employee-form" class="p-6 space-y-4"></form></div></div>
    <div id="add-project-modal" class="fixed inset-0 z-50 modal-overlay items-center justify-center hidden"><div class="card rounded-lg shadow-xl m-8 max-w-lg w-full"><div class="p-6 border-b border-gray-700 flex justify-between items-center"><h3 class="text-xl font-semibold text-white">Add New Project</h3><button class="text-gray-400 hover:text-white text-3xl close-add-modal-btn">&times;</button></div><form id="add-project-form" class="p-6 space-y-4"><div><label for="new-project-name" class="block text-gray-300 mb-2">Project Name</label><input type="text" id="new-project-name" class="w-full p-3 form-input" required></div><div class="flex justify-end gap-4 pt-4"><button type="button" class="secondary-button px-6 py-2 rounded-lg close-add-modal-btn">Cancel</button><button type="submit" class="cta-button px-6 py-2 rounded-lg">Add Project</button></div></form></div></div>

    <script type="module">
        import { mockData, stateManager } from 'https://raw.githubusercontent.com/Harveyp1/nexustime/main/common.js';

        document.addEventListener('DOMContentLoaded', () => {
            stateManager.checkAuth();
            stateManager.checkWorkspace();

            let currentManagePage = 1;
            const ITEMS_PER_PAGE = 20;
            let editingEmployeeIndex = null;

            const manageTabs = document.getElementById('manage-tabs');
            const manageContent = document.getElementById('manage-content');
            const addNewButton = document.getElementById('add-new-button');
            const addEmployeeModal = document.getElementById('add-employee-modal');
            const editEmployeeModal = document.getElementById('edit-employee-modal');
            const addProjectModal = document.getElementById('add-project-modal');
            const addEmployeeForm = document.getElementById('add-employee-form');
            const editEmployeeForm = document.getElementById('edit-employee-form');
            const addProjectForm = document.getElementById('add-project-form');
            const logoutButton = document.getElementById('logout-button');

            const renderManagePage = (activeTab = 'employees', searchTerm = '', page = 1) => {
                if(!manageTabs || !manageContent) return;
                currentManagePage = page;
                manageTabs.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
                const activeTabEl = manageTabs.querySelector(`[data-tab="${activeTab}"]`);
                if(activeTabEl) activeTabEl.classList.add('active');
                
                if(addNewButton) addNewButton.textContent = `Add New ${activeTab === 'employees' ? 'Employee' : 'Project'}`;

                const isEmployees = activeTab === 'employees';
                const currentWorkspaceId = stateManager.getCurrentWorkspace();
                const allItems = isEmployees ? mockData.employees[currentWorkspaceId] : mockData.projects[currentWorkspaceId];
                
                const filteredItems = allItems.filter(item => {
                    const name = isEmployees ? `${item.firstName} ${item.lastName}`.toLowerCase() : item.toLowerCase();
                    return name.includes(searchTerm.toLowerCase());
                });

                const totalPages = Math.ceil(filteredItems.length / ITEMS_PER_PAGE);
                const startIndex = (page - 1) * ITEMS_PER_PAGE;
                const endIndex = startIndex + ITEMS_PER_PAGE;
                const paginatedItems = filteredItems.slice(startIndex, endIndex);

                let listHtml = paginatedItems.map((item) => {
                    const originalIndex = allItems.indexOf(item);
                    return `
                    <li class="flex justify-between items-center bg-gray-800 p-3 rounded-lg">
                        <div>
                            <span>${isEmployees ? item.name : item}</span>
                            ${isEmployees ? `<span class="ml-2 status-badge ${item.status === 'Active' ? 'status-active' : 'status-inactive'}">${item.status}</span>` : ''}
                        </div>
                        <div class="space-x-2">
                            ${isEmployees ? `<button class="secondary-button text-xs px-2 py-1 rounded edit-item-btn" data-index="${originalIndex}">Edit</button>` : ''}
                            <button class="danger-button text-xs px-2 py-1 rounded remove-item-btn" data-index="${originalIndex}" data-type="${activeTab}">Remove</button>
                        </div>
                    </li>`
                }).join('');

                manageContent.innerHTML = `
                    <div class="mb-4">
                        <input type="text" id="manage-filter" class="form-input w-full md:w-1/3" placeholder="Filter by name..." value="${searchTerm}">
                    </div>
                    <div class="card p-6 rounded-lg"><ul class="space-y-2">${listHtml || '<p class="text-gray-500">No items to display.</p>'}</ul></div>
                    <div id="pagination-controls" class="flex justify-center items-center mt-6 space-x-4"></div>
                `;
                
                renderPaginationControls(totalPages, page, activeTab, searchTerm);
                document.querySelectorAll('.remove-item-btn').forEach(btn => btn.addEventListener('click', handleRemoveItem));
                document.querySelectorAll('.edit-item-btn').forEach(btn => btn.addEventListener('click', handleEditItem));
                document.getElementById('manage-filter').addEventListener('input', (e) => renderManagePage(activeTab, e.target.value, 1));
            };

            function renderPaginationControls(totalPages, currentPage, activeTab, searchTerm) {
                const controlsContainer = document.getElementById('pagination-controls');
                if (!controlsContainer) return;
                let html = '';
                if (totalPages > 1) {
                    html += `<button class="secondary-button px-3 py-1 rounded ${currentPage === 1 ? 'opacity-50 cursor-not-allowed' : ''}" ${currentPage === 1 ? 'disabled' : ''} data-page="${currentPage - 1}">Prev</button>`;
                    html += `<span class="text-gray-400">Page ${currentPage} of ${totalPages}</span>`;
                    html += `<button class="secondary-button px-3 py-1 rounded ${currentPage === totalPages ? 'opacity-50 cursor-not-allowed' : ''}" ${currentPage === totalPages ? 'disabled' : ''} data-page="${currentPage + 1}">Next</button>`;
                }
                controlsContainer.innerHTML = html;
                controlsContainer.querySelectorAll('button').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        renderManagePage(activeTab, searchTerm, parseInt(e.target.dataset.page));
                    });
                });
            }

            function handleAddNew() {
                const activeTab = manageTabs.querySelector('.active').dataset.tab;
                openAddModal(activeTab);
            }

            function openAddModal(type) {
                if (type === 'employees' && addEmployeeModal) {
                    addEmployeeForm.innerHTML = getEmployeeFormHtml();
                    populateDropdowns(addEmployeeForm);
                    addEmployeeModal.style.display = 'flex';
                }
                if (type === 'projects' && addProjectModal) addProjectModal.style.display = 'flex';
            }
            
            function handleEditItem(e) {
                const { index } = e.target.dataset;
                editingEmployeeIndex = index;
                const employee = mockData.employees[stateManager.getCurrentWorkspace()][index];
                editEmployeeForm.innerHTML = getEmployeeFormHtml(employee);
                populateDropdowns(editEmployeeForm, employee);
                editEmployeeModal.style.display = 'flex';
            }

            function getEmployeeFormHtml(employee = {}) {
                return `
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div><label class="block text-gray-300 mb-2">First Name</label><input type="text" name="firstName" class="w-full p-3 form-input" required value="${employee.firstName || ''}"></div>
                        <div><label class="block text-gray-300 mb-2">Middle Name</label><input type="text" name="middleName" class="w-full p-3 form-input" value="${employee.middleName || ''}"></div>
                        <div><label class="block text-gray-300 mb-2">Last Name</label><input type="text" name="lastName" class="w-full p-3 form-input" required value="${employee.lastName || ''}"></div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label class="block text-gray-300 mb-2">Employee ID</label><input type="text" name="id" class="w-full p-3 form-input" required value="${employee.id || ''}"></div>
                        <div><label class="block text-gray-300 mb-2">Card Number</label><input type="text" name="cardNumber" class="w-full p-3 form-input" value="${employee.cardNumber || ''}"></div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label class="block text-gray-300 mb-2">Hire Date</label><input type="date" name="hireDate" class="w-full p-3 form-input" required value="${employee.hireDate || ''}"></div>
                        <div><label class="block text-gray-300 mb-2">Supervisor</label><select name="supervisor" class="w-full p-3 form-select"></select></div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div><label class="block text-gray-300 mb-2">Department</label><select name="department" class="w-full p-3 form-select"></select></div>
                        <div><label class="block text-gray-300 mb-2">Pay Type</label><select name="payType" class="w-full p-3 form-select"></select></div>
                        <div><label class="block text-gray-300 mb-2">Employee Type</label><select name="employeeType" class="w-full p-3 form-select"></select></div>
                    </div>
                    ${employee.id ? `<div class="grid grid-cols-1 md:grid-cols-3 gap-4"><div><label class="block text-gray-300 mb-2">Status</label><select name="status" class="w-full p-3 form-select"><option value="Active">Active</option><option value="Inactive">Inactive</option></select></div></div>` : ''}
                    <div class="flex justify-end gap-4 pt-4"><button type="button" class="secondary-button px-6 py-2 rounded-lg close-add-modal-btn">Cancel</button><button type="submit" class="cta-button px-6 py-2 rounded-lg">${employee.id ? 'Save Changes' : 'Add Employee'}</button></div>
                `;
            }

            function populateDropdowns(formElement, employee = {}) {
                const currentWorkspaceId = stateManager.getCurrentWorkspace();
                populateDropdown(formElement.querySelector('select[name="department"]'), mockData.workspaces[currentWorkspaceId].departments, 'Add New Department...', employee.department);
                populateDropdown(formElement.querySelector('select[name="employeeType"]'), mockData.workspaces[currentWorkspaceId].employeeTypes, 'Add Custom Type...', employee.employeeType);
                populateDropdown(formElement.querySelector('select[name="payType"]'), mockData.workspaces[currentWorkspaceId].payTypes, 'Add Custom Type...', employee.payType);
                populateDropdown(formElement.querySelector('select[name="supervisor"]'), mockData.employees[currentWorkspaceId].map(e => e.name), null, employee.supervisor);
                if(employee.status) formElement.querySelector('select[name="status"]').value = employee.status;
            }

            function populateDropdown(select, optionsArray, addOptionText = null, selectedValue = null) {
                if (!select) return;
                select.innerHTML = optionsArray.map(opt => `<option value="${opt}" ${selectedValue === opt ? 'selected' : ''}>${opt}</option>`).join('');
                if (addOptionText) {
                    select.innerHTML += `<option value="add_new">${addOptionText}</option>`;
                    select.addEventListener('change', (e) => handleDropdownAdd(e, select, optionsArray, addOptionText));
                }
            }

            function handleDropdownAdd(event, select, optionsArray, addOptionText) {
                if (event.target.value === 'add_new') {
                    const newValue = prompt(`Enter new value for "${addOptionText.replace('Add New ', '').replace('...', '')}":`);
                    if (newValue && !optionsArray.includes(newValue)) {
                        optionsArray.push(newValue);
                        populateDropdown(select, optionsArray, addOptionText, newValue);
                        event.target.value = newValue;
                    } else {
                        event.target.selectedIndex = 0;
                    }
                }
            }

            function closeAddModal() {
                if(addEmployeeModal) addEmployeeModal.style.display = 'none';
                if(editEmployeeModal) editEmployeeModal.style.display = 'none';
                if(addProjectModal) addProjectModal.style.display = 'none';
            }

            function handleAddEmployee(e) {
                e.preventDefault();
                const form = e.target;
                const newEmployee = {
                    id: form.id.value,
                    name: `${form.firstName.value} ${form.lastName.value}`,
                    firstName: form.firstName.value,
                    lastName: form.lastName.value,
                    hireDate: form.hireDate.value,
                    department: form.department.value,
                    payType: form.payType.value,
                    employeeType: form.employeeType.value,
                    supervisor: form.supervisor.value,
                    cardNumber: form.cardNumber.value,
                    status: 'Active'
                };
                mockData.employees[stateManager.getCurrentWorkspace()].push(newEmployee);
                closeAddModal();
                renderManagePage('employees');
            }

            function handleEditEmployee(e) {
                e.preventDefault();
                const form = e.target;
                const updatedEmployee = {
                    id: form.id.value,
                    firstName: form.firstName.value,
                    middleName: form.middleName.value,
                    lastName: form.lastName.value,
                    name: `${form.firstName.value} ${form.lastName.value}`,
                    hireDate: form.hireDate.value,
                    department: form.department.value,
                    payType: form.payType.value,
                    employeeType: form.employeeType.value,
                    supervisor: form.supervisor.value,
                    cardNumber: form.cardNumber.value,
                    status: form.status.value
                };
                mockData.employees[stateManager.getCurrentWorkspace()][editingEmployeeIndex] = updatedEmployee;
                closeAddModal();
                renderManagePage('employees');
            }

            function handleAddProject(e) {
                e.preventDefault();
                const newProject = document.getElementById('new-project-name').value;
                mockData.projects[stateManager.getCurrentWorkspace()].push(newProject);
                closeAddModal();
                renderManagePage('projects');
            }

            function handleRemoveItem(e) {
                const { index, type } = e.target.dataset;
                if (confirm(`Are you sure you want to remove this ${type.slice(0, -1)}?`)) {
                    mockData[type][stateManager.getCurrentWorkspace()].splice(index, 1);
                    renderManagePage(type);
                }
            }

            if (logoutButton) logoutButton.addEventListener('click', stateManager.logout);
            if (manageTabs) manageTabs.addEventListener('click', (e) => { if(e.target.dataset.tab) renderManagePage(e.target.dataset.tab); });
            if (addNewButton) addNewButton.addEventListener('click', handleAddNew);
            if (addEmployeeForm) addEmployeeForm.addEventListener('submit', handleAddEmployee);
            if (editEmployeeForm) editEmployeeForm.addEventListener('submit', handleEditEmployee);
            if (addProjectForm) addProjectForm.addEventListener('submit', handleAddProject);
            document.querySelectorAll('.close-add-modal-btn').forEach(btn => btn.addEventListener('click', closeAddModal));
            
            renderManagePage();
        });
    </script>
</body>
</html>
