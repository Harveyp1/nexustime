<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NexusTime App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #111827; color: #E5E7EB; }
        .cta-button { transition: all 0.3s ease; background-color: #34D399; color: #111827; }
        .cta-button:disabled { background-color: #374151; color: #9CA3AF; cursor: not-allowed; }
        .secondary-button { background-color: transparent; border: 1px solid #34D399; color: #34D399; transition: all 0.3s ease; }
        .danger-button { background-color: #EF4444; color: white; transition: all 0.3s ease; }
        .danger-button:hover { background-color: #DC2626; }
        .card { background-color: #1F2937; border: 1px solid #374151; }
        .header { background-color: rgba(17, 24, 39, 0.8); backdrop-filter: blur(10px); border-bottom: 1px solid #374151; }
        .page { display: none; }
        .page.active { display: block; }
        .form-input, .form-select, .form-textarea { background-color: #1F2937; border: 1px solid #374151; color: #E5E7EB; border-radius: 0.5rem; }
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: #34D399; box-shadow: 0 0 0 2px rgba(52, 211, 153, 0.5); }
        .form-input:disabled, .form-textarea:disabled { background-color: #374151; cursor: not-allowed; }
        .form-select { -webkit-appearance: none; -moz-appearance: none; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke-width='2' stroke='%2334D399'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M19.5 8.25l-7.5 7.5-7.5-7.5' /%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 0.75rem center; background-size: 1.5em 1.5em; padding-right: 2.5rem; }
        .modal-overlay { background-color: rgba(17, 24, 39, 0.8); backdrop-filter: blur(4px); }
        .timesheet-table th, .timesheet-table td { text-align: center; padding: 0.75rem 0.5rem; border: 1px solid #374151; white-space: nowrap; }
        .timesheet-table .row-header { text-align: left; padding-left: 1rem; font-weight: 600; background-color: #374151; }
        .day-header { background-color: #374151; }
        .day-header.editable:hover { background-color: #4B5563; cursor: pointer; }
        .locked-day { background-color: #4B5563; color: #9CA3AF; cursor: not-allowed; }
        input[type="checkbox"]:disabled + span { color: #6B7280; }
        .tab-button { border-bottom: 2px solid transparent; transition: all 0.2s ease-in-out; }
        .tab-button.active { color: #34D399; border-bottom-color: #34D399; }
        .settings-tab-content { display: none; }
        .settings-tab-content.active { display: block; }
        .modal-tab-pane { display: none; }
        .modal-tab-pane.active { display: block; }
        .status-badge { padding: 0.125rem 0.5rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 500; }
        .status-active, .status-approved { background-color: #10B981; color: white; }
        .status-inactive { background-color: #6B7280; color: white; }
        .status-pending { background-color: #F59E0B; color: white; }
        .status-completed { background-color: #10B981; color: white; }
        .status-denied { background-color: #EF4444; color: white; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #34D399; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 2rem auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .manage-list-item { cursor: pointer; transition: background-color 0.2s; }
        .manage-list-item:hover, .manage-list-item.selected { background-color: #374151; }
        .toast { position: fixed; bottom: 20px; right: 20px; background-color: #1F2937; color: white; padding: 1rem 1.5rem; border-radius: 0.5rem; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); z-index: 100; opacity: 0; transition: opacity 0.3s ease-in-out; border-left: 4px solid; }
        .toast.show { opacity: 1; }
        .toast.success { border-color: #34D399; }
        .toast.error { border-color: #F87171; }
        .workspace-card.active-workspace { border-color: #34D399; box-shadow: 0 0 0 2px rgba(52, 211, 153, 0.5); }
        .plan-card { border: 2px solid #374151; transition: all 0.2s ease-in-out; display: flex; flex-direction: column; }
        .plan-card.selected { border-color: #34D399; background-color: #374151; }
        .calendar-grid { grid-template-columns: repeat(7, minmax(0, 1fr)); }
        .calendar-day { min-height: 120px; transition: background-color 0.2s; }
        .calendar-day.other-month { background-color: #1F2937; opacity: 0.5; }
        .calendar-day:not(.other-month):hover { background-color: #374151; cursor: pointer; }
        .shift-badge { background-color: #3B82F6; color: white; font-size: 0.75rem; padding: 2px 6px; border-radius: 4px; margin-top: 4px; display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .toggle-switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #4B5563; transition: .4s; border-radius: 28px; }
        .toggle-slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .toggle-slider { background-color: #34D399; }
        input:checked + .toggle-slider:before { transform: translateX(22px); }
        .task-item.completed { text-decoration: line-through; color: #6B7280; }
        
        .nav-link { display: flex; align-items: center; padding: 0.5rem 1rem; border-radius: 0.5rem; transition: background-color 0.2s; }
        .nav-link:hover, .nav-link.active { background-color: #374151; color: #34D399; }
        .nav-link svg { margin-right: 0.75rem; }

        @media print {
            body { background-color: white; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            body * { visibility: hidden; }
            #pay-stub-content, #pay-stub-content * { visibility: visible; }
            #pay-stub-content {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                color: #111827; /* black text for printing */
            }
            @page { size: auto; margin: 20px; }
        }
    </style>
</head>
<body class="bg-gray-900 text-white">
    <!-- Header -->
    <header class="header sticky top-0 z-40">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center">
                    <a href="#" class="flex-shrink-0">
                        <img src="https://raw.githubusercontent.com/Harveyp1/nexustime/main/nexustimelogo.png" alt="NexusTime Logo" class="h-10" onerror="this.onerror=null; this.src='https://placehold.co/160x40/111827/34D399?text=NexusTime';">
                    </a>
                </div>
                <div class="hidden md:block">
                    <nav id="app-nav-desktop" class="ml-10 flex items-baseline space-x-4">
                        <!-- Desktop Nav Links will be injected here -->
                    </nav>
                </div>
                 <div class="hidden md:block">
                    <button id="logout-button-desktop" class="secondary-button px-4 py-2 rounded-lg text-sm font-medium">Log Out</button>
                </div>
                <div class="-mr-2 flex md:hidden">
                    <button id="mobile-menu-button" type="button" class="bg-gray-800 inline-flex items-center justify-center p-2 rounded-md text-gray-400 hover:text-white hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-white" aria-controls="mobile-menu" aria-expanded="false">
                        <span class="sr-only">Open main menu</span>
                        <svg class="block h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
                        <svg class="hidden h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                </div>
            </div>
        </div>
        <!-- Mobile menu, show/hide based on menu state. -->
        <div class="md:hidden hidden" id="mobile-menu">
            <nav id="app-nav-mobile" class="px-2 pt-2 pb-3 space-y-1 sm:px-3">
                 <!-- Mobile Nav Links will be injected here -->
            </nav>
            <div class="pt-4 pb-3 border-t border-gray-700">
                <div class="px-2">
                    <button id="logout-button-mobile" class="w-full text-left secondary-button px-4 py-2 rounded-lg text-sm font-medium">Log Out</button>
                </div>
            </div>
        </div>
    </header>

    <main>
        <!-- Loading Indicator -->
        <div id="loading" class="page active">
            <div class="loader"></div>
            <p class="text-center text-gray-400">Loading Application...</p>
        </div>

        <!-- Login Page -->
        <div id="login" class="page">
            <section class="py-20"><div class="max-w-md mx-auto card p-8 rounded-xl mt-10"><div class="text-center mb-8"><h3 class="text-3xl font-bold text-white">Welcome Back</h3><p class="text-gray-400 mt-2">Log in to manage your workspaces.</p></div><form id="login-form"><div class="mb-4"><label for="login-email" class="block text-gray-300 mb-2">Email</label><input type="email" id="login-email" class="w-full p-3 form-input" required></div><div class="mb-6"><label for="login-password" class="block text-gray-300 mb-2">Password</label><input type="password" id="login-password" class="w-full p-3 form-input" required></div><div class="text-center"><button type="submit" class="w-full cta-button px-8 py-3 rounded-lg font-semibold">Log In</button></div></form><p id="login-error" class="text-red-500 text-center mt-4"></p></div></section>
        </div>

        <!-- Onboarding Page -->
        <div id="onboarding" class="page">
            <section class="py-12">
                <div id="onboarding-container" class="max-w-2xl mx-auto card p-8 rounded-xl">
                    <!-- Content will be rendered by JS -->
                </div>
            </section>
        </div>

        <!-- Workspace Selection Page -->
        <div id="company-selection" class="page">
            <section class="py-20">
                <div class="container mx-auto px-6">
                    <div class="flex flex-col md:flex-row justify-between items-start mb-12">
                        <div class="text-center md:text-left">
                            <h2 class="text-4xl font-bold text-white">Select a Workspace</h2>
                            <p class="text-gray-400 mt-2">Choose which workspace you want to manage.</p>
                        </div>
                        <div id="plan-stat-card" class="card p-4 mt-6 md:mt-0"></div>
                    </div>
                    <div id="workspace-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"></div>
                </div>
            </section>
        </div>

        <!-- Dashboard Page -->
        <div id="dashboard" class="page">
            <section class="py-12"><div class="container mx-auto px-6"><div class="flex flex-col md:flex-row justify-between md:items-center mb-8 gap-4"><h2 id="dashboard-title" class="text-3xl font-bold text-white"></h2></div><div id="dashboard-widgets" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8"></div><div class="grid grid-cols-1 lg:grid-cols-5 gap-6 mt-8"><div class="lg:col-span-2 card p-6"><h3 class="text-xl font-semibold text-white mb-4">Hours by Project</h3><canvas id="project-chart"></canvas></div><div class="lg:col-span-3 card p-6"><h3 class="text-xl font-semibold text-white mb-4">Hours by Employee</h3><canvas id="employee-chart"></canvas></div></div><div class="card p-0 overflow-hidden mt-8"><div class="p-6 flex justify-between items-center"><h3 class="text-xl font-semibold text-white">Recent Timesheet Entries</h3><a href="#timesheet" data-page="timesheet" class="nav-link secondary-button px-4 py-2 rounded-lg text-sm">View Full Timesheet</a></div><div class="overflow-x-auto"><table class="w-full text-left"><thead class="bg-gray-800"><tr><th class="p-4 font-semibold">Employee</th><th class="p-4 font-semibold">Date</th><th class="p-4 font-semibold">Hours</th></tr></thead><tbody id="timesheet-table-body"></tbody></table></div></div></div></section>
        </div>
        
        <!-- Manage Page -->
        <div id="manage" class="page">
            <section class="py-12">
                <div class="container mx-auto px-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-3xl font-bold text-white">Manage Workspace</h2>
                        <button id="add-new-button" class="cta-button px-4 py-2 rounded-lg text-sm"></button>
                    </div>
                    <div class="border-b border-gray-700 mb-4">
                        <nav class="flex space-x-8" id="manage-tabs">
                            <button data-tab="employees" class="tab-button py-4 px-1 font-medium text-lg active">Employees</button>
                            <button data-tab="projects" class="tab-button py-4 px-1 font-medium text-lg">Projects</button>
                            <button data-tab="departments" class="tab-button py-4 px-1 font-medium text-lg">Departments</button>
                            <button data-tab="payroll" class="tab-button py-4 px-1 font-medium text-lg">Payroll</button>
                        </nav>
                    </div>
                    <div id="employee-filter-bar" class="hidden mb-8"></div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                        <div id="manage-sidebar" class="md:col-span-1 card p-6"></div>
                        <div id="manage-content" class="md:col-span-2"></div>
                    </div>
                </div>
            </section>
        </div>

        <!-- Schedule Page -->
        <div id="schedule" class="page">
            <section class="py-12">
                <div class="container mx-auto px-6">
                    <div id="schedule-container">
                        <!-- Schedule content will be rendered here by JS -->
                    </div>
                </div>
            </section>
        </div>
        
        <!-- Time Off Page -->
        <div id="time-off" class="page">
             <section class="py-12">
                <div id="time-off-container" class="container mx-auto px-6">
                    <!-- Time Off content will be rendered here by JS -->
                </div>
            </section>
        </div>

        <!-- Pay Stubs Page -->
        <div id="pay-stubs" class="page">
             <section class="py-12">
                <div id="pay-stubs-container" class="container mx-auto px-6">
                    <!-- Pay Stubs content will be rendered here by JS -->
                </div>
            </section>
        </div>

        <!-- Tasks Page -->
        <div id="tasks" class="page">
             <section class="py-12">
                <div class="container mx-auto px-6">
                    <div id="tasks-container">
                        <!-- Task content will be rendered here by JS -->
                    </div>
                </div>
            </section>
        </div>

        <!-- Settings Page -->
        <div id="settings" class="page">
            <section class="py-12">
                <div class="container mx-auto px-6 max-w-6xl">
                    <h2 class="text-3xl font-bold text-white mb-8">Settings</h2>
                    <div class="flex flex-col md:flex-row gap-8">
                        <!-- Settings Navigation -->
                        <div class="md:w-1/4">
                            <nav id="settings-nav" class="flex flex-col space-y-2"></nav>
                        </div>
                        <!-- Settings Content -->
                        <div id="settings-content-area" class="md:w-3/4">
                            <!-- Content for each tab will be rendered here by JS -->
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <!-- Timesheet Page -->
        <div id="timesheet" class="page">
             <section class="py-12">
                <div class="container mx-auto px-6">
                    <div class="flex flex-col md:flex-row justify-between md:items-center mb-4 gap-4">
                        <h2 class="text-2xl font-bold text-white">Work Area</h2>
                        <div class="flex gap-4 items-center">
                            <button id="enter-punch-btn" class="secondary-button px-4 py-2 rounded-lg text-sm">Enter Punch</button>
                        </div>
                    </div>
                    
                    <div id="employee-details-container" class="card p-4 mb-8"></div>

                    <div class="card p-6">
                        <div class="flex justify-between items-center mb-4">
                            <button id="prev-week-btn" class="secondary-button p-2 rounded-full"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg></button>
                            <div id="timesheet-filter-container" class="flex gap-4 items-center">
                                <h3 id="week-range-display" class="text-xl font-semibold text-white text-center"></h3>
                            </div>
                            <button id="next-week-btn" class="secondary-button p-2 rounded-full"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg></button>
                        </div>
                        <div id="spreadsheet-container" class="overflow-x-auto"></div>
                    </div>
                    <div id="verification-section" class="mt-8 card p-6"></div>
                </div>
            </section>
        </div>

        <!-- Pay Stub Viewer Modal -->
        <div id="pay-stub-modal" class="fixed inset-0 z-50 modal-overlay items-center justify-center hidden" role="dialog" aria-modal="true">
            <div class="card rounded-lg shadow-xl m-4 max-w-4xl w-full max-h-[90vh] flex flex-col">
                <div class="p-4 border-b border-gray-700 flex justify-between items-center">
                    <h3 class="text-xl font-semibold text-white">Pay Stub</h3>
                    <button class="text-gray-400 hover:text-white text-3xl close-modal-btn" aria-label="Close">&times;</button>
                </div>
                <div id="pay-stub-content" class="p-8 overflow-y-auto bg-white text-gray-800">
                    <!-- Dynamic pay stub content will be rendered here -->
                </div>
                 <div class="p-4 border-t border-gray-700 flex justify-end">
                    <button id="print-pay-stub-btn" class="cta-button px-4 py-2 rounded-lg">Print</button>
                </div>
            </div>
        </div>
    </main>

    <!-- Modals -->
    <div id="request-time-off-modal" class="fixed inset-0 z-50 modal-overlay items-center justify-center hidden" role="dialog" aria-modal="true" aria-labelledby="request-time-off-modal-title-text">
        <div class="card rounded-lg shadow-xl m-8 max-w-lg w-full">
            <div class="p-6 border-b border-gray-700 flex justify-between items-center">
                <h3 id="request-time-off-modal-title-text" class="text-xl font-semibold text-white">Request Time Off</h3>
                <button class="text-gray-400 hover:text-white text-3xl close-modal-btn" aria-label="Close">&times;</button>
            </div>
            <form id="request-time-off-form" class="p-6 space-y-4"></form>
        </div>
    </div>
    <div id="create-task-modal" class="fixed inset-0 z-50 modal-overlay items-center justify-center hidden" role="dialog" aria-modal="true" aria-labelledby="create-task-modal-title-text">
        <div class="card rounded-lg shadow-xl m-8 max-w-lg w-full">
            <div class="p-6 border-b border-gray-700 flex justify-between items-center">
                <h3 id="create-task-modal-title-text" class="text-xl font-semibold text-white">Create New Task</h3>
                <button class="text-gray-400 hover:text-white text-3xl close-modal-btn" aria-label="Close">&times;</button>
            </div>
            <form id="create-task-form" class="p-6 space-y-4"></form>
        </div>
    </div>
    <div id="add-shift-modal" class="fixed inset-0 z-50 modal-overlay items-center justify-center hidden" role="dialog" aria-modal="true" aria-labelledby="add-shift-modal-title-text">
        <div class="card rounded-lg shadow-xl m-8 max-w-lg w-full">
            <div class="p-6 border-b border-gray-700 flex justify-between items-center">
                <h3 id="add-shift-modal-title-text" class="text-xl font-semibold text-white">Add Shift</h3>
                <button class="text-gray-400 hover:text-white text-3xl close-modal-btn" aria-label="Close">&times;</button>
            </div>
            <form id="add-shift-form" class="p-6 space-y-4"></form>
        </div>
    </div>
    <div id="punch-modal" class="fixed inset-0 z-50 modal-overlay items-center justify-center hidden" role="dialog" aria-modal="true" aria-labelledby="punch-modal-title-text">
        <div class="card rounded-lg shadow-xl m-8 max-w-2xl w-full">
            <div class="p-6 border-b border-gray-700 flex justify-between items-center">
                <h3 id="punch-modal-title-text" class="text-xl font-semibold text-white">Enter Punch</h3>
                <button id="close-punch-modal-button" class="text-gray-400 hover:text-white text-3xl" aria-label="Close">&times;</button>
            </div>
            <form id="add-punch-form" class="p-6 space-y-4"></form>
        </div>
    </div>
    <div id="add-employee-modal" class="fixed inset-0 z-50 modal-overlay items-center justify-center hidden" role="dialog" aria-modal="true" aria-labelledby="add-employee-modal-title-text">
        <div class="card rounded-lg shadow-xl m-8 max-w-3xl w-full">
            <div class="p-4 border-b border-gray-700 flex justify-between items-center">
                <h3 id="add-employee-modal-title-text" class="text-xl font-semibold text-white">Add New Employee</h3>
                <button class="text-gray-400 hover:text-white text-3xl close-modal-btn" aria-label="Close">&times;</button>
            </div>
            <form id="add-employee-form" class="p-4 md:p-6"></form>
        </div>
    </div>
    <div id="edit-employee-modal" class="fixed inset-0 z-50 modal-overlay items-center justify-center hidden" role="dialog" aria-modal="true" aria-labelledby="edit-employee-modal-title-text">
        <div class="card rounded-lg shadow-xl m-8 max-w-3xl w-full">
            <div class="p-4 border-b border-gray-700 flex justify-between items-center">
                <h3 id="edit-employee-modal-title-text" class="text-xl font-semibold text-white">Edit Employee</h3>
                <button class="text-gray-400 hover:text-white text-3xl close-modal-btn" aria-label="Close">&times;</button>
            </div>
            <form id="edit-employee-form" class="p-4 md:p-6"></form>
        </div>
    </div>
    <div id="project-modal" class="fixed inset-0 z-50 modal-overlay items-center justify-center hidden" role="dialog" aria-modal="true" aria-labelledby="project-modal-title-text">
        <div class="card rounded-lg shadow-xl m-8 max-w-lg w-full">
            <div class="p-6 border-b border-gray-700 flex justify-between items-center">
                <h3 id="project-modal-title-text" class="text-xl font-semibold text-white"></h3>
                <button class="text-gray-400 hover:text-white text-3xl close-modal-btn" aria-label="Close">&times;</button>
            </div>
            <form id="project-form" class="p-6 space-y-4"></form>
        </div>
    </div>
    <div id="confirmation-modal" class="fixed inset-0 z-50 modal-overlay items-center justify-center hidden" role="dialog" aria-modal="true" aria-labelledby="confirmation-modal-title-text">
        <div class="card rounded-lg shadow-xl m-8 max-w-md w-full">
             <div class="p-6 text-center">
                <h3 id="confirmation-modal-title" class="text-xl font-semibold text-white mb-2">Are you sure?</h3>
                <p id="confirmation-modal-message" class="text-gray-400 mb-6"></p>
                <div class="flex justify-center gap-4">
                    <button id="confirmation-cancel-btn" class="secondary-button px-6 py-2 rounded-lg">Cancel</button>
                    <button id="confirmation-confirm-btn" class="danger-button px-6 py-2 rounded-lg">Confirm</button>
                </div>
            </div>
        </div>
    </div>
    <div id="toast-container"></div>

    <script type="module">
        // Firebase Imports
        import { initializeApp, deleteApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut, createUserWithEmailAndPassword, sendPasswordResetEmail, updatePassword, reauthenticateWithCredential, EmailAuthProvider } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, query, where, getDocs, onSnapshot, setDoc, addDoc, updateDoc, deleteDoc, arrayUnion, arrayRemove, startAt, endAt, orderBy, writeBatch } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCKy_SqRUTKkoeuTzrksN2_TQ41v8Zs9Ls",
            authDomain: "nexustime-e8b91.firebaseapp.com",
            projectId: "nexustime-e8b91",
            storageBucket: "nexustime-e8b91.appspot.com",
            messagingSenderId: "516976739338",
            appId: "1:516976739338:web:537ae732707a2a1aab4bf3",
            measurementId: "G-QRSD6TYH86"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Global State
        let currentUser = null;
        let currentUserData = null;
        let currentWorkspaceId = null;
        let currentWorkspaceData = null;
        let employees = [];
        let projects = [];
        let tasks = [];
        let timeOffRequests = [];
        let payStubs = [];
        let timesheets = {};
        let schedules = [];
        let verificationData = {};
        let currentWeekOffset = 0;
        let activeEmployeeFilter = null;
        let editingDayData = null;
        let projectChart = null;
        let employeeChart = null;
        let editingItemId = null; // Used for both employee and project editing
        let selectedManageItem = null;
        let manageCurrentPage = 1;
        const MANAGE_ITEMS_PER_PAGE = 10;
        let employeeFilters = {};
        const PLAN_WORKSPACE_LIMITS = { Free: 1, Starter: 1, Pro: 3, Enterprise: Infinity };
        const PLAN_USER_LIMITS = { Free: 5, Starter: Infinity, Pro: Infinity, Enterprise: Infinity };
        const PLAN_PROJECT_LIMITS = { Free: 3, Starter: Infinity, Pro: Infinity, Enterprise: Infinity };
        const PLAN_HIERARCHY = { Free: 0, Starter: 1, Pro: 2, Enterprise: 3 };
        let calendarDate = new Date();
        
        // DOM Elements
        const pages = document.querySelectorAll('.page');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const workspaceListContainer = document.getElementById('workspace-list');
        const planStatCard = document.getElementById('plan-stat-card');
        const dashboardTitle = document.getElementById('dashboard-title');
        const dashboardWidgets = document.getElementById('dashboard-widgets');
        const timesheetTableBody = document.getElementById('timesheet-table-body');
        const spreadsheetContainer = document.getElementById('spreadsheet-container');
        const weekRangeDisplay = document.getElementById('week-range-display');
        const prevWeekBtn = document.getElementById('prev-week-btn');
        const nextWeekBtn = document.getElementById('next-week-btn');
        const employeeDetailsContainer = document.getElementById('employee-details-container');
        const manageTabs = document.getElementById('manage-tabs');
        const manageContent = document.getElementById('manage-content');
        const manageSidebar = document.getElementById('manage-sidebar');
        const employeeFilterBar = document.getElementById('employee-filter-bar');
        const addNewButton = document.getElementById('add-new-button');
        const punchModal = document.getElementById('punch-modal');
        const closePunchModalButton = document.getElementById('close-punch-modal-button');
        const addPunchForm = document.getElementById('add-punch-form');
        const addEmployeeModal = document.getElementById('add-employee-modal');
        const editEmployeeModal = document.getElementById('edit-employee-modal');
        const projectModal = document.getElementById('project-modal');
        const addShiftModal = document.getElementById('add-shift-modal');
        const createTaskModal = document.getElementById('create-task-modal');
        const requestTimeOffModal = document.getElementById('request-time-off-modal');
        const addShiftForm = document.getElementById('add-shift-form');
        const createTaskForm = document.getElementById('create-task-form');
        const requestTimeOffForm = document.getElementById('request-time-off-form');
        const addEmployeeForm = document.getElementById('add-employee-form');
        const editEmployeeForm = document.getElementById('edit-employee-form');
        const projectForm = document.getElementById('project-form');
        const toastContainer = document.getElementById('toast-container');
        const onboardingContainer = document.getElementById('onboarding-container');
        const settingsNav = document.getElementById('settings-nav');
        const settingsContentArea = document.getElementById('settings-content-area');
        
        // --- Core App Logic ---

        const checkPlanPermission = (requiredPlan) => {
            if (!currentWorkspaceData || !currentWorkspaceData.plan) return false;
            const currentPlanLevel = PLAN_HIERARCHY[currentWorkspaceData.plan] ?? -1;
            const requiredPlanLevel = PLAN_HIERARCHY[requiredPlan] ?? 99;
            return currentPlanLevel >= requiredPlanLevel;
        };

        const showPage = (pageId) => {
            pages.forEach(page => page.classList.remove('active'));
            const targetPage = document.getElementById(pageId);
            if (targetPage) {
                targetPage.classList.add('active');
                window.location.hash = pageId;

                // Update active nav link
                document.querySelectorAll('.nav-link').forEach(link => {
                    link.classList.toggle('active', link.dataset.page === pageId);
                });
            }
        };

        const updateNav = () => {
            const navContainerDesktop = document.getElementById('app-nav-desktop');
            const navContainerMobile = document.getElementById('app-nav-mobile');
            const mobileMenu = document.getElementById('mobile-menu');
            const mobileMenuButton = document.getElementById('mobile-menu-button');
            const logoutButtonDesktop = document.getElementById('logout-button-desktop');
            const logoutButtonMobile = document.getElementById('logout-button-mobile');
            
            if (currentUser) {
                mobileMenuButton.style.display = 'inline-flex';
                logoutButtonDesktop.style.display = 'inline-flex';

                let navLinks = [
                    { page: 'dashboard', label: 'Dashboard', icon: '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" /></svg>' },
                    { page: 'timesheet', label: 'Timesheets', icon: '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" /></svg>' },
                    { page: 'schedule', label: 'Schedule', icon: '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" /></svg>', requiredPlan: 'Pro' },
                    { page: 'time-off', label: 'Time Off', icon: '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd" /></svg>', requiredPlan: 'Pro' },
                    { page: 'pay-stubs', label: 'Pay Stubs', icon: '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M4 4a2 2 0 00-2 2v1h16V6a2 2 0 00-2-2H4z" /><path fill-rule="evenodd" d="M18 9H2v5a2 2 0 002 2h12a2 2 0 002-2V9zM4 13a1 1 0 011-1h1a1 1 0 110 2H5a1 1 0 01-1-1zm3 0a1 1 0 011-1h1a1 1 0 110 2H8a1 1 0 01-1-1zm3 0a1 1 0 011-1h1a1 1 0 110 2h-1a1 1 0 01-1-1z" clip-rule="evenodd" /></svg>', requiredPlan: 'Enterprise' },
                    { page: 'tasks', label: 'Tasks', icon: '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd" /></svg>', requiredPlan: 'Pro' },
                    { page: 'manage', label: 'Manage', icon: '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z" /></svg>' },
                    { page: 'settings', label: 'Settings', icon: '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd" /></svg>' },
                    { page: 'company-selection', label: 'Switch Workspace', icon: '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 2a.75.75 0 01.75.75v3.5a.75.75 0 01-1.5 0v-3.5A.75.75 0 0110 2zM5.404 4.343a.75.75 0 010 1.06l-1.47 1.47a.75.75 0 11-1.06-1.06l1.47-1.47a.75.75 0 011.06 0zm9.192 0a.75.75 0 011.06 0l1.47 1.47a.75.75 0 11-1.06 1.06l-1.47-1.47a.75.75 0 010-1.06zM10 4a6 6 0 100 12 6 6 0 000-12zM10 16a4 4 0 100-8 4 4 0 000 8z" clip-rule="evenodd" /></svg>' },
                ];

                const visibleNavLinks = navLinks.filter(link => !link.requiredPlan || checkPlanPermission(link.requiredPlan));
                
                const linksHtml = visibleNavLinks.map(link => `
                    <a href="#${link.page}" data-page="${link.page}" class="nav-link text-gray-300 hover:text-white">
                        ${link.icon}
                        <span>${link.label}</span>
                    </a>
                `).join('');

                navContainerDesktop.innerHTML = linksHtml;
                navContainerMobile.innerHTML = linksHtml;
                
                logoutButtonDesktop.addEventListener('click', () => signOut(auth));
                logoutButtonMobile.addEventListener('click', () => signOut(auth));

            } else {
                navContainerDesktop.innerHTML = '';
                navContainerMobile.innerHTML = '';
                mobileMenu.style.display = 'none';
                mobileMenuButton.style.display = 'none';
                logoutButtonDesktop.style.display = 'none';
            }
        };
        
        const showToast = (message, type = 'success') => {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            toastContainer.appendChild(toast);
            setTimeout(() => {
                toast.classList.add('show');
            }, 100);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }, 3000);
        };

        // --- Authentication ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                await loadUserData(user.uid);
                
                if (!currentUserData.workspaces || Object.keys(currentUserData.workspaces).length === 0) {
                    window.location.hash = 'onboarding';
                }

                if (currentWorkspaceId) {
                    await loadWorkspaceData(currentWorkspaceId);
                }
                
                updateNav();
                handleRouting(); 
            } else {
                currentUser = null;
                currentUserData = null;
                currentWorkspaceId = null;
                showPage('login');
                updateNav();
            }
            document.getElementById('loading').classList.remove('active');
        });

        async function loadUserData(uid) {
            const userDocRef = doc(db, "users", uid);
            const userDocSnap = await getDoc(userDocRef);
            if (userDocSnap.exists()) {
                currentUserData = { id: userDocSnap.id, ...userDocSnap.data() };
                if (currentUserData.workspaces && Object.keys(currentUserData.workspaces).length > 0 && !currentUserData.activeWorkspaceId) {
                     const firstWorkspaceId = Object.keys(currentUserData.workspaces)[0];
                     currentUserData.activeWorkspaceId = firstWorkspaceId;
                     currentWorkspaceId = firstWorkspaceId;
                     await updateDoc(userDocRef, { activeWorkspaceId: firstWorkspaceId });
                } else {
                    currentWorkspaceId = currentUserData.activeWorkspaceId;
                }
            } else {
                console.log("No user document found. Creating one and directing to onboarding.");
                const newUserDoc = {
                    email: currentUser.email,
                    name: currentUser.displayName || currentUser.email.split('@')[0],
                    workspaces: {},
                    activeWorkspaceId: null,
                    plan: 'Free'
                };
                await setDoc(doc(db, "users", uid), newUserDoc);
                currentUserData = { id: uid, ...newUserDoc };
                currentWorkspaceId = null;
            }
        }

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            loginError.textContent = '';
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                loginError.textContent = `Login Failed: ${error.message}`;
                console.error("Login error:", error);
            }
        });

        // --- Routing ---
        function handleRouting() {
            const hash = window.location.hash.substring(1) || 'dashboard';
            if (!currentUser) {
                showPage('login');
                return;
            }
            if (!currentWorkspaceId && !['company-selection', 'onboarding'].includes(hash)) {
                showPage('company-selection');
                renderWorkspaceSelection();
                return;
            }
            
            const pageFunction = {
                'dashboard': renderDashboard,
                'timesheet': renderTimesheetPage,
                'schedule': renderSchedulePage,
                'time-off': renderTimeOffPage,
                'pay-stubs': renderPayStubsPage,
                'tasks': renderTasksPage,
                'manage': renderManagePage,
                'settings': renderSettingsPage,
                'company-selection': renderWorkspaceSelection,
                'onboarding': renderOnboardingPage
            }[hash];

            if (pageFunction) {
                showPage(hash);
                pageFunction();
            } else {
                showPage('dashboard');
                renderDashboard();
            }
        }
        
        window.addEventListener('hashchange', handleRouting);
        
        // --- Data Fetching & Rendering ---

        async function loadWorkspaceData(workspaceId) {
            if (!workspaceId) return;
            
            const wsDocRef = doc(db, "workspaces", workspaceId);
            const wsDocSnap = await getDoc(wsDocRef);
            
            if (wsDocSnap.exists()) {
                currentWorkspaceData = { id: wsDocSnap.id, ...wsDocSnap.data() };
            } else {
                console.error("Workspace not found!");
                currentWorkspaceId = null;
                showPage('company-selection');
                return;
            }

            // Fetch subcollections only if workspace exists
            const membersColRef = collection(db, "workspaces", workspaceId, "members");
            const projectsColRef = collection(db, "workspaces", workspaceId, "projects");
            const tasksColRef = collection(db, "workspaces", workspaceId, "tasks");
            const timeOffColRef = collection(db, "workspaces", workspaceId, "timeOffRequests");
            const payStubsColRef = collection(db, "workspaces", workspaceId, "payStubs");
            const timesheetsColRef = collection(db, "workspaces", workspaceId, "timeEntries");
            const verificationColRef = collection(db, "workspaces", workspaceId, "verifications");
            const schedulesColRef = collection(db, "workspaces", workspaceId, "schedules");


            const [membersSnapshot, projectsSnapshot, tasksSnapshot, timeOffSnapshot, payStubsSnapshot, timesheetsSnapshot, verificationSnapshot, schedulesSnapshot] = await Promise.all([
                getDocs(query(membersColRef)),
                getDocs(query(projectsColRef)),
                getDocs(query(tasksColRef)),
                getDocs(query(timeOffColRef)),
                getDocs(query(payStubsColRef, orderBy("payDate", "desc"))),
                getDocs(query(timesheetsColRef)),
                getDocs(query(verificationColRef)),
                getDocs(query(schedulesColRef))
            ]);

            employees = membersSnapshot.docs.map(d => ({ id: d.id, ...d.data() }));
            projects = projectsSnapshot.docs.map(d => ({ id: d.id, ...d.data() }));
            tasks = tasksSnapshot.docs.map(d => ({ id: d.id, ...d.data() }));
            timeOffRequests = timeOffSnapshot.docs.map(d => ({ id: d.id, ...d.data() }));
            payStubs = payStubsSnapshot.docs.map(d => ({ id: d.id, ...d.data() }));
            schedules = schedulesSnapshot.docs.map(d => ({ id: d.id, ...d.data() }));

            if (!activeEmployeeFilter && employees.length > 0) {
               activeEmployeeFilter = employees[0].id;
            }

            timesheets = {};
            timesheetsSnapshot.forEach(doc => {
                const entry = doc.data();
                const employeeId = entry.userId;
                const date = entry.date;
                if (!timesheets[employeeId]) timesheets[employeeId] = {};
                if (!timesheets[employeeId][date]) timesheets[employeeId][date] = { punches: [] };
                timesheets[employeeId][date].punches.push({ time: entry.time, mode: entry.mode, type: entry.type });
            });
            
            verificationData = {};
            verificationSnapshot.forEach(doc => {
                verificationData[doc.id] = doc.data();
            });
            updateNav(); // Re-run nav update after workspace data is loaded
        }

        async function renderWorkspaceSelection() {
            await loadUserData(currentUser.uid);
            
            await renderPlanStatCard();

            if (!currentUserData || !currentUserData.workspaces || Object.keys(currentUserData.workspaces).length === 0) {
                workspaceListContainer.innerHTML = '<p class="text-center text-gray-400">You are not a member of any workspaces.</p>';
            } else {
                workspaceListContainer.innerHTML = '<div class="loader"></div>';
                const workspaceIds = Object.keys(currentUserData.workspaces);
                const workspaceDocs = await Promise.all(workspaceIds.map(id => getDoc(doc(db, "workspaces", id))));
                
                workspaceListContainer.innerHTML = '';
                workspaceDocs.forEach(async (wsDoc) => {
                    if (wsDoc.exists()) {
                        const ws = {id: wsDoc.id, ...wsDoc.data()};
                        
                        const membersColRef = collection(db, "workspaces", ws.id, "members");
                        const projectsColRef = collection(db, "workspaces", ws.id, "projects");
                        const [membersSnapshot, projectsSnapshot] = await Promise.all([
                            getDocs(query(membersColRef)),
                            getDocs(query(projectsColRef))
                        ]);
                        const memberCount = membersSnapshot.size;
                        const projectCount = projectsSnapshot.size;

                        const card = document.createElement('div');
                        const isActive = ws.id === currentWorkspaceId;
                        card.className = `card workspace-card p-6 text-center hover:border-emerald-400 cursor-pointer relative flex flex-col justify-between ${isActive ? 'active-workspace' : ''}`;
                        card.innerHTML = `
                            <div>
                                ${isActive ? '<div class="absolute top-2 right-2 text-xs bg-emerald-500 text-white font-bold py-1 px-2 rounded-full">Active</div>' : ''}
                                <h3 class="text-xl font-bold text-white mb-2">${ws.name}</h3>
                                <p class="text-sm font-semibold text-emerald-400">${ws.plan || 'Free'} Plan</p>
                            </div>
                            <div class="mt-4 pt-4 border-t border-gray-700 text-sm text-gray-400">
                                <p>${memberCount} Members</p>
                                <p>${projectCount} Projects</p>
                            </div>
                        `;
                        card.addEventListener('click', async () => {
                            if (isActive) return;
                            currentWorkspaceId = ws.id;
                            await updateDoc(doc(db, "users", currentUser.uid), { activeWorkspaceId: ws.id });
                            window.location.hash = 'dashboard';
                        });
                        workspaceListContainer.appendChild(card);
                    }
                });
            }

            const userPlan = currentUserData.plan || 'Free';
            const workspaceLimit = PLAN_WORKSPACE_LIMITS[userPlan] || 1;
            const canCreateWorkspace = Object.keys(currentUserData.workspaces || {}).length < workspaceLimit;
            
            const createCard = document.createElement('div');
            createCard.className = `card p-8 text-center flex flex-col items-center justify-center border-2 border-dashed border-gray-600 min-h-[180px] ${canCreateWorkspace ? 'hover:border-emerald-400 cursor-pointer' : 'opacity-50 cursor-not-allowed'}`;
            createCard.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-gray-500 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg>
                <h3 class="text-xl font-bold text-white">Create New Workspace</h3>
                ${!canCreateWorkspace ? '<p class="text-sm text-gray-400 mt-2">Upgrade your plan to create more workspaces.</p>' : ''}
            `;
            if (canCreateWorkspace) {
                createCard.addEventListener('click', () => window.location.hash = 'onboarding');
            }
            workspaceListContainer.appendChild(createCard);
        }

        async function renderPlanStatCard() {
            const userPlan = currentUserData.plan || 'Free';
            const userLimit = PLAN_USER_LIMITS[userPlan] || 0;
            
            let totalActiveUsers = 0;
            const workspaceIds = Object.keys(currentUserData.workspaces || {});
            
            if (workspaceIds.length > 0) {
                const memberQueries = workspaceIds.map(id => getDocs(query(collection(db, `workspaces/${id}/members`), where("status", "==", "Active"))));
                const memberSnapshots = await Promise.all(memberQueries);
                totalActiveUsers = memberSnapshots.reduce((acc, snapshot) => acc + snapshot.size, 0);
            }

            planStatCard.innerHTML = `
                <h4 class="font-semibold text-white">${userPlan} Plan</h4>
                <p class="text-sm text-gray-400 mt-1">
                    Users: ${totalActiveUsers} / ${userLimit === Infinity ? 'Unlimited' : userLimit}
                </p>
                <div class="mt-4 space-y-2">
                    <a href="#manage" data-page="manage" class="block w-full text-center cta-button px-4 py-2 rounded-lg text-sm">Add Users</a>
                    <a href="#settings" data-page="settings" class="block w-full text-center secondary-button px-4 py-2 rounded-lg text-sm">Upgrade Plan</a>
                </div>
            `;
        }

        async function renderDashboard() {
            if (!currentWorkspaceId) return;
            dashboardTitle.textContent = `${currentWorkspaceData.name} Dashboard`;
            let totalHours = 0;
            let recentEntries = [];
            Object.entries(timesheets).forEach(([employeeId, days]) => {
                const employee = employees.find(e => e.id === employeeId);
                if (!employee) return;
                Object.entries(days).forEach(([date, dayData]) => {
                    const hours = calculateTotalHoursFromPairs(processDayPunches(employeeId, new Date(date + 'T00:00:00')).pairs);
                    totalHours += hours;
                    if(hours > 0) recentEntries.push({employeeName: employee.name, date, hours});
                });
            });
            dashboardWidgets.innerHTML = `<div class="card p-6"><h3 class="text-lg font-semibold text-gray-400">Total Employees</h3><p class="text-4xl font-bold text-white mt-2">${employees.length}</p></div><div class="card p-6"><h3 class="text-lg font-semibold text-gray-400">Total Projects</h3><p class="text-4xl font-bold text-white mt-2">${projects.length}</p></div><div class="card p-6"><h3 class="text-lg font-semibold text-gray-400">Total Hours This Period</h3><p class="text-4xl font-bold text-white mt-2">${totalHours.toFixed(1)}</p></div>`;
            timesheetTableBody.innerHTML = '';
             recentEntries.sort((a,b) => new Date(b.date) - new Date(a.date)).slice(0, 5).forEach(entry => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-700';
                row.innerHTML = `<td class="p-4">${entry.employeeName}</td><td class="p-4">${formatDate(new Date(entry.date + 'T00:00:00'))}</td><td class="p-4">${entry.hours.toFixed(2)}</td>`;
                timesheetTableBody.appendChild(row);
            });
            renderCharts();
        }
        
        function renderCharts() {
            const employeeData = {};
            employees.forEach(emp => {
                const empTimesheets = timesheets[emp.id] || {};
                employeeData[emp.name] = Object.values(empTimesheets).reduce((sum, day) => sum + calculateTotalHoursFromPairs(processDayPunches(emp.id, null, day.punches).pairs), 0);
            });
            if (employeeChart) employeeChart.destroy();
            const employeeChartCtx = document.getElementById('employee-chart');
            if(employeeChartCtx) employeeChart = new Chart(employeeChartCtx, { type: 'bar', data: { labels: Object.keys(employeeData), datasets: [{ label: 'Hours Logged', data: Object.values(employeeData), backgroundColor: '#34D399' }] }, options: { responsive: true, scales: { y: { beginAtZero: true, ticks: { color: '#9CA3AF' }, grid: { color: '#374151' } }, x: { ticks: { color: '#9CA3AF' }, grid: { display: false } } }, plugins: { legend: { display: false } } } });
            if (projectChart) projectChart.destroy();
        }

        async function renderTimesheetPage() {
            renderEmployeeFilter();
            renderEmployeeDetails();
            renderSpreadsheet();
        }

        function renderEmployeeFilter() {
            const container = document.getElementById('timesheet-filter-container');
            if (!container) return;
            let options = employees.map(e => `<option value="${e.id}" ${activeEmployeeFilter === e.id ? 'selected' : ''}>${e.name}</option>`).join('');
            container.innerHTML = `<h3 id="week-range-display" class="text-xl font-semibold text-white text-center"></h3><select id="employee-filter" class="form-select w-full md:w-64">${options}</select>`;
            document.getElementById('employee-filter').addEventListener('change', (e) => {
                activeEmployeeFilter = e.target.value;
                renderEmployeeDetails();
                renderSpreadsheet();
            });
        }
        
        function renderEmployeeDetails() {
            if (!employeeDetailsContainer) return;
            const employee = employees.find(e => e.id === activeEmployeeFilter);
            if (!employee) {
                employeeDetailsContainer.innerHTML = '<p>Select an employee to view details.</p>';
                return;
            };
            employeeDetailsContainer.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-4 gap-x-8 gap-y-2 text-sm">
                    <div><p class="text-2xl font-bold text-emerald-400">${employee.name}</p><p class="text-gray-400">Employee Id: ${employee.employeeId || 'N/A'} Status: <span class="text-white">${employee.status}</span></p></div>
                    <div><p><span class="text-gray-400">Hire Date:</span> ${employee.hireDate}</p><p><span class="text-gray-400">Card Number:</span> ${employee.cardNumber || 'N/A'}</p></div>
                    <div><p><span class="text-gray-400">Department:</span> ${employee.department}</p><p><span class="text-gray-400">Supervisor:</span> ${employee.supervisor || 'N/A'}</p></div>
                    <div><p><span class="text-gray-400">Pay Type:</span> ${employee.payType}</p><p><span class="text-gray-400">Employee Type:</span> ${employee.employeeType}</p></div>
                </div>`;
        }
        
        function renderSpreadsheet() {
            if (!spreadsheetContainer || !activeEmployeeFilter) return;
            const { week, start: weekStart } = getWeek(currentWeekOffset);
            document.getElementById('week-range-display').textContent = `Monday ${formatDate(week[0], true)} to Sunday ${formatDate(week[6], true)}`;
            const weekData = week.map(day => processDayPunches(activeEmployeeFilter, day));
            const maxRows = Math.max(1, ...weekData.map(d => d.pairs.length));
            let dailyTotals = weekData.map(d => d.totalHours);
            let weeklyTotal = dailyTotals.reduce((a, b) => a + b, 0);
            const weekStartDateString = weekStart.toISOString().split('T')[0];
            const verificationRecord = getWeekVerification(weekStartDateString);
            const isWeekLocked = verificationRecord.isLocked;
            let tableHtml = '<table class="w-full timesheet-table"><thead><tr><th class="row-header w-24">Date</th>';
            week.forEach((day) => {
                const dateString = day.toISOString().split('T')[0];
                tableHtml += `<th class="day-header ${!isWeekLocked ? 'editable' : 'locked-day'}" data-date="${dateString}" data-locked="${isWeekLocked}">
                                ${isWeekLocked ? '<span class="text-yellow-400 text-xs">Locked</span><br>' : ''}
                                ${day.toLocaleDateString('en-US', { weekday: 'short' })} ${day.getDate()}
                              </th>`;
            });
            tableHtml += '<th class="row-header">Total</th></tr></thead><tbody>';
            for(let i = 0; i < maxRows; i++) {
                tableHtml += '<tr><td class="row-header">In</td>';
                weekData.forEach(day => { tableHtml += `<td>${day.pairs[i]?.in || ''}</td>`; });
                tableHtml += '<td></td></tr>';
                tableHtml += '<tr><td class="row-header">Out</td>';
                weekData.forEach(day => { tableHtml += `<td>${day.pairs[i]?.out || ''}</td>`; });
                tableHtml += '<td></td></tr>';
            }
            tableHtml += '</tbody><tfoot><tr class="bg-gray-800 font-bold"><td class="row-header">Total Hours</td>';
            dailyTotals.forEach(total => { tableHtml += `<td>${total > 0 ? total.toFixed(2) : ''}</td>`; });
            tableHtml += `<td class="text-emerald-400">${weeklyTotal.toFixed(2)}</td></tr>`;
            tableHtml += '</tfoot></table>';
            spreadsheetContainer.innerHTML = tableHtml;
            
            if (checkPlanPermission('Starter')) {
                renderVerificationStatus(weekStartDateString);
            } else {
                const verificationSection = document.getElementById('verification-section');
                if (verificationSection) verificationSection.innerHTML = '';
            }
            
            document.querySelectorAll('.day-header.editable').forEach(th => th.addEventListener('click', (e) => openPunchModal(e.currentTarget.dataset.date)));
        }

        async function renderManagePage(activeTab = 'employees') {
            const payrollTabEl = manageTabs.querySelector('[data-tab="payroll"]');
            if (!checkPlanPermission('Enterprise')) {
                if(payrollTabEl) payrollTabEl.style.display = 'none';
                if (activeTab === 'payroll') activeTab = 'employees';
            } else {
                if(payrollTabEl) payrollTabEl.style.display = 'inline-block';
            }

            manageTabs.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
            const activeTabEl = manageTabs.querySelector(`[data-tab="${activeTab}"]`);
            if(activeTabEl) activeTabEl.classList.add('active');
            
            addNewButton.style.display = ['payroll', 'departments'].includes(activeTab) ? 'none' : 'inline-block';
            
            const plan = currentWorkspaceData.plan || 'Free';
            const userLimit = PLAN_USER_LIMITS[plan];
            const projectLimit = PLAN_PROJECT_LIMITS[plan];
            const canAddEmployees = plan !== 'Free' || employees.length < userLimit;
            const canAddProjects = plan !== 'Free' || projects.length < projectLimit;
            let isLimitReached = false;

            if (activeTab === 'employees') {
                addNewButton.innerHTML = `Add New Employee`;
                if (!canAddEmployees) isLimitReached = true;
            } else if (activeTab === 'projects') {
                addNewButton.innerHTML = `Add New Project`;
                if (!canAddProjects) isLimitReached = true;
            }
            
            addNewButton.disabled = isLimitReached;
            addNewButton.title = isLimitReached ? `Upgrade your plan to add more ${activeTab}.` : '';
            if (isLimitReached) {
                addNewButton.innerHTML += ` <span class="text-xs font-normal">(Plan Limit Reached)</span>`;
            }

            selectedManageItem = null;
            
            if (activeTab === 'employees') {
                employeeFilterBar.style.display = 'block';
                renderEmployeeFilterBar();
                renderManageEmployees();
                renderManageSidebar();
            } else if (activeTab === 'projects') {
                employeeFilterBar.style.display = 'none';
                renderManageProjects();
                renderManageSidebar();
            } else if (activeTab === 'payroll') {
                employeeFilterBar.style.display = 'none';
                renderManagePayroll();
            } else if (activeTab === 'departments') {
                employeeFilterBar.style.display = 'none';
                renderManageDepartments();
            }
        }

        function renderEmployeeFilterBar() {
            const ws = currentWorkspaceData;
            const departmentOptions = (ws.departments || []).map(d => `<option value="${d}">${d}</option>`).join('');
            const payTypeOptions = (ws.payTypes || []).map(p => `<option value="${p}">${p}</option>`).join('');
            const employeeTypeOptions = (ws.employeeTypes || []).map(e => `<option value="${e}">${e}</option>`).join('');

            employeeFilterBar.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-5 gap-4 card p-4">
                    <input type="text" id="name-filter" class="form-input" placeholder="Search by Name/Email...">
                    <select id="department-filter" class="form-select"><option value="">All Departments</option>${departmentOptions}</select>
                    <select id="payType-filter" class="form-select"><option value="">All Pay Types</option>${payTypeOptions}</select>
                    <select id="employeeType-filter" class="form-select"><option value="">All Employee Types</option>${employeeTypeOptions}</select>
                    <select id="status-filter" class="form-select"><option value="">All Statuses</option><option value="Active">Active</option><option value="Inactive">Inactive</option></select>
                </div>
            `;

            ['name-filter', 'department-filter', 'payType-filter', 'employeeType-filter', 'status-filter'].forEach(id => {
                document.getElementById(id).addEventListener('input', () => {
                    employeeFilters[id.replace('-filter', '')] = document.getElementById(id).value;
                    manageCurrentPage = 1; // Reset to first page on filter change
                    renderManageEmployees();
                });
            });
        }

        function filterEmployees() {
            return employees.filter(emp => {
                const nameMatch = !employeeFilters.name || emp.name.toLowerCase().includes(employeeFilters.name.toLowerCase()) || (emp.email && emp.email.toLowerCase().includes(employeeFilters.name.toLowerCase()));
                const departmentMatch = !employeeFilters.department || emp.department === employeeFilters.department;
                const payTypeMatch = !employeeFilters.payType || emp.payType === employeeFilters.payType;
                const employeeTypeMatch = !employeeFilters.employeeType || emp.employeeType === employeeFilters.employeeType;
                const statusMatch = !employeeFilters.status || emp.status === employeeFilters.status;
                return nameMatch && departmentMatch && payTypeMatch && employeeTypeMatch && statusMatch;
            });
        }

        function renderManageEmployees() {
            const filteredEmployees = filterEmployees();
            const startIndex = (manageCurrentPage - 1) * MANAGE_ITEMS_PER_PAGE;
            const endIndex = startIndex + MANAGE_ITEMS_PER_PAGE;
            const paginatedEmployees = filteredEmployees.slice(startIndex, endIndex);

            let listHtml = paginatedEmployees.map((item) => `
                <li class="flex justify-between items-center p-3 rounded-lg manage-list-item" data-id="${item.id}" data-type="employee">
                    <div>
                        <p class="font-semibold">${item.name}</p>
                        <p class="text-sm text-gray-400">${item.email || 'No Email'}</p>
                    </div>
                    <span class="status-badge ${item.status === 'Active' ? 'status-active' : 'status-inactive'}">${item.status}</span>
                </li>`).join('');

            const totalPages = Math.ceil(filteredEmployees.length / MANAGE_ITEMS_PER_PAGE);
            let paginationHtml = totalPages > 1 ? `
                <div class="flex justify-between items-center mt-4">
                    <button id="manage-prev-btn" class="secondary-button px-4 py-2 rounded-lg text-sm" ${manageCurrentPage === 1 ? 'disabled' : ''}>Previous</button>
                    <span>Page ${manageCurrentPage} of ${totalPages}</span>
                    <button id="manage-next-btn" class="secondary-button px-4 py-2 rounded-lg text-sm" ${manageCurrentPage >= totalPages ? 'disabled' : ''}>Next</button>
                </div>
            ` : '';

            manageContent.innerHTML = `<div class="card p-6"><ul class="space-y-2">${listHtml}</ul>${paginationHtml}</div>`;
            
            document.querySelectorAll('.manage-list-item').forEach(item => item.addEventListener('click', (e) => {
                const id = e.currentTarget.dataset.id;
                const type = e.currentTarget.dataset.type;
                selectedManageItem = { type, data: employees.find(emp => emp.id === id) };
                
                document.querySelectorAll('.manage-list-item').forEach(i => i.classList.remove('selected'));
                e.currentTarget.classList.add('selected');

                renderManageSidebar();
            }));

            const prevBtn = document.getElementById('manage-prev-btn');
            const nextBtn = document.getElementById('manage-next-btn');
            if (prevBtn) prevBtn.addEventListener('click', () => { if(manageCurrentPage > 1) { manageCurrentPage--; renderManageEmployees(); } });
            if (nextBtn) nextBtn.addEventListener('click', () => { if(manageCurrentPage < totalPages) { manageCurrentPage++; renderManageEmployees(); } });
        }

        function renderManageProjects() {
            let listHtml = projects.map((item) => `
                <li class="flex justify-between items-center p-3 rounded-lg manage-list-item" data-id="${item.id}" data-type="project">
                    <span>${item.name}</span>
                </li>`).join('');
            manageContent.innerHTML = `<div class="card p-6"><ul class="space-y-2">${listHtml}</ul></div>`;

            document.querySelectorAll('.manage-list-item').forEach(item => item.addEventListener('click', (e) => {
                const id = e.currentTarget.dataset.id;
                const type = e.currentTarget.dataset.type;
                selectedManageItem = { type, data: projects.find(p => p.id === id) };

                document.querySelectorAll('.manage-list-item').forEach(i => i.classList.remove('selected'));
                e.currentTarget.classList.add('selected');

                renderManageSidebar();
            }));
        }

        function renderManageSidebar() {
            if (!selectedManageItem) {
                manageSidebar.innerHTML = '<p class="text-gray-400">Select an item from the list to see details.</p>';
                return;
            }

            if (selectedManageItem.type === 'employee') {
                const emp = selectedManageItem.data;
                manageSidebar.innerHTML = `
                    <h3 class="text-xl font-bold text-white mb-4">${emp.name}</h3>
                    <div class="space-y-2 text-sm">
                        <p><strong class="text-gray-400">Email:</strong> ${emp.email || 'N/A'}</p>
                        <p><strong class="text-gray-400">Role:</strong> ${emp.role || 'N/A'}</p>
                        <p><strong class="text-gray-400">Status:</strong> ${emp.status}</p>
                        <p><strong class="text-gray-400">Employee ID:</strong> ${emp.employeeId || 'N/A'}</p>
                        <p><strong class="text-gray-400">Hourly Rate:</strong> $${(emp.hourlyRate || 0).toFixed(2)}</p>
                        <p><strong class="text-gray-400">Department:</strong> ${emp.department || 'N/A'}</p>
                        <p><strong class="text-gray-400">Pay Type:</strong> ${emp.payType || 'N/A'}</p>
                        <p><strong class="text-gray-400">Employee Type:</strong> ${emp.employeeType || 'N/A'}</p>
                        <p><strong class="text-gray-400">Supervisor:</strong> ${emp.supervisor || 'N/A'}</p>
                        <p><strong class="text-gray-400">Hire Date:</strong> ${emp.hireDate || 'N/A'}</p>
                    </div>
                    <div class="mt-6 space-y-2">
                        <button class="w-full secondary-button px-4 py-2 rounded-lg text-sm edit-employee-btn" data-id="${emp.id}">Edit</button>
                        <button class="w-full secondary-button px-4 py-2 rounded-lg text-sm send-password-reset-btn" data-email="${emp.email}">Send Password Reset</button>
                        <button class="w-full danger-button mt-4 px-4 py-2 rounded-lg text-sm remove-employee-btn" data-id="${emp.id}">Remove</button>
                    </div>
                `;
                manageSidebar.querySelector('.edit-employee-btn').addEventListener('click', (e) => openEditEmployeeModal(e.target.dataset.id));
                manageSidebar.querySelector('.remove-employee-btn').addEventListener('click', (e) => handleRemoveEmployee(e.target.dataset.id));
                manageSidebar.querySelector('.send-password-reset-btn').addEventListener('click', (e) => handleSendPasswordReset(e.target.dataset.email));

            } else if (selectedManageItem.type === 'project') {
                const proj = selectedManageItem.data;
                let customFieldsHtml = '';
                const customFields = currentWorkspaceData.projectCustomFields || [];
                customFields.forEach(field => {
                    customFieldsHtml += `<p><strong class="text-gray-400">${field}:</strong> ${proj[field] || 'N/A'}</p>`;
                });

                manageSidebar.innerHTML = `
                    <h3 class="text-xl font-bold text-white mb-4">${proj.name}</h3>
                    <div class="space-y-2 text-sm">
                        ${customFieldsHtml}
                    </div>
                    <div class="mt-6 space-x-2">
                        <button class="secondary-button px-4 py-2 rounded-lg text-sm edit-project-btn" data-id="${proj.id}">Edit</button>
                        <button class="danger-button px-4 py-2 rounded-lg text-sm remove-project-btn" data-id="${proj.id}">Remove</button>
                    </div>
                `;
                manageSidebar.querySelector('.edit-project-btn').addEventListener('click', (e) => openProjectModal(e.target.dataset.id));
                manageSidebar.querySelector('.remove-project-btn').addEventListener('click', (e) => handleRemoveProject(e.target.dataset.id));
            }
        }

        // --- Helper Functions (Dates, Calculations, etc.) ---
        
        /**
         * Calculates estimated taxes based on gross pay.
         * NOTE: This is a simplified model for demonstration purposes only.
         * A real-world application must use a dedicated payroll tax API.
         * @param {number} grossPay The gross pay for the period.
         * @param {string} filingStatus 'single' or 'married'.
         * @param {number} allowances The number of allowances claimed.
         * @returns {object} An object containing the tax breakdown.
         */
        function calculateTaxes(grossPay, filingStatus = 'single', allowances = 0) {
            // FICA Taxes (Social Security & Medicare)
            const socialSecurityRate = 0.062;
            const medicareRate = 0.0145;
            
            // NOTE: In a real system, there's a wage base limit for Social Security. Ignored for simplicity.
            const socialSecurity = grossPay * socialSecurityRate;
            const medicare = grossPay * medicareRate;

            // Simplified Federal Income Tax Calculation
            // Using 2024 tax brackets and a very simplified standard deduction model.
            // This is NOT accurate for real payroll but demonstrates the concept.
            const annualGross = grossPay * 26; // Assuming bi-weekly pay period for annualization
            const singleBrackets = {
                0: 0.10, 11600: 0.12, 47150: 0.22, 100525: 0.24, 191950: 0.32, 243725: 0.35, 609350: 0.37
            };
            const marriedBrackets = {
                0: 0.10, 23200: 0.12, 94300: 0.22, 201050: 0.24, 383900: 0.32, 487450: 0.35, 731100: 0.37
            };
            
            const brackets = (filingStatus === 'married') ? marriedBrackets : singleBrackets;
            let taxableIncome = annualGross; // In a real system, subtract pre-tax deductions here.
            let annualFederalTax = 0;
            let remainingIncome = taxableIncome;
            
            const sortedBrackets = Object.keys(brackets).map(Number).sort((a,b) => b-a);
            
            for (const bracketStart of sortedBrackets) {
                if (remainingIncome > bracketStart) {
                    const incomeInBracket = remainingIncome - bracketStart;
                    annualFederalTax += incomeInBracket * brackets[bracketStart];
                    remainingIncome = bracketStart;
                }
            }

            const federal = annualFederalTax / 26; // De-annualize for the pay period

            const total = socialSecurity + medicare + (federal > 0 ? federal : 0);

            return {
                federal: federal > 0 ? federal : 0,
                socialSecurity,
                medicare,
                total
            };
        }
        
        function processDayPunches(employeeId, day, punchesOverride = null) {
            const dateString = day ? day.toISOString().split('T')[0] : null;
            const entry = employeeId && dateString ? timesheets[employeeId]?.[dateString] : null;
            const punches = punchesOverride || (entry ? entry.punches : []);
            if (!punches || punches.length === 0) return { pairs: [], totalHours: 0 };
            const sortedPunches = [...punches].sort((a,b) => a.time.localeCompare(b.time));
            const pairs = [];
            let openIn = null;

            for (const punch of sortedPunches) {
                if (punch.mode === 'in') {
                    if (openIn) {
                        // We have a dangling "in" punch. Close it without an "out".
                        pairs.push({ in: openIn, out: '' });
                    }
                    openIn = punch.time;
                } else if (punch.mode === 'out') {
                    if (openIn) {
                        // Found a pair
                        pairs.push({ in: openIn, out: punch.time });
                        openIn = null;
                    } else {
                        // This is a dangling "out" punch. We can ignore it or handle it.
                        // For now, let's ignore it as it doesn't make sense without an "in".
                    }
                }
            }

            // If the loop ends and there's still an open "in" punch
            if (openIn) {
                pairs.push({ in: openIn, out: '' });
            }
            
            const totalHours = calculateTotalHoursFromPairs(pairs);
            return { pairs, totalHours };
        }
        
        function calculateTotalHoursFromPairs(pairs) {
            let totalMinutes = 0;
            pairs.forEach(pair => {
                if (pair.in && pair.out) {
                    const [inH, inM] = pair.in.split(':').map(Number);
                    const [outH, outM] = pair.out.split(':').map(Number);
                    totalMinutes += (outH * 60 + outM) - (inH * 60 + inM);
                }
            });
            return totalMinutes / 60;
        }

        function getWeek(offset = 0) {
            const now = new Date();
            now.setDate(now.getDate() + (offset * 7));
            const dayOfWeek = now.getDay();
            const startDate = new Date(now);
            startDate.setDate(now.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));
            const week = Array.from({length: 7}, (_, i) => {
                const day = new Date(startDate);
                day.setDate(startDate.getDate() + i);
                return day;
            });
            return { week, start: week[0] };
        }

        function formatDate(date, includeYear = false) {
            if(!date) return '';
            const options = { month: 'short', day: 'numeric' };
            if (includeYear) options.year = 'numeric';
            return date.toLocaleDateString('en-US', options);
        }

        // --- Event Listeners & Handlers ---
        
        function setupEventListeners() {
            document.getElementById('mobile-menu-button').addEventListener('click', () => {
                const menu = document.getElementById('mobile-menu');
                menu.classList.toggle('hidden');
            });
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    window.location.hash = e.currentTarget.dataset.page;
                });
            });
            manageTabs.addEventListener('click', (e) => { if(e.target.dataset.tab) renderManagePage(e.target.dataset.tab); });
            addNewButton.addEventListener('click', handleAddNew);
            document.querySelectorAll('.close-modal-btn').forEach(btn => btn.addEventListener('click', closeAllModals));
            addEmployeeForm.addEventListener('submit', handleAddEmployee);
            editEmployeeForm.addEventListener('submit', handleEditEmployee);
            projectForm.addEventListener('submit', handleProjectFormSubmit);
            createTaskForm.addEventListener('submit', handleCreateTask);
            requestTimeOffForm.addEventListener('submit', handleRequestTimeOff);
            addShiftForm.addEventListener('submit', handleAddShift);
            document.getElementById('enter-punch-btn')?.addEventListener('click', () => openPunchModal());
            document.getElementById('prev-week-btn')?.addEventListener('click', () => { currentWeekOffset--; renderTimesheetPage(); });
            document.getElementById('next-week-btn')?.addEventListener('click', () => { currentWeekOffset++; renderTimesheetPage(); });
            closePunchModalButton?.addEventListener('click', closePunchModal);
            addPunchForm?.addEventListener('submit', handleAddPunch);
        }
        
        // --- Modals and Forms Logic ---
        
        function openPunchModal(date = null) {
            const employee = employees.find(e => e.id === activeEmployeeFilter);
            if (!employee) return;
            
            const now = new Date();
            const today = now.toISOString().split('T')[0];
            const currentTime = now.toTimeString().slice(0,5);

            const taskOptions = projects.map(p => `<option value="${p.name}">${p.name}</option>`).join('');

            addPunchForm.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-300 mb-2">Date</label>
                        <input type="date" name="punchDate" class="w-full p-3 form-input" value="${date || today}" required>
                    </div>
                    <div>
                        <label class="block text-gray-300 mb-2">Time</label>
                        <input type="time" name="punchTime" class="w-full p-3 form-input" value="${currentTime}" required>
                    </div>
                </div>
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-300 mb-2">Mode</label>
                        <select name="punchMode" class="w-full p-3 form-select" required>
                            <option value="in">Clock In</option>
                            <option value="out">Clock Out</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-300 mb-2">Type</label>
                        <select name="punchType" class="w-full p-3 form-select" required>
                            <option value="Normal">Normal</option>
                            <option value="Break">Break</option>
                            <option value="Lunch">Lunch</option>
                        </select>
                    </div>
                </div>
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-300 mb-2">Department</label>
                        <input type="text" name="punchDepartment" class="w-full p-3 form-input" value="${employee.department || ''}" disabled>
                    </div>
                    <div>
                        <label class="block text-gray-300 mb-2">Job</label>
                        <input type="text" name="punchJob" class="w-full p-3 form-input" value="${employee.employeeType || ''}" disabled>
                    </div>
                </div>
                <div>
                    <label class="block text-gray-300 mb-2">Task</label>
                    <select name="punchTask" class="w-full p-3 form-select">${taskOptions}</select>
                </div>
                <div>
                    <label class="block text-gray-300 mb-2">Notes</label>
                    <textarea name="punchNotes" class="w-full p-3 form-input" rows="3" maxlength="150"></textarea>
                </div>
                <div class="flex items-center space-x-6">
                    <label class="flex items-center"><input type="checkbox" name="doNotRound" class="h-4 w-4 rounded bg-gray-700 border-gray-600 text-emerald-500 focus:ring-emerald-500"><span class="ml-2">Do Not Round</span></label>
                    <label class="flex items-center"><input type="checkbox" name="transfer" class="h-4 w-4 rounded bg-gray-700 border-gray-600 text-emerald-500 focus:ring-emerald-500"><span class="ml-2">Transfer</span></label>
                    <label class="flex items-center"><input type="checkbox" name="override" class="h-4 w-4 rounded bg-gray-700 border-gray-600 text-emerald-500 focus:ring-emerald-500"><span class="ml-2">Override</span></label>
                </div>
                <div class="text-right pt-4">
                    <button type="submit" class="cta-button px-6 py-2 rounded-lg">Add Punch</button>
                </div>
            `;

            punchModal.style.display = 'flex';
        }

        function closePunchModal() { punchModal.style.display = 'none'; }
        function closeAllModals() {
            addEmployeeModal.style.display = 'none';
            editEmployeeModal.style.display = 'none';
            projectModal.style.display = 'none';
            addShiftModal.style.display = 'none';
            createTaskModal.style.display = 'none';
            requestTimeOffModal.style.display = 'none';
            document.getElementById('confirmation-modal').style.display = 'none';
            document.getElementById('pay-stub-modal').style.display = 'none';
        }
        
        async function handleAddPunch(e) {
            e.preventDefault();
            const form = e.target;
            const employee = employees.find(emp => emp.id === activeEmployeeFilter);
            if (!employee) {
                showToast('Could not find the selected employee.', 'error');
                return;
            }

            const punchData = {
                userId: activeEmployeeFilter,
                date: form.punchDate.value,
                time: form.punchTime.value,
                mode: form.punchMode.value,
                type: form.punchType.value,
                department: employee.department || '', // FIX: Fallback to empty string
                job: employee.employeeType || '', // FIX: Fallback to empty string
                task: form.punchTask.value,
                notes: form.punchNotes.value,
                doNotRound: form.doNotRound.checked,
                transfer: form.transfer.checked,
                override: form.override.checked,
                createdAt: new Date()
            };
            
            await addDoc(collection(db, "workspaces", currentWorkspaceId, "timeEntries"), punchData);
            
            showToast('Punch added successfully!', 'success');
            closePunchModal();
            await loadWorkspaceData(currentWorkspaceId);
            renderSpreadsheet();
        }

        function getWeekVerification(weekStartDateString) {
            const docId = `${activeEmployeeFilter}_${weekStartDateString}`;
            const data = verificationData[docId] || { employeeVerified: false, supervisorVerified: false };
            data.isLocked = data.employeeVerified && data.supervisorVerified;
            return data;
        }

        function renderVerificationStatus(weekStartDateString) {
            const verificationSection = document.getElementById('verification-section');
            if (!verificationSection) return;
            const verificationRecord = getWeekVerification(weekStartDateString);
            const employee = employees.find(e => e.id === activeEmployeeFilter);
            const supervisor = employees.find(e => e.id === employee.supervisorId) || { name: 'Supervisor' };
            verificationSection.innerHTML = `
                <h3 class="text-xl font-bold mb-4">Verification</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div>
                        <label class="flex items-center"><input type="checkbox" id="employee-verify-checkbox" class="h-5 w-5 rounded bg-gray-700 border-gray-600 text-emerald-500 focus:ring-emerald-500" ${verificationRecord.employeeVerified ? 'checked' : ''} ${verificationRecord.supervisorVerified ? 'disabled' : ''}><span class="ml-3">Employee Verification</span></label>
                        <div class="text-sm text-gray-400 pl-8">${verificationRecord.employeeVerified ? `Verified by ${employee.name} on ${new Date(verificationRecord.employeeVerificationTimestamp?.toDate()).toLocaleString()}` : 'Pending'}</div>
                    </div>
                    <div>
                        <label class="flex items-center"><input type="checkbox" id="supervisor-verify-checkbox" class="h-5 w-5 rounded bg-gray-700 border-gray-600 text-emerald-500 focus:ring-emerald-500" ${verificationRecord.supervisorVerified ? 'checked' : ''} ${!verificationRecord.employeeVerified ? 'disabled' : ''}><span class="ml-3">Supervisor Verification</span></label>
                        <div class="text-sm text-gray-400 pl-8">${verificationRecord.supervisorVerified ? `Verified by ${supervisor.name} on ${new Date(verificationRecord.supervisorVerificationTimestamp?.toDate()).toLocaleString()}` : 'Pending'}</div>
                    </div>
                </div>`;
            document.getElementById('employee-verify-checkbox').addEventListener('change', (e) => handleVerification('employee', e.target.checked, weekStartDateString));
            document.getElementById('supervisor-verify-checkbox').addEventListener('change', (e) => handleVerification('supervisor', e.target.checked, weekStartDateString));
        }

        async function handleVerification(type, isChecked, weekStartDateString) {
            const docId = `${activeEmployeeFilter}_${weekStartDateString}`;
            const verificationRef = doc(db, "workspaces", currentWorkspaceId, "verifications", docId);
            const updateData = {};
            if (type === 'employee') {
                updateData.employeeVerified = isChecked;
                updateData.employeeVerificationTimestamp = isChecked ? new Date() : null;
            } else if (type === 'supervisor') {
                updateData.supervisorVerified = isChecked;
                updateData.supervisorVerificationTimestamp = isChecked ? new Date() : null;
            }
            await setDoc(verificationRef, updateData, { merge: true });
            await loadWorkspaceData(currentWorkspaceId);
            renderSpreadsheet();
        }
        
        function handleAddNew() {
            const activeTab = manageTabs.querySelector('.active').dataset.tab;
            if (activeTab === 'employees') openAddEmployeeModal();
            else if (activeTab === 'projects') openProjectModal();
        }

        function getEmployeeFormHtml(employee = {}) {
            const isEditing = !!employee.id;
            const payroll = employee.payroll || {};
            const assignedDeductionsHtml = (payroll.deductions || []).map((ded, index) => `
                <div class="flex items-center justify-between p-2 bg-gray-700 rounded" data-index="${index}">
                    <span>${ded.name}: ${ded.type === 'fixed' ? '$' : ''}${ded.amount}${ded.type === 'percent' ? '%' : ''}</span>
                    <button type="button" class="text-red-400 text-xl font-bold remove-deduction-btn">&times;</button>
                </div>
            `).join('');

            return `
                <div class="border-b border-gray-700 mb-4">
                    <nav class="flex space-x-8" id="employee-modal-tabs">
                        <button type="button" data-tab="personal" class="tab-button py-3 px-1 font-medium active">Personal</button>
                        <button type="button" data-tab="employment" class="tab-button py-3 px-1 font-medium">Employment</button>
                        <button type="button" data-tab="payroll" class="tab-button py-3 px-1 font-medium">Payroll</button>
                    </nav>
                </div>

                <div id="personal-tab-pane" class="modal-tab-pane active space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div><label class="block text-gray-300 mb-2">First Name</label><input type="text" name="firstName" class="w-full p-3 form-input" required value="${employee.firstName || ''}"></div>
                        <div><label class="block text-gray-300 mb-2">Middle Name</label><input type="text" name="middleName" class="w-full p-3 form-input" value="${employee.middleName || ''}"></div>
                        <div><label class="block text-gray-300 mb-2">Last Name</label><input type="text" name="lastName" class="w-full p-3 form-input" required value="${employee.lastName || ''}"></div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label class="block text-gray-300 mb-2">Email</label><input type="email" name="email" class="w-full p-3 form-input" required value="${employee.email || ''}" ${isEditing ? 'disabled' : ''}></div>
                        ${!isEditing ? `<div><label class="block text-gray-300 mb-2">Temporary Password</label><input type="password" name="password" class="w-full p-3 form-input" required></div>` : ''}
                    </div>
                </div>

                <div id="employment-tab-pane" class="modal-tab-pane space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label class="block text-gray-300 mb-2">Employee ID</label><input type="text" name="employeeId" class="w-full p-3 form-input" required value="${employee.employeeId || ''}"></div>
                        <div><label class="block text-gray-300 mb-2">Card Number</label><input type="text" name="cardNumber" class="w-full p-3 form-input" value="${employee.cardNumber || ''}"></div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label class="block text-gray-300 mb-2">Hire Date</label><input type="date" name="hireDate" class="w-full p-3 form-input" required value="${employee.hireDate || ''}"></div>
                        <div><label class="block text-gray-300 mb-2">Supervisor</label><select name="supervisor" class="w-full p-3 form-select"></select></div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div><label class="block text-gray-300 mb-2">Department</label><select name="department" class="w-full p-3 form-select"></select></div>
                        <div><label class="block text-gray-300 mb-2">Pay Type</label><select name="payType" class="w-full p-3 form-select"></select></div>
                        <div><label class="block text-gray-300 mb-2">Employee Type</label><select name="employeeType" class="w-full p-3 form-select"></select></div>
                    </div>
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label class="block text-gray-300 mb-2">Role</label>
                            <select name="role" class="w-full p-3 form-select" required>
                                <option value="Employee" ${employee.role === 'Employee' ? 'selected' : ''}>Employee</option>
                                <option value="Manager" ${employee.role === 'Manager' ? 'selected' : ''}>Manager</option>
                                <option value="Admin" ${employee.role === 'Admin' ? 'selected' : ''}>Admin</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-300 mb-2">Status</label>
                            <select name="status" class="w-full p-3 form-select">
                                <option value="Active" ${employee.status === 'Active' ? 'selected' : ''}>Active</option>
                                <option value="Inactive" ${employee.status === 'Inactive' ? 'selected' : ''}>Inactive</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div id="payroll-tab-pane" class="modal-tab-pane space-y-6">
                    <h4 class="text-lg font-semibold text-white">Payroll Information</h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                         <div><label class="block text-gray-300 mb-2">Hourly Rate ($)</label><input type="number" name="hourlyRate" class="w-full p-3 form-input" step="0.01" value="${employee.hourlyRate || ''}"></div>
                         <div><label class="block text-gray-300 mb-2">Filing Status</label>
                            <select name="filingStatus" class="w-full p-3 form-select">
                                <option value="single" ${payroll.filingStatus === 'single' ? 'selected' : ''}>Single</option>
                                <option value="married" ${payroll.filingStatus === 'married' ? 'selected' : ''}>Married</option>
                            </select>
                         </div>
                         <div><label class="block text-gray-300 mb-2">Allowances</label><input type="number" name="allowances" class="w-full p-3 form-input" value="${payroll.allowances || 0}"></div>
                    </div>
                    <div class="border-t border-gray-700"></div>
                    <h4 class="text-lg font-semibold text-white">Assigned Deductions</h4>
                    <div class="space-y-4">
                        <div id="assigned-deductions-list" class="space-y-2 mb-4">
                            ${assignedDeductionsHtml || '<p class="text-gray-500">No deductions assigned.</p>'}
                        </div>
                        <div class="flex gap-4 items-end">
                            <div class="flex-grow">
                                <label class="block text-gray-300 mb-1">Add Deduction</label>
                                <select id="new-deduction-template" class="form-select w-full"></select>
                            </div>
                             <div class="w-1/4">
                                <label class="block text-gray-300 mb-1">Amount/Percent</label>
                                <input type="number" id="new-deduction-amount" class="form-input w-full" step="0.01">
                            </div>
                             <div class="w-1/4">
                                <label class="block text-gray-300 mb-1">Type</label>
                                <select id="new-deduction-type" class="form-select w-full">
                                    <option value="fixed">Fixed ($)</option>
                                    <option value="percent">Percent (%)</option>
                                </select>
                            </div>
                            <div>
                                 <button type="button" id="add-deduction-btn" class="secondary-button px-4 py-2 rounded-lg">Add</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-end gap-4 pt-6 border-t border-gray-700 mt-6">
                    <button type="button" class="secondary-button px-6 py-2 rounded-lg close-modal-btn">Cancel</button>
                    <button type="submit" class="cta-button px-6 py-2 rounded-lg">${isEditing ? 'Save Changes' : 'Add Employee'}</button>
                </div>
            `;
        }
        
        function setupEmployeeModalTabs(modal) {
            const tabs = modal.querySelectorAll('#employee-modal-tabs .tab-button');
            const panes = modal.querySelectorAll('.modal-tab-pane');
            const payrollTab = modal.querySelector('[data-tab="payroll"]');
            
            if (payrollTab && !checkPlanPermission('Enterprise')) {
                payrollTab.style.display = 'none';
            }

            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => t.classList.remove('active'));
                    panes.forEach(p => p.classList.remove('active'));
                    
                    tab.classList.add('active');
                    modal.querySelector(`#${tab.dataset.tab}-tab-pane`).classList.add('active');
                });
            });
        }
        
        function populateDropdown(select, optionsArray, selectedValue = null) {
            if (!select || !optionsArray) {
                if(select) select.innerHTML = '<option>No options available</option>';
                return;
            };
            select.innerHTML = optionsArray.map(opt => `<option value="${opt}" ${selectedValue === opt ? 'selected' : ''}>${opt}</option>`).join('');
        }

        function populateEmployeeFormDropdowns(formElement, employee = {}) {
            const ws = currentWorkspaceData;
            populateDropdown(formElement.querySelector('select[name="department"]'), ws.departments, employee.department);
            populateDropdown(formElement.querySelector('select[name="employeeType"]'), ws.employeeTypes, employee.employeeType);
            populateDropdown(formElement.querySelector('select[name="payType"]'), ws.payTypes, employee.payType);
            const supervisorOptions = employees.map(e => e.name);
            populateDropdown(formElement.querySelector('select[name="supervisor"]'), supervisorOptions, employee.supervisor);
            if(employee.status) formElement.querySelector('select[name="status"]').value = employee.status;
            if(employee.role) formElement.querySelector('select[name="role"]').value = employee.role;
        }
        
        function openAddEmployeeModal() {
            addEmployeeForm.innerHTML = getEmployeeFormHtml();
            populateEmployeeFormDropdowns(addEmployeeForm);
            setupEmployeeModalTabs(addEmployeeModal);
            addEmployeeModal.style.display = 'flex';
        }

        async function openEditEmployeeModal(employeeId) {
            editingItemId = employeeId;
            const employee = employees.find(e => e.id === employeeId);
            if (!employee) return;
            editEmployeeForm.innerHTML = getEmployeeFormHtml(employee);
            setupEmployeeModalTabs(editEmployeeModal);

            // Fetch and populate deduction templates
            const templatesRef = doc(db, "workspaces", currentWorkspaceId, "payrollSettings", "deductionTemplates");
            const templatesSnap = await getDoc(templatesRef);
            const deductionTemplates = templatesSnap.exists() ? templatesSnap.data().templates : [];
            const newDeductionSelect = editEmployeeForm.querySelector('#new-deduction-template');
            if(newDeductionSelect) newDeductionSelect.innerHTML = deductionTemplates.map(t => `<option value="${t.name}">${t.name}</option>`).join('');
            
            // Add event listener for the "Add" button
            const addDeductionBtn = editEmployeeForm.querySelector('#add-deduction-btn');
            if(addDeductionBtn) addDeductionBtn.addEventListener('click', () => {
                const name = newDeductionSelect.value;
                const amount = parseFloat(editEmployeeForm.querySelector('#new-deduction-amount').value);
                const type = editEmployeeForm.querySelector('#new-deduction-type').value;

                if (!name || isNaN(amount)) {
                    showToast('Please select a deduction and enter a valid amount.', 'error');
                    return;
                }

                const list = editEmployeeForm.querySelector('#assigned-deductions-list');
                const newIndex = list.children.length;
                const newDeductionEl = document.createElement('div');
                newDeductionEl.className = 'flex items-center justify-between p-2 bg-gray-700 rounded';
                newDeductionEl.dataset.index = newIndex;
                newDeductionEl.innerHTML = `
                    <span>${name}: ${type === 'fixed' ? '$' : ''}${amount}${type === 'percent' ? '%' : ''}</span>
                    <button type="button" class="text-red-400 text-xl font-bold remove-deduction-btn">&times;</button>
                `;
                
                if (list.querySelector('p')) list.innerHTML = ''; // Clear "No deductions" message
                list.appendChild(newDeductionEl);
                
                newDeductionEl.querySelector('.remove-deduction-btn').addEventListener('click', (e) => e.target.parentElement.remove());
                
                // Clear inputs
                editEmployeeForm.querySelector('#new-deduction-amount').value = '';
            });

            // Add event listeners for existing "Remove" buttons
            editEmployeeForm.querySelectorAll('.remove-deduction-btn').forEach(btn => {
                btn.addEventListener('click', (e) => e.target.parentElement.remove());
            });
            
            populateEmployeeFormDropdowns(editEmployeeForm, employee);
            editEmployeeModal.style.display = 'flex';
        }
        
        async function handleAddEmployee(e) {
            e.preventDefault();
            const form = e.target;
            const email = form.email.value;
            const password = form.password.value;

            // 1. Create a temporary secondary Firebase app instance to create the user
            const tempAppName = `temp-app-${Date.now()}`;
            const tempApp = initializeApp(firebaseConfig, tempAppName);
            const tempAuth = getAuth(tempApp);

            try {
                // 2. Create user in Firebase Auth
                const userCredential = await createUserWithEmailAndPassword(tempAuth, email, password);
                const newUid = userCredential.user.uid;

                // 3. Create the employee document in the 'members' subcollection with the new UID
                const newEmployeeData = {
                    uid: newUid,
                    email: email,
                    employeeId: form.employeeId.value,
                    name: `${form.firstName.value} ${form.lastName.value}`,
                    firstName: form.firstName.value,
                    lastName: form.lastName.value,
                    hireDate: form.hireDate.value,
                    department: form.department.value,
                    payType: form.payType.value,
                    employeeType: form.employeeType.value,
                    supervisor: form.supervisor.value,
                    cardNumber: form.cardNumber.value,
                    hourlyRate: form.hourlyRate.value || 0,
                    payroll: {
                        filingStatus: form.filingStatus.value,
                        allowances: Number(form.allowances.value) || 0,
                    },
                    role: form.role.value,
                    status: 'Active'
                };
                await setDoc(doc(db, "workspaces", currentWorkspaceId, "members", newUid), newEmployeeData);

                // 4. Create the main user document in the top-level 'users' collection
                const userDocData = {
                    email: email,
                    name: newEmployeeData.name,
                    activeWorkspaceId: currentWorkspaceId,
                    workspaces: {
                        [currentWorkspaceId]: newEmployeeData.role
                    }
                };
                await setDoc(doc(db, "users", newUid), userDocData);

                // 5. Send password reset email to force user to change temporary password
                await sendPasswordResetEmail(auth, email);

                showToast(`Employee ${newEmployeeData.name} created. A password reset email has been sent.`, 'success');
                closeAllModals();
                renderManagePage('employees');

            } catch (error) {
                console.error("Error creating employee:", error);
                showToast(`Error: ${error.message}`, 'error');
            } finally {
                // 6. Clean up the temporary app
                await deleteApp(tempApp);
            }
        }

        async function handleEditEmployee(e) {
            e.preventDefault();
            const form = e.target;
            
            // Collect assigned deductions from the form
            const assignedDeductions = [];
            const deductionListItems = form.querySelectorAll('#assigned-deductions-list > div');
            deductionListItems.forEach(item => {
                const text = item.querySelector('span').textContent;
                const [name, valueStr] = text.split(': ');
                const type = valueStr.includes('%') ? 'percent' : 'fixed';
                const amount = parseFloat(valueStr.replace(/[$%]/g, ''));
                assignedDeductions.push({ name, amount, type });
            });
            
            const updatedData = {
                employeeId: form.employeeId.value,
                name: `${form.firstName.value} ${form.lastName.value}`,
                firstName: form.firstName.value,
                middleName: form.middleName.value,
                lastName: form.lastName.value,
                hireDate: form.hireDate.value,
                department: form.department.value,
                payType: form.payType.value,
                employeeType: form.employeeType.value,
                supervisor: form.supervisor.value,
                cardNumber: form.cardNumber.value,
                hourlyRate: form.hourlyRate.value || 0,
                 payroll: {
                    filingStatus: form.filingStatus.value,
                    allowances: Number(form.allowances.value) || 0,
                    deductions: assignedDeductions
                },
                role: form.role.value,
                status: form.status.value
            };
            await updateDoc(doc(db, "workspaces", currentWorkspaceId, "members", editingItemId), updatedData);
            
            // Also update the role in the top-level user document
            const userDocRef = doc(db, "users", editingItemId);
            await updateDoc(userDocRef, {
                [`workspaces.${currentWorkspaceId}`]: updatedData.role
            });

            showToast('Employee updated successfully.', 'success');
            closeAllModals();
            editingItemId = null;
            renderManagePage('employees');
        }

        async function handleRemoveEmployee(employeeId) {
            // In a real app, you'd also need a Firebase Function to delete the Auth user.
            // This client-side code only removes the Firestore records.
            await deleteDoc(doc(db, "workspaces", currentWorkspaceId, "members", employeeId));
            await deleteDoc(doc(db, "users", employeeId)); // Also remove from top-level users
            showToast('Employee removed from workspace.', 'success');
            renderManagePage('employees');
        }

        async function handleSendPasswordReset(email) {
            if (!email) {
                showToast('No email on file for this user.', 'error');
                return;
            }
            try {
                await sendPasswordResetEmail(auth, email);
                showToast(`Password reset email sent to ${email}.`, 'success');
            } catch (error) {
                console.error("Password reset error:", error);
                showToast(`Error sending email: ${error.message}`, 'error');
            }
        }

        function getProjectFormHtml(project = {}) {
            const customFields = currentWorkspaceData.projectCustomFields || [];
            let customFieldsHtml = customFields.map(field => `
                <div>
                    <label class="block text-gray-300 mb-2">${field}</label>
                    <input type="text" name="${field}" class="w-full p-3 form-input" value="${project[field] || ''}">
                </div>
            `).join('');

            return `
                <div>
                    <label class="block text-gray-300 mb-2">Project Name</label>
                    <input type="text" name="name" class="w-full p-3 form-input" required value="${project.name || ''}">
                </div>
                ${customFieldsHtml}
                <div class="flex justify-end gap-4 pt-4">
                    <button type="button" class="secondary-button px-6 py-2 rounded-lg close-modal-btn">Cancel</button>
                    <button type="submit" class="cta-button px-6 py-2 rounded-lg">${project.id ? 'Save Changes' : 'Add Project'}</button>
                </div>
            `;
        }

        function openProjectModal(projectId = null) {
            editingItemId = projectId;
            const project = projectId ? projects.find(p => p.id === projectId) : {};
            document.getElementById('project-modal-title-text').textContent = projectId ? 'Edit Project' : 'Add New Project';
            projectForm.innerHTML = getProjectFormHtml(project);
            projectModal.style.display = 'flex';
        }

        async function handleProjectFormSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            const projectData = {};
            for (let [key, value] of formData.entries()) {
                projectData[key] = value;
            }

            if (editingItemId) {
                await updateDoc(doc(db, "workspaces", currentWorkspaceId, "projects", editingItemId), projectData);
            } else {
                await addDoc(collection(db, "workspaces", currentWorkspaceId, "projects"), projectData);
            }

            closeAllModals();
            editingItemId = null;
            renderManagePage('projects');
        }

        async function handleRemoveProject(projectId) {
            await deleteDoc(doc(db, "workspaces", currentWorkspaceId, "projects", projectId));
            renderManagePage('projects');
        }

        // --- Settings Page ---

        async function renderSettingsPage() {
            const userRole = currentUserData.workspaces[currentWorkspaceId];
            const isAdmin = userRole === 'Admin';

            const tabs = [
                { id: 'profile', label: 'My Profile', visible: true },
                { id: 'workspace', label: 'Workspace', visible: isAdmin },
                { id: 'payroll', label: 'Payroll', visible: isAdmin && checkPlanPermission('Enterprise') },
                { id: 'billing', label: 'Billing & Plan', visible: isAdmin },
                { id: 'danger', label: 'Danger Zone', visible: isAdmin }
            ];

            // Render Nav
            settingsNav.innerHTML = tabs
                .filter(tab => tab.visible)
                .map(tab => `<button class="tab-button text-left p-3 rounded-lg hover:bg-gray-700 w-full" data-tab="${tab.id}">${tab.label}</button>`)
                .join('');

            // Render Content Area
            settingsContentArea.innerHTML = tabs
                .filter(tab => tab.visible)
                .map(tab => `<div id="${tab.id}-settings-tab" class="settings-tab-content"></div>`)
                .join('');
            
            // Activate first tab
            const firstVisibleTab = tabs.find(t => t.visible);
            if (firstVisibleTab) {
                switchSettingsTab(firstVisibleTab.id);
            }

            // Add event listeners
            settingsNav.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', () => switchSettingsTab(button.dataset.tab));
            });
        }

        function switchSettingsTab(tabId) {
            // Update nav buttons
            settingsNav.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tab === tabId);
                btn.classList.toggle('bg-gray-700', btn.dataset.tab === tabId);
            });
            // Update content visibility
            settingsContentArea.querySelectorAll('.settings-tab-content').forEach(content => {
                content.classList.toggle('active', content.id === `${tabId}-settings-tab`);
            });

            // Render the content for the active tab
            switch (tabId) {
                case 'profile':
                    renderProfileSettings();
                    break;
                case 'workspace':
                    renderWorkspaceSettings();
                    break;
                case 'payroll':
                    renderPayrollSettingsTab();
                    break;
                case 'billing':
                    renderBillingSettings();
                    break;
                case 'danger':
                    renderDangerZoneSettings();
                    break;
            }
        }
        
        // --- Settings Tab Renderers ---

        function renderProfileSettings() {
            const container = document.getElementById('profile-settings-tab');
            const prefs = currentUserData.preferences || {};
            const notifications = prefs.notifications || {};
            const integrationsHtml = checkPlanPermission('Starter') ? `
                 <!-- Integrations -->
                <div class="card p-8">
                    <h3 class="text-xl font-semibold text-white mb-6">Integrations</h3>
                    <div class="flex items-center justify-between bg-gray-800 p-4 rounded-lg">
                        <div>
                            <h4 class="font-bold text-white">Google Calendar</h4>
                            <p class="text-sm text-gray-400">Sync your NexusTime schedule with Google Calendar.</p>
                        </div>
                        <button type="button" id="connect-calendar-btn" class="secondary-button px-4 py-2 rounded-lg font-semibold">Connect</button>
                    </div>
                </div>
            ` : '';

            container.innerHTML = `
                <form id="profile-settings-form" class="space-y-12">
                    <!-- Personal Information -->
                    <div class="card p-8">
                        <h3 class="text-xl font-semibold text-white mb-6">Personal Information</h3>
                        <div class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div><label class="block text-gray-400">Name</label><input type="text" name="name" class="form-input w-full mt-1" value="${currentUserData.name || ''}"></div>
                                <div><label class="block text-gray-400">Email</label><input type="email" class="form-input w-full mt-1" value="${currentUser.email}" disabled></div>
                            </div>
                        </div>
                    </div>
                    <!-- Security -->
                    <div class="card p-8">
                        <h3 class="text-xl font-semibold text-white mb-6">Change Password</h3>
                         <div class="space-y-4">
                            <div><label class="block text-gray-400">Current Password</label><input type="password" name="currentPassword" class="form-input w-full mt-1" placeholder="Required to change password"></div>
                            <div><label class="block text-gray-400">New Password</label><input type="password" name="newPassword" class="form-input w-full mt-1" placeholder="Leave blank to keep current"></div>
                            <div><label class="block text-gray-400">Confirm New Password</label><input type="password" name="confirmPassword" class="form-input w-full mt-1"></div>
                        </div>
                    </div>
                    <!-- Preferences & Notifications -->
                    <div class="card p-8">
                        <h3 class="text-xl font-semibold text-white mb-6">Preferences & Notifications</h3>
                        <div class="space-y-6">
                           <div>
                                <h4 class="font-medium text-white mb-2">Email Notifications</h4>
                                <div class="space-y-2">
                                    <label class="flex items-center"><input type="checkbox" name="notificationTimesheet" class="h-4 w-4 rounded bg-gray-700 border-gray-600 text-emerald-500 focus:ring-emerald-500 mr-2" ${notifications.timesheetReminders !== false ? 'checked' : ''}><span class="text-gray-300">Weekly Timesheet Reminders</span></label>
                                    <label class="flex items-center"><input type="checkbox" name="notificationSchedule" class="h-4 w-4 rounded bg-gray-700 border-gray-600 text-emerald-500 focus:ring-emerald-500 mr-2" ${notifications.scheduleUpdates !== false ? 'checked' : ''}><span class="text-gray-300">Schedule Updates</span></label>
                                    <label class="flex items-center"><input type="checkbox" name="notificationApprovals" class="h-4 w-4 rounded bg-gray-700 border-gray-600 text-emerald-500 focus:ring-emerald-500 mr-2" ${notifications.approvalConfirmations !== false ? 'checked' : ''}><span class="text-gray-300">Approval Confirmations</span></label>
                                </div>
                           </div>
                        </div>
                    </div>
                    ${integrationsHtml}
                    <div class="flex justify-end">
                        <button type="submit" class="cta-button px-8 py-3 rounded-lg font-semibold">Save Profile Settings</button>
                    </div>
                </form>
            `;
            document.getElementById('profile-settings-form').addEventListener('submit', handleSaveProfileSettings);
            const connectCalendarBtn = document.getElementById('connect-calendar-btn');
            if (connectCalendarBtn) {
                connectCalendarBtn.addEventListener('click', () => {
                    showToast('Calendar integration coming soon!', 'success');
                });
            }
        }

        function renderWorkspaceSettings() {
            const container = document.getElementById('workspace-settings-tab');
            const ws = currentWorkspaceData;
            
            const proFeaturesHtml = checkPlanPermission('Pro') ? `
                 <div class="card p-8">
                     <h3 class="text-xl font-semibold text-white mb-6">Security (Pro Feature)</h3>
                     <div class="space-y-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <h4 class="font-medium text-white">Require Two-Factor Authentication</h4>
                                <p class="text-sm text-gray-400">Force all members to use 2FA for enhanced security.</p>
                            </div>
                            <label class="toggle-switch"><input type="checkbox" name="require2FA" ${ws.security?.require2FA ? 'checked' : ''}><span class="toggle-slider"></span></label>
                        </div>
                        <div class="border-t border-gray-700 my-2"></div>
                         <div>
                            <label class="block text-gray-400 mb-1">Session Timeout</label>
                            <select name="sessionTimeout" class="form-select w-full md:w-1/2">
                                <option value="30" ${ws.security?.sessionTimeout == 30 ? 'selected' : ''}>30 minutes</option>
                                <option value="60" ${ws.security?.sessionTimeout == 60 ? 'selected' : ''}>1 hour</option>
                                <option value="480" ${ws.security?.sessionTimeout == 480 ? 'selected' : ''}>8 hours</option>
                                <option value="0" ${!ws.security?.sessionTimeout || ws.security?.sessionTimeout == 0 ? 'selected' : ''}>Never</option>
                            </select>
                            <p class="text-sm text-gray-400 mt-1">Automatically log out users after a period of inactivity.</p>
                        </div>
                     </div>
                </div>
                 <div class="card p-8">
                     <h3 class="text-xl font-semibold text-white mb-6">Data & API (Pro Feature)</h3>
                     <div class="space-y-6">
                         <div class="flex items-center justify-between">
                            <div>
                                <h4 class="font-medium text-white">Export Workspace Data</h4>
                                <p class="text-sm text-gray-400">Download all your workspace data as a CSV file.</p>
                            </div>
                            <button type="button" id="export-data-btn" class="secondary-button px-4 py-2 rounded-lg font-semibold">Export Data</button>
                        </div>
                         <div class="border-t border-gray-700 my-2"></div>
                         <div>
                            <h4 class="font-medium text-white">API Access</h4>
                            <p class="text-sm text-gray-400 mb-2">Use the NexusTime API to build custom integrations.</p>
                            <input type="text" class="form-input w-full" value="nt_api_${currentWorkspaceId.substring(0, 16)}..." readonly>
                        </div>
                     </div>
                </div>
            ` : `
                <div class="card p-8 border border-dashed border-gray-600 text-center">
                    <h3 class="text-lg font-semibold text-white">Unlock Advanced Settings</h3>
                    <p class="text-gray-400 mt-2">Upgrade to the Pro plan to access advanced security, data exports, and API access.</p>
                    <button type="button" id="upgrade-from-ws-settings-btn" class="mt-4 cta-button px-6 py-2 rounded-lg">Upgrade Plan</button>
                </div>
            `;

            container.innerHTML = `
                <form id="workspace-settings-form" class="space-y-12">
                    <div class="card p-8">
                         <h3 class="text-xl font-semibold text-white mb-6">General</h3>
                         <div class="space-y-4">
                            <div><label class="block text-gray-400">Workspace Name</label><input type="text" name="workspaceName" class="form-input w-full mt-1" value="${ws.name || ''}"></div>
                         </div>
                    </div>
                    ${proFeaturesHtml}
                    <div class="flex justify-end">
                        <button type="submit" class="cta-button px-8 py-3 rounded-lg font-semibold">Save Workspace Settings</button>
                    </div>
                </form>
            `;
            document.getElementById('workspace-settings-form').addEventListener('submit', handleSaveWorkspaceSettings);
            const exportBtn = document.getElementById('export-data-btn');
            if(exportBtn) exportBtn.addEventListener('click', () => { showToast('Data export feature coming soon!', 'success'); });
            const upgradeBtn = document.getElementById('upgrade-from-ws-settings-btn');
            if(upgradeBtn) upgradeBtn.addEventListener('click', () => switchSettingsTab('billing'));
        }

        async function renderPayrollSettingsTab() {
            const container = document.getElementById('payroll-settings-tab');
            container.innerHTML = `<div class="loader"></div>`;

            // Get deduction templates
            const templatesRef = doc(db, "workspaces", currentWorkspaceId, "payrollSettings", "deductionTemplates");
            const templatesSnap = await getDoc(templatesRef);
            const deductionTemplates = templatesSnap.exists() ? templatesSnap.data().templates : [];

            let templatesHtml = deductionTemplates.map((template, index) => `
                <li class="flex justify-between items-center p-3 bg-gray-800 rounded-lg">
                    <div>
                        <p class="font-semibold text-white">${template.name}</p>
                        <p class="text-sm text-gray-400">Type: ${template.type}</p>
                    </div>
                    <div>
                        <button class="text-red-400 hover:text-red-300 font-semibold" data-index="${index}">Remove</button>
                    </div>
                </li>
            `).join('');

            container.innerHTML = `
                <div class="card p-8">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-semibold text-white">Deduction & Benefit Templates</h3>
                        <button id="add-deduction-template-btn" class="cta-button px-4 py-2 rounded-lg text-sm">Add Template</button>
                    </div>
                    <p class="text-gray-400 mb-4">Create templates for common deductions (e.g., Health Insurance, 401(k)). These will be available to assign to employees.</p>
                    <ul id="deduction-templates-list" class="space-y-3">
                        ${templatesHtml || '<p class="text-gray-500">No deduction templates created yet.</p>'}
                    </ul>
                </div>
            `;

            document.getElementById('add-deduction-template-btn').addEventListener('click', () => {
                const name = prompt("Enter template name (e.g., Health Insurance):");
                if (!name) return;
                const type = prompt("Enter type ('pre-tax' or 'post-tax'):", "pre-tax");
                if (type !== 'pre-tax' && type !== 'post-tax') {
                    alert("Invalid type. Please enter 'pre-tax' or 'post-tax'.");
                    return;
                }
                handleSaveDeductionTemplate({ name, type });
            });
            
            container.querySelectorAll('#deduction-templates-list button').forEach(button => {
                button.addEventListener('click', (e) => {
                     if (confirm('Are you sure you want to remove this template?')) {
                        handleRemoveDeductionTemplate(parseInt(e.target.dataset.index));
                    }
                });
            });
        }
        
        async function handleSaveDeductionTemplate(newTemplate) {
            const templatesRef = doc(db, "workspaces", currentWorkspaceId, "payrollSettings", "deductionTemplates");
            await setDoc(templatesRef, {
                templates: arrayUnion(newTemplate)
            }, { merge: true });

            showToast('Deduction template saved!', 'success');
            renderPayrollSettingsTab();
        }

        async function handleRemoveDeductionTemplate(indexToRemove) {
            const templatesRef = doc(db, "workspaces", currentWorkspaceId, "payrollSettings", "deductionTemplates");
            const templatesSnap = await getDoc(templatesRef);
            if (templatesSnap.exists()) {
                const currentTemplates = templatesSnap.data().templates;
                currentTemplates.splice(indexToRemove, 1);
                await setDoc(templatesRef, { templates: currentTemplates });
                showToast('Deduction template removed!', 'success');
                renderPayrollSettingsTab();
            }
        }

        function renderBillingSettings() {
            const container = document.getElementById('billing-settings-tab');
            const currentPlan = currentWorkspaceData.plan || 'Free';
            
            const plans = {
                Free: { price: 0, annual: 0, features: ["1 User Seat", "3 Active Projects", "Basic Time Tracking"] },
                Starter: { price: 6, annual: 5, features: ["Unlimited Users", "Unlimited Projects", "Timesheet Approvals", "Team Reporting"] },
                Pro: { price: 12, annual: 10, features: ["Everything in Starter", "Scheduling & Tasks", "Project Budgeting", "API & Integrations"] },
                Enterprise: { price: 15, annual: 12, features: ["Everything in Pro", "Full Payroll Suite", "SAML SSO & Audit Logs", "Dedicated Support"] }
            };
            
            let plansHtml = '<div class="grid grid-cols-1 lg:grid-cols-2 gap-8">';
            for (const [planName, planDetails] of Object.entries(plans)) {
                const isCurrent = planName === currentPlan;
                let buttonHtml;
                if (isCurrent) {
                    buttonHtml = `<button class="w-full cta-button py-3 rounded-lg font-semibold" disabled>Current Plan</button>`;
                } else {
                    const actionText = (plans[planName].price > (plans[currentPlan]?.price || 0)) ? 'Upgrade' : 'Downgrade';
                    buttonHtml = `<button class="w-full cta-button py-3 rounded-lg font-semibold" data-plan="${planName}">${actionText} to ${planName}</button>`;
                }

                plansHtml += `
                    <div class="plan-card p-6 rounded-lg ${isCurrent ? 'selected' : ''}">
                         ${isCurrent ? '<div class="absolute top-2 right-2 text-xs bg-emerald-500 text-white font-bold py-1 px-2 rounded-full">Active</div>' : ''}
                        <h3 class="text-2xl font-bold text-emerald-400">${planName}</h3>
                        <p class="text-4xl font-extrabold my-4 text-white">$<span data-price-monthly="${planDetails.price}" data-price-annual="${planDetails.annual}">${planDetails.price}</span><span class="text-base font-medium text-gray-400">/user/month</span></p>
                        <ul class="space-y-2 text-gray-300 flex-grow mb-6">
                            ${planDetails.features.map(f => `
                                <li class="flex items-center">
                                    <svg class="w-5 h-5 text-emerald-400 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                                    <span>${f}</span>
                                </li>`).join('')}
                        </ul>
                        <div class="mt-auto">
                            ${buttonHtml}
                        </div>
                    </div>
                `;
            }
            plansHtml += '</div>';

            container.innerHTML = `
                <h3 class="text-xl font-semibold text-white mb-2">Billing & Plan</h3>
                <p class="text-gray-400 mb-6">Choose the plan that's right for your team.</p>
                ${plansHtml}
            `;
            
            container.querySelectorAll('button[data-plan]').forEach(button => {
                button.addEventListener('click', () => handlePlanSelection(button.dataset.plan));
            });
        }

        function renderDangerZoneSettings() {
            const container = document.getElementById('danger-settings-tab');
            container.innerHTML = `
                 <div class="card p-8 border-red-500 border-2">
                    <h3 class="text-xl font-semibold text-red-400 mb-2">Danger Zone</h3>
                    <p class="text-gray-400 mb-6">These actions are permanent and cannot be undone.</p>
                    <div class="flex justify-between items-center bg-gray-800 p-4 rounded-lg">
                        <div>
                            <h4 class="font-bold text-white">Delete this Workspace</h4>
                            <p class="text-sm text-gray-400">All data, including employees, timesheets, and projects will be permanently deleted.</p>
                        </div>
                        <button id="delete-workspace-btn" class="danger-button px-4 py-2 rounded-lg font-semibold">Delete Workspace</button>
                    </div>
                </div>
            `;
            document.getElementById('delete-workspace-btn').addEventListener('click', handleDeleteWorkspace);
        }
        
        // --- Settings Form Handlers ---
        
        async function handleSaveProfileSettings(e) {
            e.preventDefault();
            const form = e.target;
            const newPassword = form.newPassword.value;
            const confirmPassword = form.confirmPassword.value;
            const currentPassword = form.currentPassword.value;

            // --- Update Password Logic ---
            if (newPassword) {
                if (!currentPassword) {
                    showToast('Please enter your current password to set a new one.', 'error');
                    return;
                }
                if (newPassword !== confirmPassword) {
                    showToast('New passwords do not match.', 'error');
                    return;
                }
                
                try {
                    const credential = EmailAuthProvider.credential(currentUser.email, currentPassword);
                    await reauthenticateWithCredential(currentUser, credential);
                    await updatePassword(currentUser, newPassword);
                    showToast('Password updated successfully.', 'success');
                    form.currentPassword.value = '';
                    form.newPassword.value = '';
                    form.confirmPassword.value = '';
                } catch (error) {
                    console.error("Password update failed:", error);
                    showToast(`Password update failed: ${error.message}`, 'error');
                    return; // Stop if password update fails
                }
            }

            // --- Update Profile and Preferences ---
            const userDocRef = doc(db, "users", currentUser.uid);
            const updatedProfile = {
                name: form.name.value,
                preferences: {
                    notifications: {
                        timesheetReminders: form.notificationTimesheet.checked,
                        scheduleUpdates: form.notificationSchedule.checked,
                        approvalConfirmations: form.notificationApprovals.checked
                    }
                }
            };
            
            try {
                await updateDoc(userDocRef, updatedProfile);
                showToast('Profile settings saved successfully!', 'success');
                // Reload user data to reflect changes immediately
                await loadUserData(currentUser.uid);
            } catch (error) {
                console.error("Error saving profile:", error);
                showToast(`Error saving profile: ${error.message}`, 'error');
            }
        }
        
        async function handleSaveWorkspaceSettings(e) {
            e.preventDefault();
            const form = e.target;
            const workspaceDocRef = doc(db, "workspaces", currentWorkspaceId);
            
            const updatedSettings = {
                name: form.workspaceName.value,
            };

            if (checkPlanPermission('Pro')) {
                updatedSettings.security = {
                    require2FA: form.require2FA.checked,
                    sessionTimeout: Number(form.sessionTimeout.value)
                }
            }

            try {
                await updateDoc(workspaceDocRef, updatedSettings);
                showToast('Workspace settings saved successfully!', 'success');
                await loadWorkspaceData(currentWorkspaceId);
                renderWorkspaceSettings();
            } catch (error) {
                console.error("Error saving workspace settings:", error);
                showToast(`Error: ${error.message}`, 'error');
            }
        }
        
        async function handlePlanSelection(newPlan) {
            const workspaceDocRef = doc(db, "workspaces", currentWorkspaceId);
            try {
                await updateDoc(workspaceDocRef, { plan: newPlan });
                showToast(`Successfully changed plan to ${newPlan}!`, 'success');
                await loadWorkspaceData(currentWorkspaceId); 
                renderBillingSettings(); 
                updateNav();
            } catch (error) {
                console.error("Error changing plan:", error);
                showToast(`Failed to change plan: ${error.message}`, 'error');
            }
        }

        function handleDeleteWorkspace() {
            openConfirmationModal(
                'Delete Workspace',
                `This will permanently delete the "${currentWorkspaceData.name}" workspace and all its data. This action cannot be undone.`,
                async () => {
                    const batch = writeBatch(db);
                    
                    // Note: Deleting subcollections from the client is not recommended for production.
                    // This should be handled by a Firebase Cloud Function. This is a simplified simulation.
                    console.log(`Simulating deletion for workspace ${currentWorkspaceId}`);

                    const userDocRef = doc(db, "users", currentUser.uid);
                    const newWorkspaces = { ...currentUserData.workspaces };
                    delete newWorkspaces[currentWorkspaceId];
                    
                    batch.update(userDocRef, {
                        workspaces: newWorkspaces,
                        activeWorkspaceId: Object.keys(newWorkspaces)[0] || null
                    });
                    
                    // Mark the workspace for deletion instead of actually deleting it from client
                    batch.update(doc(db, "workspaces", currentWorkspaceId), { status: 'deleted' });

                    await batch.commit();

                    showToast('Workspace deletion initiated.', 'success');
                    window.location.hash = 'company-selection';
                    closeAllModals();
                }
            );
        }

        function openConfirmationModal(title, message, onConfirm) {
            const modal = document.getElementById('confirmation-modal');
            document.getElementById('confirmation-modal-title').textContent = title;
            document.getElementById('confirmation-modal-message').textContent = message;
            
            const confirmBtn = document.getElementById('confirmation-confirm-btn');
            const cancelBtn = document.getElementById('confirmation-cancel-btn');
            
            // Clone and replace to remove old event listeners
            const newConfirmBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
            
            newConfirmBtn.addEventListener('click', onConfirm);
            cancelBtn.addEventListener('click', closeAllModals);

            modal.style.display = 'flex';
        }


        async function renderOnboardingPage() {
            const userPlan = currentUserData.plan || 'Free';
            const workspaceLimit = PLAN_WORKSPACE_LIMITS[userPlan] || 1;
            const existingWorkspaceCount = Object.keys(currentUserData.workspaces || {}).length;

            if (existingWorkspaceCount >= workspaceLimit) {
                onboardingContainer.innerHTML = `
                    <h2 class="text-2xl font-semibold text-emerald-400 mb-4 text-center">Cannot Create Workspace</h2>
                    <p class="text-center text-gray-400">Your current plan (${userPlan}) allows for a maximum of ${workspaceLimit} workspace(s). Please upgrade your plan to create more.</p>
                    <div class="text-center mt-6">
                        <a href="#settings" data-page="settings" class="cta-button px-8 py-3 rounded-lg font-semibold">Go to Settings</a>
                    </div>
                `;
                return;
            }
            
            const industries = ["Software", "Healthcare", "Retail", "Education", "Construction", "Finance", "Legal", "Hospitality", "Transportation", "Manufacturing", "Marketing", "Non-Profit", "Real Estate", "Telecommunications", "Government"];
            const companySizes = ["1-10 employees", "11-50 employees", "51-200 employees", "201-500 employees", "500+ employees"];
            const timezones = {"(GMT-12:00) International Date Line West": "Etc/GMT+12", "(GMT-11:00) Midway Island, Samoa": "Pacific/Samoa", "(GMT-10:00) Hawaii": "Pacific/Honolulu", "(GMT-09:00) Alaska": "America/Anchorage", "(GMT-08:00) Pacific Time (US & Canada)": "America/Los_Angeles", "(GMT-07:00) Mountain Time (US & Canada)": "America/Denver", "(GMT-06:00) Central Time (US & Canada)": "America/Chicago", "(GMT-05:00) Eastern Time (US & Canada)": "America/New_York", "(GMT-04:00) Atlantic Time (Canada)": "America/Halifax", "(GMT-03:00) Buenos Aires, Georgetown": "America/Argentina/Buenos_Aires", "(GMT-02:00) Mid-Atlantic": "Atlantic/South_Georgia", "(GMT-01:00) Cape Verde Is.": "Atlantic/Cape_Verde", "(GMT+00:00) London, Lisbon": "Europe/London", "(GMT+01:00) Amsterdam, Berlin, Rome": "Europe/Berlin", "(GMT+02:00) Athens, Jerusalem": "Europe/Athens", "(GMT+03:00) Moscow, St. Petersburg": "Europe/Moscow", "(GMT+04:00) Abu Dhabi, Muscat": "Asia/Dubai", "(GMT+05:00) Islamabad, Karachi, Tashkent": "Asia/Karachi", "(GMT+05:30) Chennai, Kolkata, Mumbai, New Delhi": "Asia/Kolkata", "(GMT+06:00) Almaty, Novosibirsk": "Asia/Almaty", "(GMT+07:00) Bangkok, Hanoi, Jakarta": "Asia/Bangkok", "(GMT+08:00) Beijing, Perth, Singapore, Hong Kong": "Asia/Hong_Kong", "(GMT+09:00) Tokyo, Seoul, Osaka, Sapporo, Yakutsk": "Asia/Tokyo", "(GMT+09:30) Adelaide, Darwin": "Australia/Darwin", "(GMT+10:00) Brisbane, Canberra, Melbourne, Sydney": "Australia/Sydney", "(GMT+11:00) Magadan, Solomon Is., New Caledonia": "Pacific/Guadalcanal", "(GMT+12:00) Auckland, Wellington, Fiji": "Pacific/Auckland"};

            onboardingContainer.innerHTML = `
                <h2 class="text-2xl font-semibold text-emerald-400 mb-4 text-center">Create a New Workspace</h2>
                <form id="onboarding-form" class="space-y-4">
                    <div><label class="block text-gray-300 mb-1">Workspace Name</label><input type="text" name="workspaceName" class="w-full p-3 form-input" required></div>
                    <div><label class="block text-gray-300 mb-1">Industry</label><select name="industry" class="w-full p-3 form-select">${industries.map(i => `<option value="${i}">${i}</option>`).join('')}</select></div>
                    <div><label class="block text-gray-300 mb-1">Company Size</label><select name="companySize" class="w-full p-3 form-select">${companySizes.map(s => `<option value="${s}">${s}</option>`).join('')}</select></div>
                    <div><label class="block text-gray-300 mb-1">Time Zone</label><select name="timezone" class="w-full p-3 form-select">${Object.entries(timezones).map(([name, value]) => `<option value="${value}">${name}</option>`).join('')}</select></div>
                    <div class="text-center pt-4"><button type="submit" class="w-full cta-button px-8 py-3 rounded-lg font-semibold">Create Workspace</button></div>
                </form>
            `;

            document.getElementById('onboarding-form').addEventListener('submit', handleCreateWorkspace);
        }

        async function handleCreateWorkspace(e) {
            e.preventDefault();
            const form = e.target;
            const workspaceData = {
                name: form.workspaceName.value,
                industry: form.industry.value,
                companySize: form.companySize.value,
                timezone: form.timezone.value,
                plan: 'Free', // New workspaces start on Free plan
                ownerId: currentUser.uid,
                createdAt: new Date(),
                departments: ["General"],
                payTypes: ["Hourly", "Salary"],
                employeeTypes: ["Full-time", "Part-time"],
                projectCustomFields: ["Client Name", "Budget"]
            };

            try {
                const workspaceRef = await addDoc(collection(db, "workspaces"), workspaceData);
                const workspaceId = workspaceRef.id;

                // Add the creator as the first member of the new workspace
                const memberData = {
                    uid: currentUser.uid,
                    email: currentUser.email,
                    name: currentUserData.name || 'Admin',
                    role: 'Admin',
                    status: 'Active'
                };
                await setDoc(doc(db, "workspaces", workspaceId, "members", currentUser.uid), memberData);

                // Add workspace to user's map and set as active
                await updateDoc(doc(db, "users", currentUser.uid), {
                    [`workspaces.${workspaceId}`]: 'Admin',
                    activeWorkspaceId: workspaceId
                });

                showToast('Workspace created successfully!', 'success');
                window.location.hash = 'dashboard';

            } catch (error) {
                console.error("Error creating workspace:", error);
                showToast(`Error: ${error.message}`, 'error');
            }
        }
        
        // --- Schedule Page Rendering ---
        async function renderSchedulePage() {
            if (!checkPlanPermission('Pro')) {
                showPage('dashboard');
                showToast('Upgrade to the Pro plan to access Scheduling.', 'error');
                return;
            }
            const container = document.getElementById('schedule-container');
            const userRole = currentUserData.workspaces[currentWorkspaceId];
            const isAdminOrManager = userRole === 'Admin' || userRole === 'Manager';

            const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            
            container.innerHTML = `
                <div class="flex flex-col md:flex-row justify-between md:items-center mb-6 gap-4">
                    <div class="flex items-center gap-4">
                        <button id="prev-month-btn" class="secondary-button p-2 rounded-full"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg></button>
                        <h2 id="calendar-header" class="text-3xl font-bold text-white text-center">
                            ${monthNames[calendarDate.getMonth()]} ${calendarDate.getFullYear()}
                        </h2>
                        <button id="next-month-btn" class="secondary-button p-2 rounded-full"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg></button>
                    </div>
                    ${isAdminOrManager ? '<button id="add-shift-main-btn" class="cta-button px-4 py-2 rounded-lg font-semibold">Add Shift</button>' : ''}
                </div>
                <div id="calendar-grid-container" class="card p-4"></div>
            `;

            renderCalendarGrid();

            document.getElementById('prev-month-btn').addEventListener('click', () => {
                calendarDate.setMonth(calendarDate.getMonth() - 1);
                renderSchedulePage();
            });
            document.getElementById('next-month-btn').addEventListener('click', () => {
                calendarDate.setMonth(calendarDate.getMonth() + 1);
                renderSchedulePage();
            });
            const addShiftBtn = document.getElementById('add-shift-main-btn');
            if(addShiftBtn) addShiftBtn.addEventListener('click', () => openAddShiftModal());
        }

        function renderCalendarGrid() {
            const gridContainer = document.getElementById('calendar-grid-container');
            const month = calendarDate.getMonth();
            const year = calendarDate.getFullYear();
            
            const firstDayOfMonth = new Date(year, month, 1);
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const startDayOfWeek = firstDayOfMonth.getDay(); // 0=Sun, 1=Mon, ...

            const monthShifts = schedules.filter(s => {
                const shiftDate = new Date(s.start);
                return shiftDate.getMonth() === month && shiftDate.getFullYear() === year;
            });

            let gridHtml = `<div class="grid grid-cols-7 text-center font-bold text-gray-400 border-b border-gray-700 mb-2 pb-2">
                <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
            </div>
            <div class="calendar-grid gap-px bg-gray-700">`;

            // Blank cells for previous month
            for (let i = 0; i < startDayOfWeek; i++) {
                gridHtml += `<div class="calendar-day other-month"></div>`;
            }

            // Cells for current month
            for (let day = 1; day <= daysInMonth; day++) {
                const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const shiftsForDay = monthShifts.filter(s => s.start.startsWith(dateString));
                
                let shiftsHtml = shiftsForDay.map(shift => {
                    const emp = employees.find(e => e.id === shift.userId);
                    const startTime = new Date(shift.start).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    return `<div class="shift-badge" title="${emp?.name} - ${shift.title}">${startTime} ${emp?.name}</div>`
                }).join('');

                gridHtml += `<div class="calendar-day bg-gray-800 p-2" data-date="${dateString}">
                                <div class="font-bold">${day}</div>
                                <div class="mt-1 space-y-1">${shiftsHtml}</div>
                             </div>`;
            }
            gridHtml += '</div>';
            gridContainer.innerHTML = gridHtml;

            gridContainer.querySelectorAll('.calendar-day:not(.other-month)').forEach(dayCell => {
                dayCell.addEventListener('click', () => openAddShiftModal(dayCell.dataset.date));
            });
        }
        
        function openAddShiftModal(date = null) {
            const employeeOptions = employees.map(e => `<option value="${e.id}">${e.name}</option>`).join('');
            const today = new Date().toISOString().split('T')[0];
            
            addShiftForm.innerHTML = `
                <div><label class="block text-gray-300 mb-1">Employee</label><select name="userId" class="form-select w-full" required>${employeeOptions}</select></div>
                <div><label class="block text-gray-300 mb-1">Shift Title (optional)</label><input type="text" name="title" class="form-input w-full"></div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-300 mb-1">Start Time</label>
                        <input type="datetime-local" name="start" class="form-input w-full" value="${date || today}T09:00" required>
                    </div>
                    <div>
                        <label class="block text-gray-300 mb-1">End Time</label>
                        <input type="datetime-local" name="end" class="form-input w-full" value="${date || today}T17:00" required>
                    </div>
                </div>
                <div class="flex justify-end pt-4">
                    <button type="submit" class="cta-button px-6 py-2 rounded-lg">Save Shift</button>
                </div>
            `;
            addShiftModal.style.display = 'flex';
        }

        async function handleAddShift(e) {
            e.preventDefault();
            const form = e.target;
            const shiftData = {
                userId: form.userId.value,
                title: form.title.value || 'Work Shift',
                start: form.start.value,
                end: form.end.value,
                createdAt: new Date()
            };

            try {
                await addDoc(collection(db, "workspaces", currentWorkspaceId, "schedules"), shiftData);
                showToast('Shift added successfully!', 'success');
                closeAllModals();
                renderSchedulePage();
            } catch (error) {
                console.error("Error adding shift:", error);
                showToast(`Error: ${error.message}`, 'error');
            }
        }
        
        // --- Tasks Page Rendering ---
        async function renderTasksPage() {
            if (!checkPlanPermission('Pro')) {
                showPage('dashboard');
                showToast('Upgrade to the Pro plan to access Tasks.', 'error');
                return;
            }
            const container = document.getElementById('tasks-container');
            const userRole = currentUserData.workspaces[currentWorkspaceId];
            const isAdminOrManager = userRole === 'Admin' || userRole === 'Manager';

            let headerHtml = `
                <div class="flex flex-col md:flex-row justify-between md:items-center mb-8 gap-4">
                    <h2 class="text-3xl font-bold text-white">${isAdminOrManager ? 'Task Dashboard' : 'My Tasks'}</h2>
                    ${isAdminOrManager ? '<button id="create-task-btn" class="cta-button px-4 py-2 rounded-lg font-semibold">Create New Task</button>' : ''}
                </div>
            `;

            let tasksHtml;
            const userTasks = isAdminOrManager ? tasks : tasks.filter(t => t.assigneeId === currentUser.uid);

            if (userTasks.length === 0) {
                tasksHtml = '<div class="card p-8 text-center"><p class="text-gray-400">No tasks found.</p></div>';
            } else {
                tasksHtml = '<div class="card p-6"><ul class="space-y-4">';
                userTasks.sort((a,b) => new Date(a.dueDate) - new Date(b.dueDate)).forEach(task => {
                    const assignee = employees.find(e => e.id === task.assigneeId);
                    tasksHtml += `
                        <li class="task-item ${task.status === 'completed' ? 'completed' : ''} bg-gray-800 p-4 rounded-lg flex items-center justify-between">
                            <div class="flex items-center">
                                ${!isAdminOrManager ? `<input type="checkbox" data-task-id="${task.id}" class="h-5 w-5 rounded bg-gray-700 border-gray-600 text-emerald-500 focus:ring-emerald-500 mr-4" ${task.status === 'completed' ? 'checked' : ''}>` : ''}
                                <div>
                                    <p class="font-semibold text-white">${task.title}</p>
                                    <p class="text-sm text-gray-400">${task.description || 'No description'}</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <span class="status-badge ${task.status === 'completed' ? 'status-completed' : 'status-pending'}">${task.status}</span>
                                <p class="text-sm text-gray-400 mt-1">Due: ${task.dueDate}</p>
                                ${isAdminOrManager ? `<p class="text-sm text-gray-300">To: ${assignee?.name || 'Unassigned'}</p>` : ''}
                            </div>
                        </li>
                    `;
                });
                tasksHtml += '</ul></div>';
            }

            container.innerHTML = headerHtml + tasksHtml;
            
            if (isAdminOrManager) {
                document.getElementById('create-task-btn').addEventListener('click', openCreateTaskModal);
            } else {
                container.querySelectorAll('input[type="checkbox"][data-task-id]').forEach(checkbox => {
                    checkbox.addEventListener('change', (e) => handleTaskStatusChange(e.target.dataset.taskId, e.target.checked));
                });
            }
        }

        function openCreateTaskModal() {
            const employeeOptions = employees.map(e => `<option value="${e.id}">${e.name}</option>`).join('');
            createTaskForm.innerHTML = `
                <div><label class="block text-gray-300 mb-1">Task Title</label><input type="text" name="title" class="form-input w-full" required></div>
                <div><label class="block text-gray-300 mb-1">Description</label><textarea name="description" class="form-textarea w-full" rows="3"></textarea></div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-300 mb-1">Assign To</label>
                        <select name="assigneeId" class="form-select w-full" required>${employeeOptions}</select>
                    </div>
                    <div>
                        <label class="block text-gray-300 mb-1">Due Date</label>
                        <input type="date" name="dueDate" class="form-input w-full" required>
                    </div>
                </div>
                <div class="flex justify-end pt-4">
                    <button type="submit" class="cta-button px-6 py-2 rounded-lg">Assign Task</button>
                </div>
            `;
            createTaskModal.style.display = 'flex';
        }

        async function handleCreateTask(e) {
            e.preventDefault();
            const form = e.target;
            const assigneeId = form.assigneeId.value;
            const assignee = employees.find(emp => emp.id === assigneeId);

            const taskData = {
                title: form.title.value,
                description: form.description.value,
                assigneeId: assigneeId,
                assigneeName: assignee.name,
                dueDate: form.dueDate.value,
                status: 'pending',
                creatorId: currentUser.uid,
                createdAt: new Date()
            };

            try {
                await addDoc(collection(db, "workspaces", currentWorkspaceId, "tasks"), taskData);
                showToast('Task created successfully!', 'success');
                closeAllModals();
                renderTasksPage();
            } catch (error) {
                console.error("Error creating task:", error);
                showToast(`Error: ${error.message}`, 'error');
            }
        }

        async function handleTaskStatusChange(taskId, isCompleted) {
            const taskRef = doc(db, "workspaces", currentWorkspaceId, "tasks", taskId);
            const newStatus = isCompleted ? 'completed' : 'pending';
            try {
                await updateDoc(taskRef, { status: newStatus });
                showToast(`Task marked as ${newStatus}.`, 'success');
                renderTasksPage(); // Re-render to reflect the change
            } catch (error) {
                console.error("Error updating task status:", error);
                showToast(`Error: ${error.message}`, 'error');
            }
        }

        // --- Time Off Page ---
        async function renderTimeOffPage() {
            if (!checkPlanPermission('Pro')) {
                showPage('dashboard');
                showToast('Upgrade to the Pro plan to access Time Off management.', 'error');
                return;
            }
            const container = document.getElementById('time-off-container');
            const userRole = currentUserData.workspaces[currentWorkspaceId];
            const isAdminOrManager = userRole === 'Admin' || userRole === 'Manager';

            let headerHtml = `
                <div class="flex flex-col md:flex-row justify-between md:items-center mb-8 gap-4">
                    <h2 class="text-3xl font-bold text-white">${isAdminOrManager ? 'Time Off Dashboard' : 'My Time Off'}</h2>
                    <button id="request-time-off-btn" class="cta-button px-4 py-2 rounded-lg font-semibold">Request Time Off</button>
                </div>
            `;
            
            let contentHtml = isAdminOrManager ? renderManagerTimeOffView() : renderEmployeeTimeOffView();
            container.innerHTML = headerHtml + contentHtml;

            document.getElementById('request-time-off-btn').addEventListener('click', openRequestTimeOffModal);
            if (isAdminOrManager) {
                 container.querySelectorAll('.approve-btn, .deny-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const requestId = e.target.dataset.id;
                        const action = e.target.dataset.action;
                        handleTimeOffApproval(requestId, action);
                    });
                });
            }
        }

        function renderEmployeeTimeOffView() {
            const myRequests = timeOffRequests.filter(r => r.userId === currentUser.uid);
            
            // Placeholder balances
            const balancesHtml = `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                    <div class="card p-4 text-center"><p class="text-gray-400">Vacation Balance</p><p class="text-2xl font-bold text-white">80 <span class="text-base font-normal">hours</span></p></div>
                    <div class="card p-4 text-center"><p class="text-gray-400">Sick Leave Balance</p><p class="text-2xl font-bold text-white">40 <span class="text-base font-normal">hours</span></p></div>
                    <div class="card p-4 text-center"><p class="text-gray-400">Personal Time</p><p class="text-2xl font-bold text-white">16 <span class="text-base font-normal">hours</span></p></div>
                </div>
            `;

            let requestsHtml;
            if (myRequests.length === 0) {
                 requestsHtml = '<div class="card p-8 text-center"><p class="text-gray-400">You have not made any time off requests.</p></div>';
            } else {
                requestsHtml = `
                    <h3 class="text-xl font-semibold text-white mb-4">My Requests</h3>
                    <div class="card p-0 overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full text-left">
                                <thead class="bg-gray-800"><tr>
                                    <th class="p-4 font-semibold">Type</th>
                                    <th class="p-4 font-semibold">Dates</th>
                                    <th class="p-4 font-semibold">Status</th>
                                </tr></thead>
                                <tbody>
                                ${myRequests.map(req => `
                                    <tr class="border-b border-gray-700">
                                        <td class="p-4">${req.type}</td>
                                        <td class="p-4">${req.startDate} to ${req.endDate}</td>
                                        <td class="p-4"><span class="status-badge status-${req.status}">${req.status}</span></td>
                                    </tr>
                                `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }
            
            return balancesHtml + requestsHtml;
        }

        function renderManagerTimeOffView() {
             const pendingRequests = timeOffRequests.filter(r => r.status === 'pending');
             let requestsHtml;
             if (pendingRequests.length === 0) {
                 requestsHtml = '<div class="card p-8 text-center"><p class="text-gray-400">No pending time off requests.</p></div>';
             } else {
                 requestsHtml = `
                    <h3 class="text-xl font-semibold text-white mb-4">Pending Requests</h3>
                    <div class="card p-0 overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full text-left">
                                <thead class="bg-gray-800"><tr>
                                    <th class="p-4 font-semibold">Employee</th>
                                    <th class="p-4 font-semibold">Type</th>
                                    <th class="p-4 font-semibold">Dates</th>
                                    <th class="p-4 font-semibold">Actions</th>
                                </tr></thead>
                                <tbody>
                                ${pendingRequests.map(req => `
                                    <tr class="border-b border-gray-700">
                                        <td class="p-4">${employees.find(e => e.id === req.userId)?.name || 'Unknown'}</td>
                                        <td class="p-4">${req.type}</td>
                                        <td class="p-4">${req.startDate} to ${req.endDate}</td>
                                        <td class="p-4">
                                            <button data-id="${req.id}" data-action="approved" class="approve-btn text-green-400 hover:text-green-300 mr-2">Approve</button>
                                            <button data-id="${req.id}" data-action="denied" class="deny-btn text-red-400 hover:text-red-300">Deny</button>
                                        </td>
                                    </tr>
                                `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
             }
             return requestsHtml;
        }

        function openRequestTimeOffModal() {
            requestTimeOffForm.innerHTML = `
                <div>
                    <label class="block text-gray-300 mb-1">Leave Type</label>
                    <select name="type" class="form-select w-full" required>
                        <option value="Vacation">Vacation</option>
                        <option value="Sick Leave">Sick Leave</option>
                        <option value="Personal">Personal</option>
                    </select>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                     <div>
                        <label class="block text-gray-300 mb-1">Start Date</label>
                        <input type="date" name="startDate" class="form-input w-full" required>
                    </div>
                     <div>
                        <label class="block text-gray-300 mb-1">End Date</label>
                        <input type="date" name="endDate" class="form-input w-full" required>
                    </div>
                </div>
                <div><label class="block text-gray-300 mb-1">Reason (optional)</label><textarea name="reason" class="form-textarea w-full" rows="3"></textarea></div>
                <div class="flex justify-end pt-4">
                    <button type="submit" class="cta-button px-6 py-2 rounded-lg">Submit Request</button>
                </div>
            `;
            requestTimeOffModal.style.display = 'flex';
        }

        async function handleRequestTimeOff(e) {
            e.preventDefault();
            const form = e.target;
            const requestData = {
                userId: currentUser.uid,
                type: form.type.value,
                startDate: form.startDate.value,
                endDate: form.endDate.value,
                reason: form.reason.value,
                status: 'pending',
                requestedAt: new Date()
            };
            
            try {
                await addDoc(collection(db, "workspaces", currentWorkspaceId, "timeOffRequests"), requestData);
                showToast('Time off request submitted!', 'success');
                closeAllModals();
                renderTimeOffPage();
            } catch (error) {
                console.error("Error submitting request:", error);
                showToast(`Error: ${error.message}`, 'error');
            }
        }

        async function handleTimeOffApproval(requestId, action) {
            const requestRef = doc(db, "workspaces", currentWorkspaceId, "timeOffRequests", requestId);
            try {
                await updateDoc(requestRef, { status: action });
                showToast(`Request has been ${action}.`, 'success');
                renderTimeOffPage();
            } catch (error) {
                 console.error("Error updating request:", error);
                showToast(`Error: ${error.message}`, 'error');
            }
        }
        
        // --- Pay Stubs Page ---
        async function renderPayStubsPage() {
             if (!checkPlanPermission('Enterprise')) {
                showPage('dashboard');
                showToast('Upgrade to the Enterprise plan to access Pay Stubs.', 'error');
                return;
            }
            const container = document.getElementById('pay-stubs-container');
            const myStubs = payStubs.filter(s => s.userId === currentUser.uid);

            let stubsHtml;
            if(myStubs.length === 0) {
                stubsHtml = '<div class="card p-8 text-center"><p class="text-gray-400">No pay stubs are available.</p></div>';
            } else {
                stubsHtml = `
                    <div class="card p-0 overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full text-left">
                                <thead class="bg-gray-800"><tr>
                                    <th class="p-4 font-semibold">Pay Period</th>
                                    <th class="p-4 font-semibold">Pay Date</th>
                                    <th class="p-4 font-semibold">Net Pay</th>
                                    <th class="p-4 font-semibold">Actions</th>
                                </tr></thead>
                                <tbody>
                                ${myStubs.map(stub => `
                                    <tr class="border-b border-gray-700">
                                        <td class="p-4">${stub.periodStart} - ${stub.periodEnd}</td>
                                        <td class="p-4">${stub.payDate}</td>
                                        <td class="p-4 font-semibold">$${stub.netPay.toFixed(2)}</td>
                                        <td class="p-4"><button data-stub-id="${stub.id}" class="view-stub-btn secondary-button px-3 py-1 rounded-md text-sm">View</button></td>
                                    </tr>
                                `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }

            container.innerHTML = `
                <h2 class="text-3xl font-bold text-white mb-8">My Pay Stubs</h2>
                ${stubsHtml}
            `;
            
            container.querySelectorAll('.view-stub-btn').forEach(btn => {
                btn.addEventListener('click', (e) => viewPayStub(e.target.dataset.stubId));
            });
        }

        // --- Payroll Management ---
        function renderManagePayroll() {
            manageSidebar.innerHTML = `
                <h3 class="text-xl font-bold text-white mb-4">Payroll Tools</h3>
                <div class="space-y-2">
                    <button id="run-payroll-btn" class="w-full secondary-button px-4 py-2 rounded-lg text-sm">Run New Pay Run</button>
                    <button id="payroll-settings-btn" class="w-full secondary-button px-4 py-2 rounded-lg text-sm">Payroll Settings</button>
                </div>
            `;
            manageContent.innerHTML = '<div class="card p-6"><p class="text-gray-400">Select a tool from the sidebar to begin.</p></div>';
            
            document.getElementById('run-payroll-btn').addEventListener('click', renderRunPayroll);
            document.getElementById('payroll-settings-btn').addEventListener('click', renderPayrollSettingsInManage);
        }
        
        async function renderPayrollSettingsInManage() {
            const payrollConfig = currentWorkspaceData.payrollConfig || {};
            manageContent.innerHTML = `
                <h3 class="text-xl font-semibold text-white mb-4">Payroll Settings</h3>
                <form id="manage-payroll-settings-form">
                    <div class="card p-6 space-y-6">
                        <div>
                            <label class="block text-gray-400 mb-1">Pay Schedule</label>
                            <select name="paySchedule" class="form-select w-full md:w-1/2">
                                <option value="Weekly" ${payrollConfig.paySchedule === 'Weekly' ? 'selected' : ''}>Weekly</option>
                                <option value="Bi-Weekly" ${payrollConfig.paySchedule === 'Bi-Weekly' ? 'selected' : ''}>Bi-Weekly</option>
                                <option value="Semi-Monthly" ${payrollConfig.paySchedule === 'Semi-Monthly' ? 'selected' : ''}>Semi-Monthly</option>
                                <option value="Monthly" ${payrollConfig.paySchedule === 'Monthly' ? 'selected' : ''}>Monthly</option>
                            </select>
                        </div>
                         <div>
                            <label class="block text-gray-400 mb-1">Company Tax ID (EIN)</label>
                            <input type="text" name="taxId" class="form-input w-full md:w-1/2" value="${payrollConfig.taxId || ''}">
                        </div>
                        <div class="flex justify-end mt-6">
                            <button type="submit" class="cta-button px-6 py-2 rounded-lg">Save Settings</button>
                        </div>
                    </div>
                </form>
            `;
            
            document.getElementById('manage-payroll-settings-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const form = e.target;
                const updatedConfig = {
                    paySchedule: form.paySchedule.value,
                    taxId: form.taxId.value
                };
                
                await updateDoc(doc(db, "workspaces", currentWorkspaceId), { payrollConfig: updatedConfig });
                showToast('Payroll settings saved!', 'success');
                await loadWorkspaceData(currentWorkspaceId); // reload data
            });
        }

        function renderRunPayroll() {
            manageContent.innerHTML = `
                <h3 class="text-xl font-semibold text-white mb-4">Run Payroll</h3>
                <div class="card p-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-gray-400 mb-1">Pay Period Start</label>
                            <input type="date" id="payroll-start-date" class="form-input w-full">
                        </div>
                        <div>
                            <label class="block text-gray-400 mb-1">Pay Period End</label>
                            <input type="date" id="payroll-end-date" class="form-input w-full">
                        </div>
                        <div class="self-end">
                            <button id="generate-payroll-preview-btn" class="w-full cta-button px-4 py-2 rounded-lg">Generate Preview</button>
                        </div>
                    </div>
                </div>
                <div id="payroll-preview-container" class="mt-8"></div>
            `;
            
            document.getElementById('generate-payroll-preview-btn').addEventListener('click', renderPayrollPreview);
        }

        function renderPayrollPreview() {
            const container = document.getElementById('payroll-preview-container');
            let reportHtml = `
                <h3 class="text-xl font-semibold text-white mb-4">Payroll Preview</h3>
                 <div class="card p-0 overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-gray-800"><tr>
                                <th class="p-4 font-semibold">Employee</th>
                                <th class="p-4 font-semibold">Gross Pay</th>
                                <th class="p-4 font-semibold">Taxes</th>
                                <th class="p-4 font-semibold">Deductions</th>
                                <th class="p-4 font-semibold">Net Pay</th>
                            </tr></thead>
                            <tbody>
            `;
            employees.forEach(emp => {
                const empTimesheets = timesheets[emp.id] || {};
                const overtimeRules = currentWorkspaceData.rules?.overtime || { enabled: false, weekly: 40 };
                
                let totalHours = 0;
                Object.values(empTimesheets).forEach(day => {
                   totalHours += calculateTotalHoursFromPairs(processDayPunches(emp.id, null, day.punches).pairs);
                });

                let regularHours = totalHours;
                let overtimeHours = 0;
                if (overtimeRules.enabled && totalHours > overtimeRules.weekly) {
                    overtimeHours = totalHours - overtimeRules.weekly;
                    regularHours = overtimeRules.weekly;
                }

                const grossPay = (regularHours * (emp.hourlyRate || 0)) + (overtimeHours * (emp.hourlyRate || 0) * 1.5);
                
                const payrollInfo = emp.payroll || {};
                const taxes = calculateTaxes(grossPay, payrollInfo.filingStatus, payrollInfo.allowances);
                
                const empDeductions = payrollInfo.deductions || [];
                let totalDeductions = 0;
                empDeductions.forEach(ded => {
                    if (ded.type === 'fixed') {
                        totalDeductions += ded.amount;
                    } else if (ded.type === 'percent') {
                        totalDeductions += grossPay * (ded.amount / 100);
                    }
                });

                const netPay = grossPay - taxes.total - totalDeductions;
                
                reportHtml += `
                     <tr class="border-b border-gray-700">
                        <td class="p-4">${emp.name}</td>
                        <td class="p-4">$${grossPay.toFixed(2)}</td>
                        <td class="p-4 text-red-400" title="Fed: $${taxes.federal.toFixed(2)}, SS: $${taxes.socialSecurity.toFixed(2)}, Med: $${taxes.medicare.toFixed(2)}">-$${taxes.total.toFixed(2)}</td>
                        <td class="p-4 text-red-400">-$${totalDeductions.toFixed(2)}</td>
                        <td class="p-4 font-bold text-emerald-400">$${netPay.toFixed(2)}</td>
                    </tr>
                `;
            });

            reportHtml += '</tbody></table></div></div><div class="flex justify-end mt-6"><button id="finalize-payroll-btn" class="cta-button px-6 py-2 rounded-lg">Finalize Pay Run</button></div>';
            container.innerHTML = reportHtml;
            
            document.getElementById('finalize-payroll-btn').addEventListener('click', handleFinalizePayRun);
        }

        async function handleFinalizePayRun() {
            const startDate = document.getElementById('payroll-start-date').value;
            const endDate = document.getElementById('payroll-end-date').value;

            if (!startDate || !endDate) {
                showToast('Please select a start and end date for the pay period.', 'error');
                return;
            }

            const finalizeBtn = document.getElementById('finalize-payroll-btn');
            finalizeBtn.disabled = true;
            finalizeBtn.textContent = 'Finalizing...';

            try {
                const payStubsCollectionRef = collection(db, `workspaces/${currentWorkspaceId}/payStubs`);

                for (const emp of employees) {
                    const empTimesheets = timesheets[emp.id] || {};
                    const overtimeRules = currentWorkspaceData.rules?.overtime || { enabled: false, weekly: 40 };
                    
                    let totalHours = 0;
                     Object.values(empTimesheets).forEach(day => {
                       totalHours += calculateTotalHoursFromPairs(processDayPunches(emp.id, null, day.punches).pairs);
                    });

                    let regularHours = totalHours;
                    let overtimeHours = 0;
                    if (overtimeRules.enabled && totalHours > overtimeRules.weekly) {
                        overtimeHours = totalHours - overtimeRules.weekly;
                        regularHours = overtimeRules.weekly;
                    }

                    const grossPay = (regularHours * (emp.hourlyRate || 0)) + (overtimeHours * (emp.hourlyRate || 0) * 1.5);
                    const payrollInfo = emp.payroll || {};
                    const taxes = calculateTaxes(grossPay, payrollInfo.filingStatus, payrollInfo.allowances);
                    
                    const empDeductions = payrollInfo.deductions || [];
                    const calculatedDeductions = [];
                    let totalDeductions = 0;
                    empDeductions.forEach(ded => {
                        let amount = 0;
                        if (ded.type === 'fixed') {
                            amount = ded.amount;
                        } else if (ded.type === 'percent') {
                            amount = grossPay * (ded.amount / 100);
                        }
                        totalDeductions += amount;
                        calculatedDeductions.push({ name: ded.name, amount });
                    });

                    const netPay = grossPay - taxes.total - totalDeductions;

                    const payStubData = {
                        userId: emp.id,
                        periodStart: startDate,
                        periodEnd: endDate,
                        payDate: new Date().toISOString().split('T')[0],
                        grossPay,
                        netPay,
                        taxes,
                        deductions: calculatedDeductions,
                        hourlyRate: emp.hourlyRate || 0,
                        regularHours,
                        overtimeHours,
                        totalHours,
                        createdAt: new Date()
                    };
                    
                    await addDoc(payStubsCollectionRef, payStubData);
                }
                showToast('Pay run finalized and all pay stubs have been generated!', 'success');
                manageContent.innerHTML = '<div class="card p-6"><p>Pay run successfully finalized. Employees can now view their new pay stubs.</p></div>';
            } catch (error) {
                console.error("Error finalizing pay run:", error);
                showToast(`Error: ${error.message}`, 'error');
                finalizeBtn.disabled = false;
                finalizeBtn.textContent = 'Finalize Pay Run';
            }
        }

        
        function viewPayStub(stubId) {
            const stub = payStubs.find(s => s.id === stubId);
            if (!stub) return;
            
            const employee = employees.find(e => e.id === stub.userId);
            const contentEl = document.getElementById('pay-stub-content');
            
            const stubDeductions = stub.deductions || [];
            const totalDeductions = stubDeductions.reduce((acc, d) => acc + d.amount, 0);
            
            const stubTaxes = stub.taxes || { federal: 0, socialSecurity: 0, medicare: 0 };
            const totalTaxes = (stubTaxes.federal || 0) + (stubTaxes.socialSecurity || 0) + (stubTaxes.medicare || 0);

            const YTD = { gross: '12,345.67', taxes: '1,234.56', deductions: '567.89', net: '10,543.22' }; // Placeholder YTD data
            
            contentEl.innerHTML = `
                <style>
                    #pay-stub-content { font-family: system-ui, -apple-system, sans-serif; }
                    .stub-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
                    .stub-table th, .stub-table td { text-align: left; padding: 0.6rem 0.5rem; border-bottom: 1px solid #e2e8f0; }
                    .stub-table th { color: #64748b; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; }
                    .stub-table .amount { text-align: right; }
                    .stub-section { margin-bottom: 2rem; }
                    .summary-box { background-color: #f1f5f9; border-radius: 0.5rem; padding: 1.5rem; margin-top: 2rem; }
                    .summary-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; }
                    .summary-item { display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid #e2e8f0; }
                    .summary-item.total { font-weight: bold; font-size: 1.1rem; border-top: 2px solid #94a3b8; margin-top: 0.5rem; }
                </style>
                <header class="flex justify-between items-start mb-8">
                    <div>
                        <h1 class="text-3xl font-bold">${currentWorkspaceData.name}</h1>
                        <p class="text-gray-500">Pay Statement</p>
                    </div>
                    <div class="text-right">
                        <p><strong>Pay Date:</strong> ${stub.payDate}</p>
                        <p><strong>Pay Period:</strong> ${stub.periodStart} to ${stub.periodEnd}</p>
                    </div>
                </header>

                <div class="mb-8 p-4 border rounded-lg">
                    <h2 class="font-bold text-lg">${employee.name}</h2>
                    <p class="text-gray-600">Employee ID: ${employee.employeeId}</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="stub-section">
                        <h3 class="text-xl font-semibold mb-4 border-b pb-2">Earnings</h3>
                        <table class="stub-table">
                            <thead><tr><th>Description</th><th class="amount">Hours</th><th class="amount">Rate</th><th class="amount">Current</th><th class="amount">YTD</th></tr></thead>
                            <tbody>
                                <tr><td>Regular</td><td class="amount">${stub.regularHours.toFixed(2)}</td><td class="amount">$${stub.hourlyRate.toFixed(2)}</td><td class="amount">$${(stub.regularHours * stub.hourlyRate).toFixed(2)}</td><td class="amount">$${YTD.gross}</td></tr>
                                ${stub.overtimeHours > 0 ? `<tr><td>Overtime</td><td class="amount">${stub.overtimeHours.toFixed(2)}</td><td class="amount">$${(stub.hourlyRate * 1.5).toFixed(2)}</td><td class="amount">$${(stub.overtimeHours * stub.hourlyRate * 1.5).toFixed(2)}</td><td class="amount">...</td></tr>` : ''}
                            </tbody>
                        </table>
                    </div>
                    <div class="stub-section">
                         <h3 class="text-xl font-semibold mb-4 border-b pb-2">Taxes</h3>
                        <table class="stub-table">
                            <thead><tr><th>Description</th><th class="amount">Current</th><th class="amount">YTD</th></tr></thead>
                            <tbody>
                                <tr><td>Federal Income Tax</td><td class="amount">-${(stubTaxes.federal).toFixed(2)}</td><td class="amount">...</td></tr>
                                <tr><td>Social Security</td><td class="amount">-${(stubTaxes.socialSecurity).toFixed(2)}</td><td class="amount">...</td></tr>
                                <tr><td>Medicare</td><td class="amount">-${(stubTaxes.medicare).toFixed(2)}</td><td class="amount">...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                ${stubDeductions.length > 0 ? `
                <div class="stub-section">
                    <h3 class="text-xl font-semibold mb-4 border-b pb-2">Deductions</h3>
                    <table class="stub-table">
                        <thead><tr><th>Description</th><th class="amount">Current</th><th class="amount">YTD</th></tr></thead>
                        <tbody>
                            ${stubDeductions.map(d => `<tr><td>${d.name}</td><td class="amount">-${d.amount.toFixed(2)}</td><td class="amount">...</td></tr>`).join('')}
                        </tbody>
                    </table>
                </div>` : ''}

                <div class="summary-box">
                    <h3 class="text-xl font-semibold mb-4 text-center">Summary</h3>
                    <div class="summary-grid">
                         <div>
                            <div class="summary-item"><span>Gross Pay</span><span>$${stub.grossPay.toFixed(2)}</span></div>
                            <div class="summary-item"><span>Total Taxes</span><span>-$${totalTaxes.toFixed(2)}</span></div>
                            <div class="summary-item"><span>Total Deductions</span><span>-$${totalDeductions.toFixed(2)}</span></div>
                         </div>
                         <div>
                            <div class="summary-item"><span>YTD Gross</span><span>$${YTD.gross}</span></div>
                            <div class="summary-item"><span>YTD Taxes</span><span>-$${YTD.taxes}</span></div>
                            <div class="summary-item"><span>YTD Deductions</span><span>-$${YTD.deductions}</span></div>
                         </div>
                    </div>
                    <div class="summary-item total"><span>Net Pay</span><span>$${stub.netPay.toFixed(2)}</span></div>
                </div>
            `;
            
            document.getElementById('pay-stub-modal').style.display = 'flex';
            document.getElementById('print-pay-stub-btn').onclick = () => window.print();
        }

        // --- MANAGE DEPARTMENTS ---
        function renderManageDepartments() {
            manageSidebar.innerHTML = `
                <h3 class="text-xl font-bold text-white mb-4">Add Department</h3>
                <form id="add-department-form" class="space-y-4">
                    <div>
                        <label for="new-department-name" class="block text-sm font-medium text-gray-300">Department Name</label>
                        <input type="text" id="new-department-name" class="form-input w-full mt-1" required>
                    </div>
                    <button type="submit" class="w-full cta-button px-4 py-2 rounded-lg">Add Department</button>
                </form>
            `;
            const departments = currentWorkspaceData.departments || [];
            let listHtml = departments.map(dept => `
                <li class="flex justify-between items-center p-3 rounded-lg hover:bg-gray-800">
                    <span>${dept}</span>
                    <button class="text-red-400 hover:text-red-300 font-semibold" data-dept="${dept}">Remove</button>
                </li>
            `).join('');
            
            manageContent.innerHTML = `<div class="card p-6"><h3 class="text-xl font-semibold text-white mb-4">Existing Departments</h3><ul class="space-y-2">${listHtml}</ul></div>`;

            document.getElementById('add-department-form').addEventListener('submit', handleAddDepartment);
            manageContent.querySelectorAll('button[data-dept]').forEach(btn => {
                btn.addEventListener('click', () => handleRemoveDepartment(btn.dataset.dept));
            });
        }

        async function handleAddDepartment(e) {
            e.preventDefault();
            const newDept = document.getElementById('new-department-name').value;
            if (!newDept) return;
            await updateDoc(doc(db, "workspaces", currentWorkspaceId), {
                departments: arrayUnion(newDept)
            });
            showToast('Department added.', 'success');
            renderManagePage('departments');
        }

        async function handleRemoveDepartment(deptName) {
            if (confirm(`Are you sure you want to remove the "${deptName}" department?`)) {
                await updateDoc(doc(db, "workspaces", currentWorkspaceId), {
                    departments: arrayRemove(deptName)
                });
                showToast('Department removed.', 'success');
                renderManagePage('departments');
            }
        }


        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            setupEventListeners();
        });

    </script>
</body>
</html>