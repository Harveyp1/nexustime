<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NexusTime App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #111827; color: #E5E7EB; }
        .cta-button { transition: all 0.3s ease; background-color: #34D399; color: #111827; }
        .secondary-button { background-color: transparent; border: 1px solid #34D399; color: #34D399; transition: all 0.3s ease; }
        .danger-button { background-color: transparent; border: 1px solid #F87171; color: #F87171; transition: all 0.3s ease; }
        .card { background-color: #1F2937; border: 1px solid #374151; }
        .header { background-color: rgba(17, 24, 39, 0.8); backdrop-filter: blur(10px); }
        .page { display: none; }
        .page.active { display: block; }
        .form-input, .form-select { background-color: #1F2937; border: 1px solid #374151; color: #E5E7EB; border-radius: 0.5rem; }
        .form-input:focus, .form-select:focus { outline: none; border-color: #34D399; box-shadow: 0 0 0 2px rgba(52, 211, 153, 0.5); }
        .form-select { -webkit-appearance: none; -moz-appearance: none; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke-width='2' stroke='%2334D399'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M19.5 8.25l-7.5 7.5-7.5-7.5' /%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 0.75rem center; background-size: 1.5em 1.5em; padding-right: 2.5rem; }
        .modal-overlay { background-color: rgba(17, 24, 39, 0.8); backdrop-filter: blur(4px); }
        .timesheet-table th, .timesheet-table td { text-align: center; padding: 0.75rem 0.5rem; border: 1px solid #374151; white-space: nowrap; }
        .timesheet-table .row-header { text-align: left; padding-left: 1rem; font-weight: 600; background-color: #374151; }
        .day-header { background-color: #374151; }
        .day-header.editable:hover { background-color: #4B5563; cursor: pointer; }
        .locked-day { background-color: #4B5563; color: #9CA3AF; cursor: not-allowed; }
        input[type="checkbox"]:disabled + span { color: #6B7280; }
        .tab-button { border-bottom: 2px solid transparent; }
        .tab-button.active { color: #34D399; border-bottom-color: #34D399; }
        .status-badge { padding: 0.125rem 0.5rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 500; }
        .status-active { background-color: #10B981; color: white; }
        .status-inactive { background-color: #6B7280; color: white; }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">
    <!-- Header -->
    <header class="header sticky top-0 z-30">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <a href="index.html">
                <img src="https://raw.githubusercontent.com/Harveyp1/nexustime/main/nexustimelogo.png" alt="NexusTime Logo" class="h-10" onerror="this.onerror=null; this.src='https://placehold.co/160x40/111827/34D399?text=NexusTime';">
            </a>
            <nav id="app-nav" class="hidden items-center space-x-6">
                 <a href="#dashboard" data-page="dashboard" class="nav-link text-gray-400 hover:text-emerald-400">Dashboard</a>
                 <a href="#timesheet" data-page="timesheet" class="nav-link text-gray-400 hover:text-emerald-400">Timesheets</a>
                 <a href="#manage" data-page="manage" class="nav-link text-gray-400 hover:text-emerald-400">Manage</a>
                 <a href="#settings" data-page="settings" class="nav-link text-gray-400 hover:text-emerald-400">Settings</a>
                 <a href="#company-selection" data-page="company-selection" class="nav-link text-gray-400 hover:text-emerald-400">Switch Workspace</a>
                 <button id="logout-button" class="secondary-button px-4 py-2 rounded-lg text-sm font-medium">Log Out</button>
            </nav>
        </div>
    </header>

    <main>
        <div id="login" class="page">
            <section class="py-20"><div class="max-w-md mx-auto card p-8 rounded-xl mt-10"><div class="text-center mb-8"><h3 class="text-3xl font-bold text-white">Welcome Back</h3><p class="text-gray-400 mt-2">Log in to manage your workspaces.</p></div><form id="login-form"><div class="mb-4"><label for="login-email" class="block text-gray-300 mb-2">Email</label><input type="email" id="login-email" class="w-full p-3 form-input" value="manager@nexustime.com" required></div><div class="mb-6"><label for="login-password" class="block text-gray-300 mb-2">Password</label><input type="password" id="login-password" class="w-full p-3 form-input" value="password123" required></div><div class="text-center"><button type="submit" class="w-full cta-button px-8 py-3 rounded-lg font-semibold">Log In</button></div></form></div></section>
        </div>
        <div id="signup" class="page">
             <section class="py-20"><div class="max-w-md mx-auto card p-8 rounded-xl mt-10"><div class="text-center mb-8"><h3 class="text-3xl font-bold text-white">Create Your Account</h3><p class="text-gray-400 mt-2">Start your free trial today.</p></div><form id="signup-form"><div class="mb-4"><label for="signup-company-name" class="block text-gray-300 mb-2">Company Name</label><input type="text" id="signup-company-name" class="w-full p-3 form-input" placeholder="Your Company Inc." required></div><div class="mb-4"><label for="signup-email" class="block text-gray-300 mb-2">Email</label><input type="email" id="signup-email" class="w-full p-3 form-input" placeholder="you@company.com" required></div><div class="mb-6"><label for="signup-password" class="block text-gray-300 mb-2">Password</label><input type="password" id="signup-password" class="w-full p-3 form-input" placeholder="At least 6 characters" required></div><div class="text-center"><button type="submit" class="w-full cta-button px-8 py-3 rounded-lg font-semibold">Sign Up</button></div></form></div></section>
        </div>
        <div id="company-selection" class="page">
            <section class="py-20"><div class="container mx-auto px-6"><div class="text-center mb-12"><h2 class="text-4xl font-bold text-white">Select a Workspace</h2><p class="text-gray-400 mt-2">Choose which workspace you want to manage.</p></div><div id="workspace-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 max-w-4xl mx-auto"></div></div></section>
        </div>

        <div id="dashboard" class="page">
            <section class="py-12"><div class="container mx-auto px-6"><div class="flex flex-col md:flex-row justify-between md:items-center mb-8 gap-4"><h2 id="dashboard-title" class="text-3xl font-bold text-white"></h2></div><div id="dashboard-widgets" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8"></div><div class="grid grid-cols-1 lg:grid-cols-5 gap-6 mt-8"><div class="lg:col-span-2 card p-6"><h3 class="text-xl font-semibold text-white mb-4">Hours by Project</h3><canvas id="project-chart"></canvas></div><div class="lg:col-span-3 card p-6"><h3 class="text-xl font-semibold text-white mb-4">Hours by Employee</h3><canvas id="employee-chart"></canvas></div></div><div class="card p-0 overflow-hidden mt-8"><div class="p-6 flex justify-between items-center"><h3 class="text-xl font-semibold text-white">Recent Timesheet Entries</h3><a href="#timesheet" data-page="timesheet" class="nav-link secondary-button px-4 py-2 rounded-lg text-sm">View Full Timesheet</a></div><div class="overflow-x-auto"><table class="w-full text-left"><thead class="bg-gray-800"><tr><th class="p-4 font-semibold">Employee</th><th class="p-4 font-semibold">Date</th><th class="p-4 font-semibold">Hours</th></tr></thead><tbody id="timesheet-table-body"></tbody></table></div></div></div></section>
        </div>
        
        <div id="manage" class="page">
            <section class="py-12"><div class="container mx-auto px-6"><div class="flex justify-between items-center mb-8"><h2 class="text-3xl font-bold text-white">Manage Workspace</h2><button id="add-new-button" class="cta-button px-4 py-2 rounded-lg text-sm"></button></div><div class="border-b border-gray-700 mb-8"><nav class="flex space-x-8" id="manage-tabs"><button data-tab="employees" class="tab-button py-4 px-1 font-medium text-lg active">Employees</button><button data-tab="projects" class="tab-button py-4 px-1 font-medium text-lg">Projects</button></nav></div><div id="manage-content"></div></div></section>
        </div>
        <div id="settings" class="page">
            <section class="py-12"><div class="container mx-auto px-6 max-w-4xl"><h2 class="text-3xl font-bold text-white mb-8">Settings</h2><div class="space-y-12"><div class="card p-8"><h3 class="text-xl font-semibold text-white mb-4">User Profile</h3><form id="profile-form" class="space-y-4"><div><label class="block text-gray-400">Name</label><input type="text" id="profile-name" class="form-input w-full mt-1"></div><div><label class="block text-gray-400">Email</label><input type="email" id="profile-email" class="form-input w-full mt-1" disabled></div><button type="submit" class="cta-button px-6 py-2 rounded-lg">Save Changes</button></form></div><div class="card p-8"><h3 class="text-xl font-semibold text-white mb-4">Workspace & Billing</h3><div id="workspace-settings-content"></div></div></div></div></section>
        </div>

        <div id="timesheet" class="page">
             <section class="py-12">
                <div class="container mx-auto px-6">
                    <div class="flex flex-col md:flex-row justify-between md:items-center mb-4 gap-4">
                        <h2 class="text-3xl font-bold text-white">Work Area</h2>
                        <div class="flex gap-4 items-center">
                            <button id="enter-punch-btn" class="secondary-button px-4 py-2 rounded-lg text-sm">Enter Punch</button>
                            <button class="secondary-button px-4 py-2 rounded-lg text-sm">Enter Hour</button>
                            <button id="daily-details-btn" class="secondary-button px-4 py-2 rounded-lg text-sm">Daily Details</button>
                        </div>
                    </div>
                    
                    <div id="employee-details-container" class="card p-4 mb-8"></div>

                    <div class="card p-6">
                        <div class="flex justify-between items-center mb-4">
                            <button id="prev-week-btn" class="secondary-button p-2 rounded-full"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg></button>
                            <div id="timesheet-filter-container" class="flex gap-4 items-center">
                                <h3 id="week-range-display" class="text-xl font-semibold text-white text-center"></h3>
                            </div>
                            <button id="next-week-btn" class="secondary-button p-2 rounded-full"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg></button>
                        </div>
                        <div id="spreadsheet-container" class="overflow-x-auto"></div>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <div id="punch-modal" class="fixed inset-0 z-50 modal-overlay items-center justify-center hidden"><div class="card rounded-lg shadow-xl m-8 max-w-lg w-full"><div class="p-6 border-b border-gray-700 flex justify-between items-center"><h3 id="punch-modal-title" class="text-xl font-semibold text-white"></h3><button id="close-punch-modal-button" class="text-gray-400 hover:text-white text-3xl">&times;</button></div><div class="p-6"><div id="punch-list" class="space-y-2 mb-6"></div><form id="add-punch-form" class="space-y-4 border-t border-gray-700 pt-6"><h4 class="font-semibold text-white">Add New Punch</h4><div class="grid grid-cols-2 gap-4"><div><label for="punch-time" class="block text-gray-300 mb-2">Time</label><input type="time" id="punch-time" class="w-full p-3 form-input" required></div><div><label for="punch-type" class="block text-gray-300 mb-2">Type</label><select id="punch-type" class="w-full p-3 form-select" required><option value="in">Clock In</option><option value="out">Clock Out</option><option value="lunch-start">Start Lunch</option><option value="lunch-end">End Lunch</option></select></div></div><div class="text-right"><button type="submit" class="cta-button px-6 py-2 rounded-lg">Add Punch</button></div></form></div></div></div>
    <div id="add-employee-modal" class="fixed inset-0 z-50 modal-overlay items-center justify-center hidden"><div class="card rounded-lg shadow-xl m-8 max-w-3xl w-full"><div class="p-6 border-b border-gray-700 flex justify-between items-center"><h3 class="text-xl font-semibold text-white">Add New Employee</h3><button class="text-gray-400 hover:text-white text-3xl close-add-modal-btn">&times;</button></div><form id="add-employee-form" class="p-6 space-y-4"></form></div></div>
    <div id="edit-employee-modal" class="fixed inset-0 z-50 modal-overlay items-center justify-center hidden"><div class="card rounded-lg shadow-xl m-8 max-w-3xl w-full"><div class="p-6 border-b border-gray-700 flex justify-between items-center"><h3 class="text-xl font-semibold text-white">Edit Employee</h3><button class="text-gray-400 hover:text-white text-3xl close-add-modal-btn">&times;</button></div><form id="edit-employee-form" class="p-6 space-y-4"></form></div></div>
    <div id="add-project-modal" class="fixed inset-0 z-50 modal-overlay items-center justify-center hidden"><div class="card rounded-lg shadow-xl m-8 max-w-lg w-full"><div class="p-6 border-b border-gray-700 flex justify-between items-center"><h3 class="text-xl font-semibold text-white">Add New Project</h3><button class="text-gray-400 hover:text-white text-3xl close-add-modal-btn">&times;</button></div><form id="add-project-form" class="p-6 space-y-4"><div><label for="new-project-name" class="block text-gray-300 mb-2">Project Name</label><input type="text" id="new-project-name" class="w-full p-3 form-input" required></div><div class="flex justify-end gap-4 pt-4"><button type="button" class="secondary-button px-6 py-2 rounded-lg close-add-modal-btn">Cancel</button><button type="submit" class="cta-button px-6 py-2 rounded-lg">Add Project</button></div></form></div></div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const mockData = {
                user: { name: "Heidi Aquino", email: "manager@nexustime.com", plan: "Pro" },
                workspaces: { 'ws-acme': { 
                    name: 'Acme Corp', 
                    plan: 'Pro',
                    departments: ['IT Department', 'Marketing', 'Sales', 'Human Resources'],
                    employeeTypes: ['Full-time', 'Part-time', 'Contract', 'Temporary'],
                    payTypes: ['Hourly', 'Salary', 'Contract', 'Temporary']
                } },
                employees: { 
                    'ws-acme': [
                        { id: '101785', firstName: 'Javier', middleName: '', lastName: 'Pizaña', name: 'Javier Pizaña', status: 'Active', hireDate: '2025-06-30', cardNumber: 'C123', department: 'IT Department', supervisor: 'Heidi Aquino', payType: 'Hourly', employeeType: 'Full-time' },
                        { id: '101786', firstName: 'Alice', middleName: 'M', lastName: 'Johnson', name: 'Alice Johnson', status: 'Active', hireDate: '2024-05-15', cardNumber: 'C456', department: 'Marketing', supervisor: 'Heidi Aquino', payType: 'Hourly', employeeType: 'Full-time' },
                        { id: '101787', firstName: 'Bob', middleName: '', lastName: 'Williams', name: 'Bob Williams', status: 'Inactive', hireDate: '2023-03-01', cardNumber: 'C789', department: 'Sales', supervisor: 'Heidi Aquino', payType: 'Salary', employeeType: 'Full-time' },
                    ] 
                },
                projects: { 'ws-acme': ['Project Phoenix', 'Marketing Campaign'] },
                timesheets: {
                    'ws-acme': {
                        'Javier Pizaña': {
                            '2025-06-09': { punches: [{time: '10:00', type: 'in'}, {time: '12:00', type: 'out'}] },
                            '2025-06-10': { punches: [{time: '10:00', type: 'in'}, {time: '12:00', type: 'out'}, {time: '13:00', type: 'in'}, {time: '17:00', type: 'out'}] },
                        },
                        'Alice Johnson': {
                            '2025-06-16': { punches: [{time: '09:00', type: 'in'}, {time: '17:00', type: 'out'}] },
                        },
                        'Bob Williams': {
                            '2025-06-16': { punches: [{time: '08:30', type: 'in'}, {time: '12:00', type: 'lunch-start'}, {time: '12:30', type: 'lunch-end'}, {time: '16:30', type: 'out'}] }
                        }
                    }
                },
                verification: {
                    'ws-acme': {
                        '101785': { '2025-06-09': { employeeVerified: true, employeeVerificationTimestamp: '6/15/2025, 2:00:00 PM', supervisorVerified: true, supervisorVerificationTimestamp: '6/15/2025, 3:00:00 PM' } },
                        '101786': { '2025-06-16': { employeeVerified: false, supervisorVerified: false } }
                    }
                }
            };

            let isLoggedIn = false;
            let currentWorkspaceId = null;
            let currentWeekOffset = 0;
            let activeEmployeeFilter = null;
            let editingDayData = null;
            let projectChart = null;
            let employeeChart = null;
            let currentManagePage = 1;
            const ITEMS_PER_PAGE = 20;
            let editingEmployeeIndex = null;

            // All DOM elements
            const pages = document.querySelectorAll('.page');
            const appNav = document.getElementById('app-nav');
            const loginForm = document.getElementById('login-form');
            const logoutButton = document.getElementById('logout-button');
            const workspaceListContainer = document.getElementById('workspace-list');
            const dashboardTitle = document.getElementById('dashboard-title');
            const dashboardWidgets = document.getElementById('dashboard-widgets');
            const timesheetTableBody = document.getElementById('timesheet-table-body');
            const timesheetFilterContainer = document.getElementById('timesheet-filter-container');
            const spreadsheetContainer = document.getElementById('spreadsheet-container');
            const weekRangeDisplay = document.getElementById('week-range-display');
            const prevWeekBtn = document.getElementById('prev-week-btn');
            const nextWeekBtn = document.getElementById('next-week-btn');
            const employeeDetailsContainer = document.getElementById('employee-details-container');
            const manageTabs = document.getElementById('manage-tabs');
            const manageContent = document.getElementById('manage-content');
            const settingsContent = document.getElementById('workspace-settings-content');
            const punchModal = document.getElementById('punch-modal');
            const closePunchModalButton = document.getElementById('close-punch-modal-button');
            const addPunchForm = document.getElementById('add-punch-form');
            const punchList = document.getElementById('punch-list');
            const punchModalTitle = document.getElementById('punch-modal-title');
            const addNewButton = document.getElementById('add-new-button');
            const enterPunchBtn = document.getElementById('enter-punch-btn');
            const dailyDetailsBtn = document.getElementById('daily-details-btn');
            const addEmployeeModal = document.getElementById('add-employee-modal');
            const editEmployeeModal = document.getElementById('edit-employee-modal');
            const addProjectModal = document.getElementById('add-project-modal');
            const addEmployeeForm = document.getElementById('add-employee-form');
            const editEmployeeForm = document.getElementById('edit-employee-form');
            const addProjectForm = document.getElementById('add-project-form');
            
            const showPage = (pageId) => {
                pages.forEach(page => page.classList.remove('active'));
                const targetPage = document.getElementById(pageId);
                if (targetPage) {
                    targetPage.classList.add('active');
                    window.scrollTo(0, 0);
                    if (pageId === 'dashboard') renderDashboard();
                    if (pageId === 'timesheet') renderTimesheetPage();
                    if (pageId === 'manage') renderManagePage();
                    if (pageId === 'settings') renderSettingsPage();
                    if (pageId === 'company-selection') renderWorkspaceSelection();
                }
            };
            
            const updateNav = () => { if (appNav) appNav.style.display = isLoggedIn ? 'flex' : 'none'; };

            function setupEventListeners() {
                if (loginForm) loginForm.addEventListener('submit', (e) => { e.preventDefault(); isLoggedIn = true; currentWorkspaceId = 'ws-acme'; activeEmployeeFilter = mockData.employees[currentWorkspaceId][0].id; updateNav(); showPage('dashboard'); });
                if (logoutButton) logoutButton.addEventListener('click', () => { isLoggedIn = false; currentWorkspaceId = null; window.location.href = 'index.html'; });
                if (prevWeekBtn) prevWeekBtn.addEventListener('click', () => { currentWeekOffset--; renderTimesheetPage(); });
                if (nextWeekBtn) nextWeekBtn.addEventListener('click', () => { currentWeekOffset++; renderTimesheetPage(); });
                if (manageTabs) manageTabs.addEventListener('click', (e) => { if(e.target.dataset.tab) renderManagePage(e.target.dataset.tab); });
                if (closePunchModalButton) closePunchModalButton.addEventListener('click', closePunchModal);
                if (addPunchForm) addPunchForm.addEventListener('submit', handleAddPunch);
                if (addNewButton) addNewButton.addEventListener('click', handleAddNew);
                if (enterPunchBtn) enterPunchBtn.addEventListener('click', () => openPunchModal(new Date().toISOString().split('T')[0]));
                if (dailyDetailsBtn) dailyDetailsBtn.addEventListener('click', () => openPunchModal(new Date().toISOString().split('T')[0]));
                if (addEmployeeForm) addEmployeeForm.addEventListener('submit', handleAddEmployee);
                if (editEmployeeForm) editEmployeeForm.addEventListener('submit', handleEditEmployee);
                if (addProjectForm) addProjectForm.addEventListener('submit', handleAddProject);
                document.querySelectorAll('.close-add-modal-btn').forEach(btn => btn.addEventListener('click', closeAddModal));
                document.querySelectorAll('.nav-link').forEach(link => link.addEventListener('click', (e) => { const pageId = e.currentTarget.dataset.page; if(pageId) { e.preventDefault(); showPage(pageId); } }));
            }
            
            const renderDashboard = () => {
                if (!currentWorkspaceId) { showPage('company-selection'); return; }
                const workspace = mockData.workspaces[currentWorkspaceId];
                if(dashboardTitle) dashboardTitle.textContent = `${workspace.name} Dashboard`;
                
                const allTimesheetData = mockData.timesheets[currentWorkspaceId] || {};
                let pendingCount = 0;
                let approvedCount = 0;
                let totalHours = 0;
                let recentEntries = [];

                Object.entries(allTimesheetData).forEach(([employeeName, days]) => {
                    Object.entries(days).forEach(([date, dayData]) => {
                        if (dayData.locked) approvedCount++;
                        else if (dayData.punches && dayData.punches.length > 0) pendingCount++;
                        const hours = calculateTotalHoursFromPairs(processDayPunches(employeeName, new Date(date + 'T00:00:00')).pairs)
                        totalHours += hours;
                        if(hours > 0) recentEntries.push({employeeName, date, hours});
                    });
                });
                
                if (dashboardWidgets) {
                    dashboardWidgets.innerHTML = `<div class="card p-6"><h3 class="text-lg font-semibold text-gray-400">Pending Timesheets</h3><p class="text-4xl font-bold text-white mt-2">${pendingCount}</p></div><div class="card p-6"><h3 class="text-lg font-semibold text-gray-400">Approved Timesheets</h3><p class="text-4xl font-bold text-white mt-2">${approvedCount}</p></div><div class="card p-6"><h3 class="text-lg font-semibold text-gray-400">Total Hours This Period</h3><p class="text-4xl font-bold text-white mt-2">${totalHours.toFixed(1)}</p></div>`;
                }
                
                if (timesheetTableBody) {
                    timesheetTableBody.innerHTML = '';
                     recentEntries.sort((a,b) => new Date(b.date) - new Date(a.date)).slice(0, 5).forEach(entry => {
                        const row = document.createElement('tr');
                        row.className = 'border-b border-gray-700';
                        row.innerHTML = `<td class="p-4">${entry.employeeName}</td><td class="p-4">${formatDate(new Date(entry.date + 'T00:00:00'))}</td><td class="p-4">${entry.hours.toFixed(2)}</td>`;
                        timesheetTableBody.appendChild(row);
                    });
                }
                renderCharts();
            };

            const renderCharts = () => {
                const allTimesheets = mockData.timesheets[currentWorkspaceId] || {};
                
                const employeeData = {};
                Object.entries(allTimesheets).forEach(([employeeName, days]) => {
                    employeeData[employeeName] = Object.values(days).reduce((sum, day) => sum + calculateTotalHoursFromPairs(processDayPunches(employeeName, null, day.punches).pairs), 0);
                });

                if (employeeChart) employeeChart.destroy();
                const employeeChartCtx = document.getElementById('employee-chart');
                if(employeeChartCtx) employeeChart = new Chart(employeeChartCtx, { type: 'bar', data: { labels: Object.keys(employeeData), datasets: [{ label: 'Hours Logged', data: Object.values(employeeData), backgroundColor: '#34D399' }] }, options: { responsive: true, scales: { y: { beginAtZero: true, ticks: { color: '#9CA3AF' }, grid: { color: '#374151' } }, x: { ticks: { color: '#9CA3AF' }, grid: { display: false } } }, plugins: { legend: { display: false } } } });
            };

            const renderTimesheetPage = () => {
                if (!currentWorkspaceId) { showPage('company-selection'); return; }
                renderEmployeeFilter();
                renderEmployeeDetails();
                renderSpreadsheet();
            };

            const renderEmployeeFilter = () => {
                if (!timesheetFilterContainer) return;
                const employees = mockData.employees[currentWorkspaceId] || [];
                let options = '';
                employees.forEach(e => {
                    options += `<option value="${e.id}" ${activeEmployeeFilter === e.id ? 'selected' : ''}>${e.name}</option>`;
                });
                
                const existingFilter = document.getElementById('employee-filter');
                if(existingFilter) existingFilter.remove();

                timesheetFilterContainer.insertAdjacentHTML('afterbegin', `<select id="employee-filter" class="form-select w-full md:w-64">${options}</select>`);
                const filterEl = document.getElementById('employee-filter');
                if (filterEl) {
                    filterEl.addEventListener('change', (e) => {
                        activeEmployeeFilter = e.target.value;
                        renderEmployeeDetails();
                        renderSpreadsheet();
                    });
                }
            };

            const renderEmployeeDetails = () => {
                if (!employeeDetailsContainer) return;
                const employee = mockData.employees[currentWorkspaceId].find(e => e.id === activeEmployeeFilter);
                if (!employee) return;

                employeeDetailsContainer.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-x-8 gap-y-2 text-sm">
                        <div><p class="text-2xl font-bold text-emerald-400">${employee.name}</p><p class="text-gray-400">Employee Id: ${employee.id} Status: <span class="text-white">${employee.status}</span></p></div>
                        <div><p><span class="text-gray-400">Hire Date:</span> ${employee.hireDate}</p><p><span class="text-gray-400">Card Number:</span> ${employee.cardNumber || 'N/A'}</p></div>
                        <div><p><span class="text-gray-400">Department:</span> ${employee.department}</p><p><span class="text-gray-400">Supervisor:</span> ${employee.supervisor}</p></div>
                        <div><p><span class="text-gray-400">Pay Type:</span> ${employee.payType}</p><p><span class="text-gray-400">Employee Type:</span> ${employee.employeeType}</p></div>
                    </div>`;
            };
            
            const renderSpreadsheet = () => {
                if (!spreadsheetContainer) return;
                const { week, start: weekStart } = getWeek(currentWeekOffset);
                if(weekRangeDisplay) weekRangeDisplay.textContent = `Monday ${formatDate(week[0], true)} to Sunday ${formatDate(week[6], true)}`;
                
                const employee = mockData.employees[currentWorkspaceId].find(e => e.id === activeEmployeeFilter);
                const weekData = week.map(day => processDayPunches(employee.name, day));
                const maxRows = Math.max(1, ...weekData.map(d => d.pairs.length));
                let dailyTotals = weekData.map(d => d.totalHours);
                let weeklyTotal = dailyTotals.reduce((a, b) => a + b, 0);

                const weekStartDateString = weekStart.toISOString().split('T')[0];
                const isWeekLocked = getWeekVerification(weekStartDateString).isLocked;

                let tableHtml = '<table class="w-full timesheet-table"><thead><tr><th class="row-header w-24">Date</th>';
                week.forEach((day) => {
                    const dateString = day.toISOString().split('T')[0];
                    tableHtml += `<th class="day-header ${isWeekLocked ? 'locked-day' : 'editable'}" data-date="${dateString}" data-locked="${isWeekLocked}">
                                    ${isWeekLocked ? '<span class="text-yellow-400 text-xs">Locked</span><br>' : ''}
                                    ${day.toLocaleDateString('en-US', { weekday: 'short' })} ${day.getDate()}
                                  </th>`;
                });
                tableHtml += '<th class="row-header">Total</th></tr></thead><tbody>';

                for(let i = 0; i < maxRows; i++) {
                    tableHtml += '<tr><td class="row-header">In</td>';
                    weekData.forEach(day => { tableHtml += `<td>${day.pairs[i]?.in || ''}</td>`; });
                    tableHtml += '<td></td></tr>';
                    tableHtml += '<tr><td class="row-header">Out</td>';
                    weekData.forEach(day => { tableHtml += `<td>${day.pairs[i]?.out || ''}</td>`; });
                    tableHtml += '<td></td></tr>';
                }

                tableHtml += '</tbody><tfoot><tr class="bg-gray-800 font-bold"><td class="row-header">Total Hours</td>';
                dailyTotals.forEach(total => { tableHtml += `<td>${total > 0 ? total.toFixed(2) : ''}</td>`; });
                tableHtml += `<td class="text-emerald-400">${weeklyTotal.toFixed(2)}</td></tr>`;
                
                tableHtml += '<tr class="bg-gray-800 font-bold"><td class="row-header" colspan="9">Accumulated Hours</td></tr>';
                tableHtml += `<tr><td class="row-header">Total Paid</td><td colspan="7"></td><td class="text-right pr-4">${weeklyTotal.toFixed(2)}</td></tr>`;
                tableHtml += '<tr><td class="row-header">Total Unpaid</td><td colspan="7"></td><td class="text-right pr-4">0.00</td></tr>';
                tableHtml += `<tr class="bg-gray-800 font-bold"><td class="row-header">Total Hours</td><td colspan="7"></td><td class="text-right pr-4">${weeklyTotal.toFixed(2)}</td></tr>`;

                tableHtml += '<tr class="bg-gray-800 font-bold"><td class="row-header">Pay Codes</td>';
                dailyTotals.forEach(total => { tableHtml += `<td>${total > 0 ? 'REG' : ''}</td>`; });
                tableHtml += '<td></td></tr>';
                tableHtml += '<tr><td class="row-header">REG</td>';
                dailyTotals.forEach(total => { tableHtml += `<td>${total > 0 ? total.toFixed(2) : ''}</td>`; });
                tableHtml += `<td class="text-right pr-4">${weeklyTotal.toFixed(2)}</td></tr>`;

                tableHtml += `<tr class="bg-gray-900 font-bold text-lg"><td class="row-header" colspan="8">Grand Totals</td><td class="text-emerald-400">${weeklyTotal.toFixed(2)}</td></tr>`;

                tableHtml += '</tfoot></table>';
                
                spreadsheetContainer.innerHTML = tableHtml;
                
                const existingVerification = document.getElementById('verification-section');
                if (existingVerification) existingVerification.remove();

                const verificationHtml = `<div id="verification-section" class="mt-8 card p-6"></div>`;
                spreadsheetContainer.insertAdjacentHTML('afterend', verificationHtml);
                
                renderVerificationStatus(weekStartDateString);
                
                document.querySelectorAll('.day-header.editable').forEach(th => th.addEventListener('click', (e) => openPunchModal(e.currentTarget.dataset.date)));
            };

            function getWeekVerification(weekStartDateString) {
                const data = mockData.verification[currentWorkspaceId]?.[activeEmployeeFilter]?.[weekStartDateString] || { employeeVerified: false, supervisorVerified: false };
                data.isLocked = data.employeeVerified && data.supervisorVerified;
                return data;
            }

            function renderVerificationStatus(weekStartDateString) {
                const verificationData = getWeekVerification(weekStartDateString);
                const verificationSection = document.getElementById('verification-section');
                if (!verificationSection) return;

                verificationSection.innerHTML = `
                    <h3 class="text-xl font-bold mb-4">Verification</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="space-y-4">
                            <label class="flex items-center"><input type="checkbox" id="employee-verify-checkbox" class="h-5 w-5 rounded bg-gray-700 border-gray-600 text-emerald-500 focus:ring-emerald-500" ${verificationData.employeeVerified ? 'checked' : ''} ${verificationData.supervisorVerified ? 'disabled' : ''}><span class="ml-3">Employee Verification</span></label>
                            <div id="employee-verify-status" class="text-sm text-gray-400 pl-8"></div>
                        </div>
                        <div class="space-y-4">
                            <label class="flex items-center"><input type="checkbox" id="supervisor-verify-checkbox" class="h-5 w-5 rounded bg-gray-700 border-gray-600 text-emerald-500 focus:ring-emerald-500" ${verificationData.supervisorVerified ? 'checked' : ''} ${!verificationData.employeeVerified ? 'disabled' : ''}><span class="ml-3">Supervisor Verification</span></label>
                            <div id="supervisor-verify-status" class="text-sm text-gray-400 pl-8"></div>
                        </div>
                    </div>`;

                const employeeStatusEl = document.getElementById('employee-verify-status');
                const supervisorStatusEl = document.getElementById('supervisor-verify-status');
                const employee = mockData.employees[currentWorkspaceId].find(e => e.id === activeEmployeeFilter);

                if (verificationData.employeeVerified) {
                    employeeStatusEl.innerHTML = `<p class="flex items-center text-emerald-400"><svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>Verified by ${employee.name} on ${verificationData.employeeVerificationTimestamp}</p>`;
                } else {
                    employeeStatusEl.textContent = 'Pending Employee Verification';
                }

                if (verificationData.supervisorVerified) {
                    supervisorStatusEl.innerHTML = `<p class="flex items-center text-emerald-400"><svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>Verified by ${mockData.user.name} on ${verificationData.supervisorVerificationTimestamp}</p>`;
                } else {
                    supervisorStatusEl.textContent = 'Pending Supervisor Verification';
                }
                
                document.getElementById('employee-verify-checkbox').addEventListener('change', (e) => handleVerification('employee', e.target.checked, weekStartDateString));
                document.getElementById('supervisor-verify-checkbox').addEventListener('change', (e) => handleVerification('supervisor', e.target.checked, weekStartDateString));
            }

            function handleVerification(type, isChecked, weekStartDateString) {
                const verification = mockData.verification[currentWorkspaceId];
                if (!verification[activeEmployeeFilter]) verification[activeEmployeeFilter] = {};
                if (!verification[activeEmployeeFilter][weekStartDateString]) verification[activeEmployeeFilter][weekStartDateString] = {};
                
                const record = verification[activeEmployeeFilter][weekStartDateString];

                if (type === 'employee') {
                    if (record.supervisorVerified) return; // Cannot change if supervisor already verified
                    record.employeeVerified = isChecked;
                    record.employeeVerificationTimestamp = isChecked ? new Date().toLocaleString() : null;
                } else if (type === 'supervisor' && record.employeeVerified) {
                    record.supervisorVerified = isChecked;
                    record.supervisorVerificationTimestamp = isChecked ? new Date().toLocaleString() : null;
                }
                
                renderSpreadsheet();
            }

            function processDayPunches(employeeName, day, punchesOverride = null) {
                const dateString = day ? day.toISOString().split('T')[0] : null;
                const entry = employeeName && dateString ? mockData.timesheets[currentWorkspaceId]?.[employeeName]?.[dateString] : null;
                const punches = punchesOverride || (entry ? entry.punches : []);

                if (punches.length === 0) return { pairs: [], totalHours: 0 };
                const sortedPunches = [...punches].sort((a,b) => a.time.localeCompare(b.time));
                const pairs = [];
                let currentPair = {};
                for (const punch of sortedPunches) {
                    if ((punch.type === 'in' || punch.type === 'lunch-end') && !currentPair.in) { currentPair.in = punch.time; } 
                    else if ((punch.type === 'out' || punch.type === 'lunch-start') && currentPair.in) { currentPair.out = punch.time; pairs.push(currentPair); currentPair = {}; }
                }
                const totalHours = calculateTotalHoursFromPairs(pairs);
                return { pairs, totalHours };
            }
            
            function calculateTotalHoursFromPairs(pairs) {
                let totalMinutes = 0;
                pairs.forEach(pair => {
                    if (pair.in && pair.out) {
                        const [inH, inM] = pair.in.split(':').map(Number);
                        const [outH, outM] = pair.out.split(':').map(Number);
                        totalMinutes += (outH * 60 + outM) - (inH * 60 + inM);
                    }
                });
                return totalMinutes / 60;
            }

            function getWeek(offset = 0) {
                const now = new Date('2025-06-16T12:00:00Z');
                now.setDate(now.getDate() + (offset * 7));
                const dayOfWeek = now.getDay();
                const startDate = new Date(now);
                startDate.setDate(now.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));
                const week = [];
                for (let i = 0; i < 7; i++) { const day = new Date(startDate); day.setDate(startDate.getDate() + i); week.push(day); }
                return { week, start: week[0] };
            }

            function formatDate(date, includeYear = false) {
                const options = { month: 'short', day: 'numeric' };
                if (includeYear) options.year = 'numeric';
                return date.toLocaleDateString('en-US', options);
            }
            
            function punchTypeToLabel(type) {
                const labels = { 'in': 'Clock In', 'out': 'Clock Out', 'lunch-start': 'Start Lunch', 'lunch-end': 'End Lunch' };
                return labels[type] || 'N/A';
            }
            
            function openPunchModal(date) {
                const employee = mockData.employees[currentWorkspaceId].find(e => e.id === activeEmployeeFilter);
                editingDayData = { date, employee: employee.name };
                if(punchModalTitle) punchModalTitle.textContent = `Manage Punches for ${formatDate(new Date(date + 'T00:00:00'))}`;
                renderPunchList();
                if(punchModal) punchModal.style.display = 'flex';
            }
            
            function renderPunchList() {
                if(!punchList || !editingDayData) return;
                const employeeName = editingDayData.employee;
                const entry = mockData.timesheets[currentWorkspaceId]?.[employeeName]?.[editingDayData.date];
                if (!entry || !entry.punches || entry.punches.length === 0) {
                    punchList.innerHTML = '<p class="text-gray-500">No punches for this day.</p>';
                    return;
                }
                punchList.innerHTML = entry.punches.sort((a,b) => a.time.localeCompare(b.time)).map((p, index) => `
                    <div class="flex justify-between items-center bg-gray-800 p-2 rounded">
                        <span><span class="font-semibold">${punchTypeToLabel(p.type)}:</span> ${p.time}</span>
                        <button class="danger-button text-xs p-1 rounded delete-punch-btn" data-index="${index}">&times;</button>
                    </div>
                `).join('');
                document.querySelectorAll('.delete-punch-btn').forEach(btn => btn.addEventListener('click', handleDeletePunch));
            }
            
            function closePunchModal() { if(punchModal) punchModal.style.display = 'none'; editingDayData = null; }
            
            function handleAddPunch(e) {
                e.preventDefault();
                const time = document.getElementById('punch-time').value;
                const type = document.getElementById('punch-type').value;
                if (!time || !type) return;

                const { employee, date } = editingDayData;
                const timesheet = mockData.timesheets[currentWorkspaceId];
                if (!timesheet[employee]) timesheet[employee] = {};
                if (!timesheet[employee][date]) timesheet[employee][date] = { punches: [] };
                
                timesheet[employee][date].punches.push({ time, type });
                renderPunchList();
                renderSpreadsheet();
                e.target.reset();
            }
            
            function handleDeletePunch(e) {
                const index = e.target.dataset.index;
                const { employee, date } = editingDayData;
                mockData.timesheets[currentWorkspaceId][employee][date].punches.splice(index, 1);
                renderPunchList();
                renderSpreadsheet();
            }
            
            function renderManagePage(activeTab = 'employees') {
                if(!manageTabs || !manageContent) return;
                manageTabs.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
                const activeTabEl = manageTabs.querySelector(`[data-tab="${activeTab}"]`);
                if(activeTabEl) activeTabEl.classList.add('active');
                
                if(addNewButton) addNewButton.textContent = `Add New ${activeTab === 'employees' ? 'Employee' : 'Project'}`;

                const items = activeTab === 'employees' ? mockData.employees[currentWorkspaceId] : mockData.projects[currentWorkspaceId];
                
                let listHtml = items.map((item, index) => `
                    <li class="flex justify-between items-center bg-gray-800 p-3 rounded-lg">
                        <div>
                            <span>${typeof item === 'object' ? item.name : item}</span>
                            ${activeTab === 'employees' ? `<span class="ml-2 status-badge ${item.status === 'Active' ? 'status-active' : 'status-inactive'}">${item.status}</span>` : ''}
                        </div>
                        <div class="space-x-2">
                            ${activeTab === 'employees' ? `<button class="secondary-button text-xs px-2 py-1 rounded edit-item-btn" data-index="${index}">Edit</button>` : ''}
                            <button class="danger-button text-xs px-2 py-1 rounded remove-item-btn" data-index="${index}" data-type="${activeTab}">Remove</button>
                        </div>
                    </li>`).join('');

                manageContent.innerHTML = `<div class="card p-6"><ul class="space-y-2">${listHtml}</ul></div>`;
                document.querySelectorAll('.remove-item-btn').forEach(btn => btn.addEventListener('click', handleRemoveItem));
                document.querySelectorAll('.edit-item-btn').forEach(btn => btn.addEventListener('click', handleEditItem));
            };

            function handleAddNew() {
                const activeTab = manageTabs.querySelector('.active').dataset.tab;
                openAddModal(activeTab);
            }

            function openAddModal(type) {
                if (type === 'employees' && addEmployeeModal) {
                    addEmployeeForm.innerHTML = getEmployeeFormHtml();
                    populateDropdowns(addEmployeeForm);
                    addEmployeeModal.style.display = 'flex';
                }
                if (type === 'projects' && addProjectModal) addProjectModal.style.display = 'flex';
            }
            
            function handleEditItem(e) {
                const { index } = e.target.dataset;
                editingEmployeeIndex = index;
                const employee = mockData.employees[currentWorkspaceId][index];
                editEmployeeForm.innerHTML = getEmployeeFormHtml(employee);
                populateDropdowns(editEmployeeForm, employee);
                editEmployeeModal.style.display = 'flex';
            }

            function getEmployeeFormHtml(employee = {}) {
                return `
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div><label class="block text-gray-300 mb-2">First Name</label><input type="text" name="firstName" class="w-full p-3 form-input" required value="${employee.firstName || ''}"></div>
                        <div><label class="block text-gray-300 mb-2">Middle Name</label><input type="text" name="middleName" class="w-full p-3 form-input" value="${employee.middleName || ''}"></div>
                        <div><label class="block text-gray-300 mb-2">Last Name</label><input type="text" name="lastName" class="w-full p-3 form-input" required value="${employee.lastName || ''}"></div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label class="block text-gray-300 mb-2">Employee ID</label><input type="text" name="id" class="w-full p-3 form-input" required value="${employee.id || ''}"></div>
                        <div><label class="block text-gray-300 mb-2">Card Number</label><input type="text" name="cardNumber" class="w-full p-3 form-input" value="${employee.cardNumber || ''}"></div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label class="block text-gray-300 mb-2">Hire Date</label><input type="date" name="hireDate" class="w-full p-3 form-input" required value="${employee.hireDate || ''}"></div>
                        <div><label class="block text-gray-300 mb-2">Supervisor</label><select name="supervisor" class="w-full p-3 form-select"></select></div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div><label class="block text-gray-300 mb-2">Department</label><select name="department" class="w-full p-3 form-select"></select></div>
                        <div><label class="block text-gray-300 mb-2">Pay Type</label><select name="payType" class="w-full p-3 form-select"></select></div>
                        <div><label class="block text-gray-300 mb-2">Employee Type</label><select name="employeeType" class="w-full p-3 form-select"></select></div>
                    </div>
                    ${employee.id ? `<div class="grid grid-cols-1 md:grid-cols-3 gap-4"><div><label class="block text-gray-300 mb-2">Status</label><select name="status" class="w-full p-3 form-select"><option value="Active">Active</option><option value="Inactive">Inactive</option></select></div></div>` : ''}
                    <div class="flex justify-end gap-4 pt-4"><button type="button" class="secondary-button px-6 py-2 rounded-lg close-add-modal-btn">Cancel</button><button type="submit" class="cta-button px-6 py-2 rounded-lg">${employee.id ? 'Save Changes' : 'Add Employee'}</button></div>
                `;
            }

            function populateDropdowns(formElement, employee = {}) {
                populateDropdown(formElement.querySelector('select[name="department"]'), mockData.workspaces[currentWorkspaceId].departments, 'Add New Department...', employee.department);
                populateDropdown(formElement.querySelector('select[name="employeeType"]'), mockData.workspaces[currentWorkspaceId].employeeTypes, 'Add Custom Type...', employee.employeeType);
                populateDropdown(formElement.querySelector('select[name="payType"]'), mockData.workspaces[currentWorkspaceId].payTypes, 'Add Custom Type...', employee.payType);
                populateDropdown(formElement.querySelector('select[name="supervisor"]'), mockData.employees[currentWorkspaceId].map(e => e.name), null, employee.supervisor);
                if(employee.status) formElement.querySelector('select[name="status"]').value = employee.status;
            }

            function populateDropdown(select, optionsArray, addOptionText = null, selectedValue = null) {
                if (!select) return;
                select.innerHTML = optionsArray.map(opt => `<option value="${opt}" ${selectedValue === opt ? 'selected' : ''}>${opt}</option>`).join('');
                if (addOptionText) {
                    select.innerHTML += `<option value="add_new">${addOptionText}</option>`;
                    select.addEventListener('change', (e) => handleDropdownAdd(e, select, optionsArray, addOptionText));
                }
            }

            function handleDropdownAdd(event, select, optionsArray, addOptionText) {
                if (event.target.value === 'add_new') {
                    const newValue = prompt(`Enter new value for "${addOptionText.replace('Add New ', '').replace('...', '')}":`);
                    if (newValue && !optionsArray.includes(newValue)) {
                        optionsArray.push(newValue);
                        populateDropdown(select, optionsArray, addOptionText, newValue);
                        event.target.value = newValue;
                    } else {
                        event.target.selectedIndex = 0;
                    }
                }
            }

            function closeAddModal() {
                if(addEmployeeModal) addEmployeeModal.style.display = 'none';
                if(editEmployeeModal) editEmployeeModal.style.display = 'none';
                if(addProjectModal) addProjectModal.style.display = 'none';
            }

            function handleAddEmployee(e) {
                e.preventDefault();
                const form = e.target;
                const newEmployee = {
                    id: form.id.value,
                    name: `${form.firstName.value} ${form.lastName.value}`,
                    firstName: form.firstName.value,
                    lastName: form.lastName.value,
                    hireDate: form.hireDate.value,
                    department: form.department.value,
                    payType: form.payType.value,
                    employeeType: form.employeeType.value,
                    supervisor: form.supervisor.value,
                    cardNumber: form.cardNumber.value,
                    status: 'Active'
                };
                mockData.employees[currentWorkspaceId].push(newEmployee);
                closeAddModal();
                renderManagePage('employees');
            }

            function handleEditEmployee(e) {
                e.preventDefault();
                const form = e.target;
                const updatedEmployee = {
                    id: form.id.value,
                    firstName: form.firstName.value,
                    middleName: form.middleName.value,
                    lastName: form.lastName.value,
                    name: `${form.firstName.value} ${form.lastName.value}`,
                    hireDate: form.hireDate.value,
                    department: form.department.value,
                    payType: form.payType.value,
                    employeeType: form.employeeType.value,
                    supervisor: form.supervisor.value,
                    cardNumber: form.cardNumber.value,
                    status: form.status.value
                };
                mockData.employees[currentWorkspaceId][editingEmployeeIndex] = updatedEmployee;
                closeAddModal();
                renderManagePage('employees');
            }

            function handleAddProject(e) {
                e.preventDefault();
                const newProject = document.getElementById('new-project-name').value;
                mockData.projects[currentWorkspaceId].push(newProject);
                closeAddModal();
                renderManagePage('projects');
            }

            function handleRemoveItem(e) {
                const { index, type } = e.target.dataset;
                if (confirm(`Are you sure you want to remove this ${type.slice(0, -1)}?`)) {
                    mockData[type][currentWorkspaceId].splice(index, 1);
                    renderManagePage(type);
                }
            }

            function renderSettingsPage() {
                if(!settingsContent || !currentWorkspaceId) return;
                const workspace = mockData.workspaces[currentWorkspaceId];
                const user = mockData.user;
                document.getElementById('profile-name').value = user.name;
                document.getElementById('profile-email').value = user.email;
                settingsContent.innerHTML = `<p class="text-gray-400"><span class="font-semibold text-white">Current Workspace:</span> ${workspace.name}</p><p class="text-gray-400"><span class="font-semibold text-white">Current Plan:</span> ${workspace.plan}</p><button class="mt-4 secondary-button px-6 py-2 rounded-lg">Upgrade Plan</button>`;
            }
            
            function renderWorkspaceSelection() {
                if(!workspaceListContainer) return;
                workspaceListContainer.innerHTML = '';
                Object.entries(mockData.workspaces).forEach(([id, ws]) => {
                    const card = document.createElement('div');
                    card.className = 'card workspace-card p-8 text-center hover:border-emerald-400';
                    card.innerHTML = `<h3 class="text-2xl font-bold text-white">${ws.name}</h3><p class="text-gray-400 mt-2">${ws.plan} Plan</p>`;
                    card.addEventListener('click', () => { currentWorkspaceId = id; activeEmployeeFilter = mockData.employees[id][0].id; showPage('dashboard'); });
                    workspaceListContainer.appendChild(card);
                });
            }

            // ... (All other functions remain the same)

            setupEventListeners();
            showPage('login');
            updateNav();
        });
    </script>
</body>
</html>
