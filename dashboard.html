<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - NexusTime</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #111827; color: #E5E7EB; }
        .card { background-color: #1F2937; border: 1px solid #374151; }
        .header { background-color: rgba(17, 24, 39, 0.8); backdrop-filter: blur(10px); }
        .nav-link.active { color: #34D399; font-weight: 600; }
        .secondary-button { background-color: transparent; border: 1px solid #34D399; color: #34D399; transition: all 0.3s ease; }
    </style>
</head>
<body class="bg-gray-900 text-white">
    <header class="bg-gray-900 shadow p-4 sticky top-0 z-30">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <a href="dashboard.html"><img src="https://raw.githubusercontent.com/Harveyp1/nexustime/main/nexustimelogo.png" alt="NexusTime Logo" class="h-10"></a>
            <nav>
                <ul class="flex gap-6 text-gray-300 text-sm font-medium">
                    <li><a href="dashboard.html" class="nav-link active">Dashboard</a></li>
                    <li><a href="timesheet.html" class="nav-link hover:text-white">Timesheets</a></li>
                    <li><a href="manage.html" class="nav-link hover:text-white">Manage</a></li>
                    <li><a href="settings.html" class="nav-link hover:text-white">Settings</a></li>
                    <li><a href="workspaces.html" class="nav-link hover:text-white">Switch Workspace</a></li>
                </ul>
            </nav>
            <button id="logout-button" class="border border-emerald-400 text-emerald-400 px-4 py-1 rounded hover:bg-emerald-500 hover:text-white">Log Out</button>
        </div>
    </header>

    <main>
        <section id="dashboard" class="max-w-7xl mx-auto mt-10 p-4">
            <div class="flex flex-col md:flex-row justify-between md:items-center mb-8 gap-4">
                <h2 id="dashboard-title" class="text-3xl font-bold text-white"></h2>
            </div>
            <div id="dashboard-widgets" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8"></div>
            <div class="grid grid-cols-1 lg:grid-cols-5 gap-6 mt-8">
                <div class="lg:col-span-2 card p-6 rounded-lg"><h3 class="text-xl font-semibold text-white mb-4">Hours by Project</h3><canvas id="project-chart"></canvas></div>
                <div class="lg:col-span-3 card p-6 rounded-lg"><h3 class="text-xl font-semibold text-white mb-4">Hours by Employee</h3><canvas id="employee-chart"></canvas></div>
            </div>
            <div class="card p-0 overflow-hidden mt-8 rounded-lg">
                <div class="p-6 flex justify-between items-center"><h3 class="text-xl font-semibold text-white">Recent Timesheet Entries</h3><a href="timesheet.html" class="secondary-button px-4 py-2 rounded-lg text-sm">View Full Timesheet</a></div>
                <div class="overflow-x-auto"><table class="w-full text-left"><thead class="bg-gray-800"><tr><th class="p-4 font-semibold">Employee</th><th class="p-4 font-semibold">Date</th><th class="p-4 font-semibold">Hours</th></tr></thead><tbody id="timesheet-table-body"></tbody></table></div>
            </div>
        </section>
    </main>

    <script type="module">
        import { mockData, stateManager, calculateTotalHoursFromPairs, processDayPunches, formatDate } from 'https://raw.githubusercontent.com/Harveyp1/nexustime/main/common.js';

        document.addEventListener('DOMContentLoaded', () => {
            stateManager.checkAuth();
            stateManager.checkWorkspace();

            const dashboardTitle = document.getElementById('dashboard-title');
            const dashboardWidgets = document.getElementById('dashboard-widgets');
            const timesheetTableBody = document.getElementById('timesheet-table-body');
            const logoutButton = document.getElementById('logout-button');
            let projectChart = null;
            let employeeChart = null;

            function renderDashboard() {
                const currentWorkspaceId = stateManager.getCurrentWorkspace();
                if (!currentWorkspaceId) return;

                const workspace = mockData.workspaces[currentWorkspaceId];
                if(dashboardTitle) dashboardTitle.textContent = `${workspace.name} Dashboard`;
                
                const allTimesheetData = mockData.timesheets[currentWorkspaceId] || {};
                let pendingCount = 0;
                let approvedCount = 0;
                let totalHours = 0;
                let recentEntries = [];

                Object.entries(allTimesheetData).forEach(([employeeName, days]) => {
                    Object.entries(days).forEach(([date, dayData]) => {
                        const isLocked = mockData.verification[currentWorkspaceId]?.[mockData.employees[currentWorkspaceId].find(e=>e.name === employeeName)?.id]?.[getWeek(0, new Date(date)).start.toISOString().split('T')[0]]?.isLocked;
                        if (isLocked) approvedCount++;
                        else if (dayData.punches && dayData.punches.length > 0) pendingCount++;
                        
                        const hours = calculateTotalHoursFromPairs(processDayPunches(employeeName, new Date(date + 'T00:00:00')).pairs);
                        totalHours += hours;
                        if(hours > 0) recentEntries.push({employeeName, date, hours});
                    });
                });
                
                if (dashboardWidgets) {
                    dashboardWidgets.innerHTML = `<div class="card p-6 rounded-lg"><h3 class="text-lg font-semibold text-gray-400">Pending Timesheets</h3><p class="text-4xl font-bold text-white mt-2">${pendingCount}</p></div><div class="card p-6 rounded-lg"><h3 class="text-lg font-semibold text-gray-400">Approved Timesheets</h3><p class="text-4xl font-bold text-white mt-2">${approvedCount}</p></div><div class="card p-6 rounded-lg"><h3 class="text-lg font-semibold text-gray-400">Total Hours This Period</h3><p class="text-4xl font-bold text-white mt-2">${totalHours.toFixed(1)}</p></div>`;
                }
                
                if (timesheetTableBody) {
                    timesheetTableBody.innerHTML = '';
                     recentEntries.sort((a,b) => new Date(b.date) - new Date(a.date)).slice(0, 5).forEach(entry => {
                        const row = document.createElement('tr');
                        row.className = 'border-b border-gray-700';
                        row.innerHTML = `<td class="p-4">${entry.employeeName}</td><td class="p-4">${formatDate(new Date(entry.date + 'T00:00:00'))}</td><td class="p-4">${entry.hours.toFixed(2)}</td>`;
                        timesheetTableBody.appendChild(row);
                    });
                }
                renderCharts(allTimesheetData);
            };

            function renderCharts(allTimesheets) {
                const employeeData = {};
                Object.entries(allTimesheets).forEach(([employeeName, days]) => {
                    employeeData[employeeName] = Object.values(days).reduce((sum, day) => {
                        const dayPunches = processDayPunches(employeeName, new Date(Object.keys(days)[0])); // Simplified for chart
                        return sum + calculateTotalHoursFromPairs(dayPunches.pairs);
                    }, 0);
                });

                if (employeeChart) employeeChart.destroy();
                const employeeChartCtx = document.getElementById('employee-chart');
                if(employeeChartCtx) employeeChart = new Chart(employeeChartCtx, { type: 'bar', data: { labels: Object.keys(employeeData), datasets: [{ label: 'Hours Logged', data: Object.values(employeeData), backgroundColor: '#34D399' }] }, options: { responsive: true, scales: { y: { beginAtZero: true, ticks: { color: '#9CA3AF' }, grid: { color: '#374151' } }, x: { ticks: { color: '#9CA3AF' }, grid: { display: false } } }, plugins: { legend: { display: false } } } });
            };

            if (logoutButton) logoutButton.addEventListener('click', stateManager.logout);

            renderDashboard();
        });
    </script>
</body>
</html>
