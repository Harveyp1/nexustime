<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCKy_SqRUTKkoeuTzrksN2_TQ41v8Zs9Ls",
      authDomain: "nexustime-e8b91.firebaseapp.com",
      projectId: "nexustime-e8b91",
      storageBucket: "nexustime-e8b91.appspot.com",
      messagingSenderId: "516976739338",
      appId: "1:516976739338:web:537ae732707a2a1aab4bf3"
    };
    firebase.initializeApp(firebaseConfig);
  </script>
</head>
<body class="bg-gray-950 text-white min-h-screen">
  <!-- Top Navigation Menu -->
  <nav class="bg-gray-900 border-b border-gray-800 px-6 py-4 flex justify-between items-center">
    <div class="text-xl font-bold">NexusTime</div>
    <ul class="flex space-x-6">
      <li><a href="/dashboard.html" class="hover:text-green-400">Dashboard</a></li>
      <li><a href="/schedule.html" class="hover:text-green-400">Schedule</a></li>
      <li><a href="/timesheet.html" class="hover:text-green-400">Timesheet</a></li>
      <li><a href="/manage.html" class="hover:text-green-400">Manage</a></li>
      <li><a href="/settings.html" class="hover:text-green-400">Settings</a></li>
      <li><a href="/switch-workspace.html" class="hover:text-green-400">Switch Workspace</a></li>
    </ul>
  </nav>

  <div class="p-6 space-y-10" id="dashboardContent">Loading...</div>

  <script>
    async function loadDashboard() {
      const user = firebase.auth().currentUser;
      if (!user) return;

      const db = firebase.firestore();
      const userDoc = await db.collection("users").doc(user.uid).get();
      if (!userDoc.exists || !userDoc.data().activeWorkspaceId) {
        window.location.href = "/switch-workspace.html";
        return;
      }

      const workspaceId = userDoc.data().activeWorkspaceId;
      const workspaceRef = db.collection("workspaces").doc(workspaceId);
      const workspaceDoc = await workspaceRef.get();
      const workspaceData = workspaceDoc.data();

      const employeeSnap = await workspaceRef.collection("employees").get();
      const timesheetSnap = await workspaceRef.collection("timesheets").get();
      const timeoffSnap = await workspaceRef.collection("timeoffRequests").orderBy("createdAt", "desc").limit(5).get();

      const employeeCount = employeeSnap.size;
      const totalHours = timesheetSnap.docs.reduce((sum, doc) => sum + (doc.data().hours || 0), 0);
      const pending = timesheetSnap.docs.filter(doc => doc.data().status === "pending").length;
      const approved = timesheetSnap.docs.filter(doc => doc.data().status === "approved").length;

      const recentActivities = timesheetSnap.docs
        .sort((a, b) => (b.data().updatedAt?.seconds || 0) - (a.data().updatedAt?.seconds || 0))
        .slice(0, 5)
        .map(doc => doc.data());

      const activityHTML = recentActivities.map(item => `
        <div class="bg-gray-900 p-4 rounded-lg">
          <p><strong>${item.employeeName || 'Employee'}</strong> logged ${item.hours} hrs</p>
          <p class="text-gray-400 text-sm">Status: ${item.status || 'N/A'}</p>
        </div>
      `).join("");

      const timeoffHTML = timeoffSnap.docs.map(doc => {
        const data = doc.data();
        return `
          <div class="bg-gray-900 p-4 rounded-lg">
            <p><strong>${data.employeeName || 'Employee'}</strong> requested time off</p>
            <p class="text-gray-400 text-sm">${data.startDate} to ${data.endDate}</p>
            <p class="text-gray-400 text-sm">Reason: ${data.reason || 'N/A'}</p>
          </div>
        `;
      }).join("");

      document.getElementById("dashboardContent").innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
          <div class="bg-gray-900 p-4 rounded-lg">
            <h2 class="text-xl font-semibold">Employees</h2>
            <p class="text-3xl mt-2">${employeeCount}</p>
          </div>
          <div class="bg-gray-900 p-4 rounded-lg">
            <h2 class="text-xl font-semibold">Total Hours</h2>
            <p class="text-3xl mt-2">${totalHours}</p>
          </div>
          <div class="bg-gray-900 p-4 rounded-lg">
            <h2 class="text-xl font-semibold">Pending Timesheets</h2>
            <p class="text-3xl mt-2">${pending}</p>
          </div>
          <div class="bg-gray-900 p-4 rounded-lg">
            <h2 class="text-xl font-semibold">Approved Timesheets</h2>
            <p class="text-3xl mt-2">${approved}</p>
          </div>
        </div>

        <div>
          <h2 class="text-2xl font-bold mt-10 mb-4">Recent Activity</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            ${activityHTML || '<p class="text-gray-400">No recent activity.</p>'}
          </div>
        </div>

        <div>
          <h2 class="text-2xl font-bold mt-10 mb-4">Recent Time Off Requests</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            ${timeoffHTML || '<p class="text-gray-400">No recent time off requests.</p>'}
          </div>
        </div>
      `;
    }

    firebase.auth().onAuthStateChanged(user => {
      if (user) loadDashboard();
    });
  </script>
</body>
</html>
