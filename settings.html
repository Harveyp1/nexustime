<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Settings - NexusTime</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js';
    import { getFirestore, doc, getDoc } from 'https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyCKy_SqRUTKkoeuTzrksN2_TQ41v8Zs9Ls",
      authDomain: "nexustime-e8b91.firebaseapp.com",
      projectId: "nexustime-e8b91",
      storageBucket: "nexustime-e8b91.appspot.com",
      messagingSenderId: "516976739338",
      appId: "1:516976739338:web:537ae732707a2a1aab4bf3",
      measurementId: "G-QRSD6TYH86"
    };

    console.log("Debug: Initializing Firebase with config:", firebaseConfig);
    const app = initializeApp(firebaseConfig);
    const auth = getAuth();
    const db = getFirestore(app);

    onAuthStateChanged(auth, async (user) => {
      console.log("Debug: onAuthStateChanged fired, user=", user);
      if (user) {
        const uid = user.uid;
        console.log("Debug: User UID:", uid);

        let workspaceId = localStorage.getItem("activeWorkspace");
        if (!workspaceId) {
          try {
            const userDoc = await getDoc(doc(db, "users", uid));
            if (userDoc.exists()) {
              const data = userDoc.data();
              workspaceId = data.activeWorkspace;
              if (workspaceId) {
                localStorage.setItem("activeWorkspace", workspaceId);
                console.log("Debug: WorkspaceId recovered from Firestore and set:", workspaceId);
              } else {
                console.warn("Debug: No workspaceId found in user doc. Redirecting to workspace switch.");
                window.location.href = "switch-workspace.html";
              }
            } else {
              console.warn("Debug: No user document found. Redirecting to workspace switch.");
              window.location.href = "switch-workspace.html";
            }
          } catch (err) {
            console.error("Debug: Error fetching user doc:", err);
            window.location.href = "switch-workspace.html";
          }
        } else {
          console.log("Debug: Retrieved workspaceId from localStorage:", workspaceId);
        }

        if (workspaceId) {
          try {
            const workspaceRef = doc(db, "workspaces", workspaceId);
            const workspaceSnap = await getDoc(workspaceRef);

            if (workspaceSnap.exists()) {
              console.log("Debug: Workspace data:", workspaceSnap.data());
            } else {
              console.error("Debug: Workspace not found in Firestore.");
            }
          } catch (err) {
            console.error("Debug: Error fetching workspace doc:", err);
          }
        }
      } else {
        console.warn("Debug: No user is signed in. Redirecting to login.");
        window.location.href = "app.html";
      }
    });

    window.setWorkspaceManually = () => {
      const manualId = prompt("Enter a Workspace ID to manually set in localStorage:");
      if (manualId) {
        localStorage.setItem("activeWorkspace", manualId);
        alert("Workspace ID set to: " + manualId + "\nReloading page.");
        window.location.reload();
      }
    };
  </script>
</head>
<body class="bg-gray-900 text-white font-inter min-h-screen flex flex-col">
  <header class="bg-gray-800 p-4 flex items-center justify-between">
    <img src="https://github.com/Harveyp1/nexustime/blob/main/nexustimelogo.png?raw=true" alt="NexusTime Logo" class="h-10" />
    <nav class="space-x-6">
      <a href="dashboard.html" class="hover:text-emerald-400">Dashboard</a>
      <a href="timesheet.html" class="hover:text-emerald-400">Timesheet</a>
      <a href="schedule.html" class="hover:text-emerald-400">Schedule</a>
      <a href="switch-workspace.html" class="hover:text-emerald-400">Switch Workspace</a>
      <a href="app.html" class="hover:text-emerald-400">Logout</a>
    </nav>
  </header>
  <main class="flex-1 p-8 overflow-auto">
    <h1 class="text-2xl font-bold mb-6">Settings Debug</h1>
    <button onclick="setWorkspaceManually()" class="mb-4 px-4 py-2 bg-emerald-600 hover:bg-emerald-700 rounded">Manually Set Workspace</button>
    <pre id="debugLog" class="bg-gray-800 p-4 rounded text-green-400 text-sm overflow-x-auto"></pre>
  </main>
  <script>
    const originalConsoleLog = console.log;
    const debugOutput = document.getElementById('debugLog');
    console.log = function (...args) {
      args.forEach(arg => {
        debugOutput.innerText += typeof arg === 'object' ? JSON.stringify(arg, null, 2) + '\n' : arg + '\n';
      });
      originalConsoleLog.apply(console, args);
    };
  </script>
</body>
</html>
